'This library will be used to hold common user functions
'AUTHOR: Chris Love
'DATE: 01/21/2015
'@(#) lib_COMMON - Common Functions 05.06 01/21/2015
%version 05.06 01/21/2015
'******************************** CHANGELOG*******************************************
'06-14-2004 1.0 Initial version
'11-07-2005 1.1 Added funcion confirm_note to prompt staff whether they're entering
'               a note for the correct client.
'12-01-2005 1.2 Added the changetitle function.
'03-20-2006 1.3 Added the Irms Viewer function that will pull a clients snapshots for a particular category
'03-24-2006 1.4 Added DLA_SA function to check DX Axis I all levels to see if they were SA
'05-31-2006 1.5 Added the PadString function developed for Sue's flow script
'06-16-2006 1.6 Added the at_add fucntion, to send MIS jobs to the at scheduler 
'12-19-2006 1.7 Added TimeDiff function to calc the difference between dates in days,hours and minutes
'01-08-2007 1.8 Added BUIUserIP to return a bui user ip, it my not be 100% all the time but easy
'04-23-2007 1.9 Added ConfirmExit
'05-21-2007 2.0 Added MaxDisplay and MinDisplay
'06-06-2007 2.1 Added TCOOMMIYN, returns Y if client has a elig record with 60 as the FS
'05-05-2008 2.2 Added UserLocation to find physical location of user
'05-21-2008 2.3 Added CheckStaffRU to check if the staff are in an allowed RU, returns 0 if yes and 1 otherwise
'07-10-2008 2.4 Added Function to check medicare status similar to medicaid status check
'07-22-2008 2.5 Changed DLA_SA to use $find instead of a do while loop to test the DX levels
'08-13-2008 2.6 Added function DisplayFile
'09-08-2008 2.7 Changed UserLocation so it uses parsem instead of $seg, also converts the octets to numeric
'11-13-2008 2.8 Added a confirm_client function to be used for assessments
'04-02-2009 2.9 Added a function to check of the user on one of the terminal servers. Also a function to prompt for the person's location and return it
'06-23-2009 3.0 Expanded information in confirm_client
'07-06-2009 3.1 Added Select RU that is used by the NOSHOWCANCEL script and any future scripts
'07-08-2009 3.2 Added functions to create ordered,unordered and definition lists from arrays
'07-27-2009 3.3 Added LiveClock function, to be used in notes, etc
'08-05-2009 3.4 Added ClientRequest function that can will be used for adding "Client Copy" and other text to printed forms
'08-06-2009 3.5 Added Client and Staff status functions for printing a centered "Active Client" or "Active Staff" based on $regid
'08-14-2009 3.6 Added generic ConfirmValue function
'08-20-2009 3.7 Added function StfCredentials() that returns various credential leves, signature line, etc 
'               Added CheckSigLineDCT(SigLineDCT) that is used in several other scripts
'08-21-2009 3.71 Added the TP credential to  StfCredentials() to be used with the new treatment plan credential level
'08-27-2009 3.8 Added Werner Hoellerbaur's IsNumeric() function 
'09-14-2009 3.9 Merged changes between production and test versions, added function FY(date)
'09-29-2009 3.91 Added CurrentMonth(), PreviousMonth(), NextMonth() and LeapYearYN functions. Seem useless but they come up sometimes, meh
'12-01-2009 3.92 ConfirmTime(), try to stop people from entereing the wrong time from midnight to 7am
'12-04-2009 3.93 ClientLastUA(Client,date, ua_date, ua_type, ua_locr, ua_loca, clientage as of <-date)
'                Pass a client id and an optional date returns info about the clients last assessment
'                ClientAge and StaffAge functions now accept a date that can be used to caclulate age as of, otherwise default to $today
'12-14-2009 3.94 HFC and PV lib_COMMON sync
'12-17-2009 3.95 ClientLastUA updated to include SP8 of 365 days
'01-12-2010 3.96 User_Location_Ck to see if the staff attendance needs to be updated first
'01-22-2010 3.97 PageHeader to print generic client information on top of page, copied from other scripts
'06-28-2010 3.98 Added functions : setStaffName(), setClientName(), activeCPC(), staffLocation(), locationList(), and filterByLoc(),
'				  getMngr(), getEmail()
'08-23-2010 3.99 added function rInactiveCPC()
'09-30-2010 4.00 Change ClientAge and StaffAge to be more accurate
'01-27-2011 4.01 Cleanup and added ActiveStaff(), InactiveStaff(),ActiveClients(),InactiveClients(),ActiveMeds()
'01-31-2011 4.02 Added MEDNECANNUAL() to see if the next UA needs to be completed by an LPHA or QMHP
'02-07-2011 4.03 updated getMngr	
'03-31-2011 4.04 Added more lines to AnnoyConfirm and some code to always trigger it for DAYHABGRP1 & 2 scripts.
'                Moved the MOTD function from MENU_SCR1 to lib_COMMON
'07-11-2011 4.05 Added the function PngFix, I doubt it will be used again but it was an old function in NOTEDISPLAY to fix the transparency of the png icons.
'07-12-2011 4.06 added GetCounty and GetFiles from AVAILNOTES
'08-08-2011 4.07 Added GetISNID, to be used with note correction/void process
'09-30-2011 4.08 Added GetDate, generic get a date form. used with MEDCHECK_SPC to prompt for the original date of the med check. strebeck
'10-03-2011 4.09 Added UMStaff and MISStaff, returns Y/N
'11-04-2011 4.10 Added a version of libDialogs MsgBox from Jim Songer for custom full screen error messages
'11-17-2011 4.11 Change ClientAge and StaffAge to be more accurate, moved StaffBD and message function to lib_COMMON for reuse, added version of staff_login
'11-29-2011 4.12 Added IsMounted, getfsspace doesnt work, probably a path problem for the mount command, at some point I missed documenting mkdir. also added MountFS
'12-05-2011 4.13 CheckPID, 0/1/96/97/98/99 Returns 1 if process is is still running, 0 if not, 99 for pid not passed, 96 for $unix error 1, 97 for $unix error 2, 98 for $unix error 3
'01-05-2012 4.14 Copied GETSVC from lib_MEDICAL so a different version can be used to grab the last 5/15 services. Changes to Prn5SerFS()
'01-09-2012 4.15 Flipped the position of Prn5SerFS() and Prn5Pe(), the last 15 and next 5 appointment fieldsets, removed PrnPEFS() that was never used or complete
'01-13-2012 4.16 Moved check_medicaid from it's library to here, it's library will now be a simple pointer to here
'01-27-2012 4.17 Function CountOccurance(values_to_find[],possible_values[], results[]) is n
'02-08-2012 4.18 Small cleanup, removal of useless return codes, etc. Switched to using the includes inc_C_EL, inc_ER, inc_ISN, inc_INSURANCE, inc_DX where possible. Problem:2000 variable limit
'                Removed at_add, timediff and timediff2 functions, copy saved in lib_COMMON_02082012
'02-10-2012 4.19 Added UpdateInjections and PrintInjections to be used with the progress note scripts
'04-16-2012 4.20 Added inc_C_AD_REC and it's dstlist for the address record
'08-14-2012 4.21 Added Financial Review letter process, commented out confirm_info for space
'08-19-2013 5.00 For functions dealing with the RDM UAs, adding the ANSA/CANS dsts. As the script has grown larger, beginning to move functions to lib_COMMON2 and adding calls to it
'11-05-2013 5.02 CaseManagers, returns c.2cm and c.cm in an array
'03-12-2014 5.03 Added GetStaffByPos() function call to lib_COMMON2
'04-21-2014 5.04 Added Abilify Maintena to the UpdateInjections function
'05-07-2014 5.05 Move some functions from lib_MEDICAL to lib_COMMON/lib_COMMON2
'07-17-2014 5.06 Added UnMount
library lib_COMMON()

'*************************************CONFIRM CANCEL FORM************************************
'IF THE USER PRESSES THE CANCEL BUTTON AT ANY TIME, THIS CONFIRMATION FORM IS SHOWN WHERE   *
'IF THE USER SELECTS YES, THE SECTION OF THE SCRIPT WILL TERMINATE EXECUTION, IF THE USER   *
'SELECTS NO, FORM IS SHOWN AGAIN AND THE SECTION RESUMES EXECUTION.                         *
'********************************************************************************************
function confirm(continue) is null
 continue is x
 yes_btn  is x
 no_btn   is x
 $allowupdate(continue)
 $submitopt("off", "YES")
 $cancelopt("off", "NO")
 $form("confirm")  
  $bstyle("buttondown","button")
  $br(4)$text("{H1 align='CENTER'}ARE YOU SURE{/H1}")
  $text("{CENTER}If you cancel now, {u}{b}{font color=red}NONE OF THE DATA{/font}{/b}{/u} will be saved!{/CENTER}",,"font-family:times new roman; font-size:14pt; color:black; font-weight:bold;")
  $text("{CENTER}Do you wish to cancel and return to Main Menu?{/CENTER}",,"font-family:times new roman; font-size:14pt; color:darkblue; font-weight:bold;")
  $br(2)
  $tag("<center>")
  $submit(yes_btn,"YES")$ctag("&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;")$submit(no_btn,"NO")
  $tag("</center>")
 $sendform("confirm")
 if $endbutton = "SUBMIT" or yes_btn = "Y" then
   continue = "N"
 endif  
end confirm

'*************************************CONFIRM CANCEL FORM************************************
'IF THE USER PRESSES THE CANCEL BUTTON AT ANY TIME, THIS CONFIRMATION FORM IS SHOWN WHERE   *
'IF THE USER SELECTS YES, THE SECTION OF THE SCRIPT WILL TERMINATE EXECUTION, IF THE USER   *
'SELECTS NO, FORM IS SHOWN AGAIN AND THE SECTION RESUMES EXECUTION.                         *
'********************************************************************************************
function confirm_report(continue) is null
 continue is x
 yes_btn  is x
 no_btn   is x
 $allowupdate(continue)
 $submitopt("off", "YES")
 $cancelopt("off", "NO")
 $form("confirm")  
  $bstyle("buttondown","button")
  $br(4)$text("{H1 align='CENTER'}ARE YOU SURE{/H1}")
  $text("{CENTER}If you cancel now, {u}{b}{font color=red}A REPORT WILL NOT BE CREATED!{/font}{/b}{/u}{/CENTER}",,"font-family:times new roman; font-size:14pt; color:black; font-weight:bold;")
  $text("{CENTER}Do you wish to cancel and return to Main Menu?{/CENTER}",,"font-family:times new roman; font-size:14pt; color:darkblue; font-weight:bold;")
  $br(2)
  $tag("<center>")
  $submit(yes_btn,"YES")$ctag("&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;")$submit(no_btn,"NO")
  $tag("</center>")
 $sendform("confirm")
 if $endbutton = "SUBMIT" or yes_btn = "Y" then
   continue = "N"
 endif  
end confirm_report

'*************************************CONFIRM CANCEL FORM************************************
'IF THE USER PRESSES THE CANCEL BUTTON AT ANY TIME, THIS CONFIRMATION FORM IS SHOWN WHERE   *
'IF THE USER SELECTS YES, THE SECTION OF THE SCRIPT WILL TERMINATE EXECUTION, IF THE USER   *
'SELECTS NO, FORM IS SHOWN AGAIN AND THE SECTION RESUMES EXECUTION.                         *
'********************************************************************************************
function confirm_edit(continue) is null
 continue is x
 yes_btn  is x
 no_btn   is x
 $allowupdate(continue)
 $submitopt("off", "YES")
 $cancelopt("off", "NO")
 $form("confirm")
  $bstyle("buttondown","button")  
  $text("{H1 align='CENTER'}ARE YOU SURE{/H1}")
  $text("{CENTER}If you made changes and cancel now, NONE OF THE EDITED DATA will be saved!{/CENTER}","sb5")
  $text("{CENTER}Do you wish to cancel and return to Main Menu?{/CENTER}","sb5")
  $br(2)
  $tag("<center>")
   $submit(yes_btn,"YES")$ctag("&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;")$submit(no_btn,"NO")
  $tag("</center>")
 $sendform("confirm")
 if $endbutton = "SUBMIT" or yes_btn = "Y"
   continue = "N"
 endif
end confirm_edit

'*************************************CONFIRM NOTE INFO**************************************
'Confirm with that the date entered in the event is correct before moving to the next       *
'call point in the note.                                                                    *
'********************************************************************************************
function confirm_note(Client,sdate,stime,sac) is null
 Client   is x
 sdate    is d
 stime    is t
 sac      is b
 sac_code is x
 sac_desc is x
 c.fn     is x
 c.ln     is x
 yes_btn  is x
 no_btn   is x
 sac_code = sac
 (void)$geteditmsg(sac,"SAM",sac_desc)
 (void)$dbread(2, Client, c.fn, c.ln)
 $submitopt("off","Yes")
 $cancelopt("off","No")
 $form("datechk")
  $bstyle("buttondown","button")
  $text("{h2}Please Review{/h2}")
  $table("datechk")
   $row()$col("center")$text("You have entered a service date of", "datatag")
   $row()$col("center")$text(`$format(sdate, "MM/DD/YYYY")`, "error")
   $row()$col("center")$text("For client", "datatag")
   $row()$col("center")$text(`c.fn + " " + c.ln + " (" + client + ")"`, "error")
   $row()$col("center")$text("Starting at " , "datatag")
   $row()$col("center")$text(`$format(stime,"HH:MM AP")`, "error")
   $row()$col("center")$text("For Service Code " , "datatag")
   $row()$col("center")$text(`sac_desc + " (" + sac_code + ") "`, "error")
   $row()$col("center")$text("Is this correct?", "datatag")  
  $endtable("datechk")
  $br(2)
  $tag("<center>")
  $submit(yes_btn,"YES")$ctag("&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;")$submit(no_btn,"NO")
  $tag("</center>")  
 $sendform("datechk")
 if $endbutton = "CANCEL" or no_btn = "Y"
  $reqcancel = "Y"
  $returnerr = "Y"
  $callpoint = "1"
 endif
end confirm_note

'*************************************CHANGE BUI HEADER TITLE********************************
'This function changes the page title of the current BUI form                               *
'********************************************************************************************
function changetitle(newtitle) is null
 newtitle is x
 XTemp is x
 $ctag("<script language='Javascript'>")
 XTemp = "    document.title=" + x"22" + newtitle + x"22" + ";"
 $ctag(XTemp)
 $ctag("</script>")
end changetitle

'*************************************Get a Staff ID*****************************************
'This function is a simple BUI form to get a staff ID and return it                         *
'********************************************************************************************
function GetStaffID() is x
 s.id     is x
 $submitopt("off", "NEXT")
 $cancelopt("off", "CANCEL")
 $form("staff")
  $tag("<CENTER>")
   $text("{H1}Enter Staff ID{/H1}")
   $text("ENTER STAFF ID: ","datatag")  
   $textbox(s.id,"DB``03",6,,"Y")
   $editmsg(s.id)
  $tag("</CENTER>")
 $sendform("staff")
 if $endbutton = "CANCEL"
  return
 elseif $endbutton = "SUBMIT"
  GetStaffID = s.id
 endif
end GetStaffID

'*************************************Get a Client ID*****************************************
'This function is a simple BUI form to get a client ID and return it                         *
'*********************************************************************************************
function GetClientID() is x
 c.id is x
 $clear(c.id) 
 $submitopt("off", "NEXT")
 $cancelopt("off", "CANCEL")
 $form()
  $text("{H1}Enter Client ID{/H1}")
  $table("t1",,"width='100%'")
   $row()$col("right",,"50%") $text("ENTER CLIENT ID: ","datatag")  
         $col() $textbox(c.id,"DB``02",6,4,"Y") $editmsg(c.id)
  $endtable("t1")
 $sendform()
 if $endbutton = "SUBMIT"
  GetClientID = c.id
 endif
end GetClientID

'*******************************Simple Signature Line****************************************
'This function is a plain signature line function for bui forms.                            *
'********************************************************************************************
function SigLine(description) is null
 description is x
 $setstyle(".sigline1", "font-family:times new roman", "font-size:10pt", "color:black", "font-weight:bold")
 $setstyle(".sigline2", "font-family:times new roman", "font-size:7pt", "color:black")
 $table("sigline", "width='100%'")
  $row()$col("center",,"35%","4","1")$text(description,"sigline1")
   $col(,,"45%","2","1")
   $text("___________________________________________________________","sigline1")
   $col(,,"20%","1","1")
   $text("_____________","sigline1")
  $row()
   $col("center",,"35%","4","1")
   $col("center",,"45%","2","1")
   $text("Signature","sigline2")
   $col(,,"20%","1","1")
   $text("Date","sigline2")
 $endtable("sigline")
end SigLine

'*******************************View IRMS Category*******************************************
'This function will create a form with IRMS java viewer displaying a selected category      *
'********************************************************************************************
function irmsview(client,category) is null
 category  is x
 client    is x
 if client !dp
  client = GetClientID()
 endif 
 $form("viewer")
  $irmsviewer(02, client, category)
 $sendform("viewer")
end irmsview

'*******************************Check for SA DX**********************************************
'This function will check Axis I of the DX record and return "Y" if  any of the DXs is a 
'substance abuse DX. This is part of the DLA process for adults.
'http://en.wikipedia.org/wiki/DSM-IV_Codes#Substance-Related_Disorders
'********************************************************************************************
function DLA_SA(client) is x
 client is x
 %include inc_DX
 DX[] is x   'Substance Abuse DXs
 i    is i   'Array Index
 stop is x   'Stop because a match has been made? Y/N

 i = 0
 stop = "N"
'Alcohol-Related Disorders
 dx[++i] = "305.00" 'Abuse
 dx[++i] = "303.90" 'Dependence
 dx[++i] = "291.8"  'Induced Anxiety Disorder
 dx[++i] = "291.8"  'Induced Mood Disorder
 dx[++i] = "291.1"  'Induced Persisting Amnestic Disorder
 dx[++i] = "291.2"  'Induced Persisting Dementia
 dx[++i] = "291.5"  'Induced Psychotic Disorder, With Delusions
 dx[++i] = "291.3"  'Induced Psychotic Disorder, With Hallucinations
 dx[++i] = "291.8"  'Induced Sexual Dysfunction
 dx[++i] = "291.8"  'Induced Sleep Disorder
 dx[++i] = "303.00" 'Intoxication
 dx[++i] = "291.0"  'Intoxication Delirium
 dx[++i] = "291.9"  'Related Disorder NOS
 dx[++i] = "291.8"  'Withdrawal
 dx[++i] = "291.0"  'Withdrawal Delirium
'Amphetamine (Or Amphetamine-Like) Related Disorders
 dx[++i] = "305.70" 'Abuse
 dx[++i] = "304.40" 'Dependence
 dx[++i] = "292.89" 'Induced Anxiety Disorder
 dx[++i] = "292.84" 'Induced Mood Disorder
 dx[++i] = "292.11" 'Induced Psychotic Disorder, With Delusions
 dx[++i] = "292.12" 'Induced Psychotic Disorder, With Hallucinations
 dx[++i] = "292.89" 'Induced Sexual Dysfunction
 dx[++i] = "292.89" 'Induced Sleep disorder
 dx[++i] = "292.89" 'Intoxication
 dx[++i] = "292.81" 'Intoxication Delirium
 dx[++i] = "292.9"  'Related Disorder NOS
 dx[++i] = "292.0"  'Withdrawal
'Caffeine-Related Disorders
 dx[++i] = "292.89" 'Induced Anxiety Disorder
 dx[++i] = "292.89" 'Induced Sleep Disorder
 dx[++i] = "305.90" 'Intoxication
 dx[++i] = "292.9"  'Related Disorder NOS
'Cannabis-Related Disorders
 dx[++i] = "305.20" 'Abuse
 dx[++i] = "304.30" 'Dependence
 dx[++i] = "292.89" 'Induced Anxiety Disorder
 dx[++i] = "292.11" 'Induced Psychotic Disorder, With Delusions
 dx[++i] = "292.12" 'Induced Psychotic Disorder, With Hallucinations
 dx[++i] = "292.89" 'Intoxication
 dx[++i] = "292.81" 'Intoxication Delirium
 dx[++i] = "292.9"  'Related Disorder NOS
'Cocaine-Related Disorders
 dx[++i] = "305.60" 'buse
 dx[++i] = "304.20" 'Dependence
 dx[++i] = "292.89" 'Induced Anxiety Disorder
 dx[++i] = "292.84" 'Induced Mood Disorder
 dx[++i] = "292.11" 'Induced Psychotic Disorder, With Delusions
 dx[++i] = "292.12" 'Induced Psychotic Disorder, With Hallucinations
 dx[++i] = "292.89" 'Induced Sexual Dysfunction
 dx[++i] = "292.89" 'Induced Sleep Disorder
 dx[++i] = "292.89" 'Intoxication
 dx[++i] = "292.81" 'Intoxication Delirium
 dx[++i] = "292.9"  'Related Disorder NOS
 dx[++i] = "292.0"  'Withdrawal
'Hallucinogen-Related Disorders
 dx[++i] = "305.30" 'Abuse
 dx[++i] = "304.50" 'Dependence
 dx[++i] = "292.89" 'Induced Anxiety Disorder
 dx[++i] = "292.84" 'Induced Mood Disorder
 dx[++i] = "292.11" 'Induced Psychotic Disorder, With Delusions
 dx[++i] = "292.12" 'Induced Psychotic Disorder, With Hallucinations
 dx[++i] = "292.89" 'Intoxication
 dx[++i] = "292.81" 'Intoxication Delirium
 dx[++i] = "292.89" 'Persisting Perception Disorder
 dx[++i] = "292.9"  'Related Disorder NOS
'Inhalant-Related Disorders
 dx[++i] = "305.90" 'Abuse
 dx[++i] = "304.60" 'Dependence
 dx[++i] = "292.89" 'Induced Anxiety Disorder
 dx[++i] = "292.84" 'Induced Mood Disorder
 dx[++i] = "292.82" 'Induced Persisting Dementia
 dx[++i] = "292.11" 'Induced Psychotic Disorder, With Delusions
 dx[++i] = "292.12" 'Induced Psychotic Disorder, With Hallucinations
 dx[++i] = "292.89" 'Intoxication
 dx[++i] = "292.81" 'Intoxication Delirium
 dx[++i] = "292.9"  'Related Disorder NOS
'Nicotine-Related Disorders
 dx[++i] = "305.10" 'Dependence
 dx[++i] = "292.9"  'Related Disorder NOS
 dx[++i] = "292.0"  'Withdrawal
'Opioid-Related Disorders
 dx[++i] = "305.50" 'Abuse
 dx[++i] = "304.00" 'Dependence
 dx[++i] = "292.84" 'Induced Mood Disorder
 dx[++i] = "292.11" 'Induced Psychotic Disorder, With Delusions
 dx[++i] = "292.12" 'Induced Psychotic Disorder, With Hallucinations
 dx[++i] = "292.89" 'Induced Sexual Dysfunction
 dx[++i] = "292.89" 'Induced Sleep Disorder
 dx[++i] = "292.89" 'Intoxication
 dx[++i] = "292.81" 'Intoxication Delirium
 dx[++i] = "292.9"  'Related Disorder NOS
 dx[++i] = "292.0"  'Withdrawal
'Phencyclidine (Or Phencyclidine-Like)-Related Disorders
 dx[++i] = "305.90" 'Abuse
 dx[++i] = "304.90" 'Dependence
 dx[++i] = "292.89" 'Induced Anxiety Disorder
 dx[++i] = "292.84" 'Induced Mood Disorder
 dx[++i] = "292.11" 'Induced Psychotic Disorder, With Delusions
 dx[++i] = "292.12" 'Induced Psychotic Disorder, With Hallucinations
 dx[++i] = "292.89" 'Intoxication
 dx[++i] = "292.81" 'Intoxication Delirium
 dx[++i] = "292.9"  'Related Disorder NOS
'Sedative-, Hypnotic-, or Anxiolytic-Related Disorders
 dx[++i] = "305.40" 'Abuse
 dx[++i] = "304.10" 'Dependence
 dx[++i] = "292.89" 'Induced Anxiety Disorder
 dx[++i] = "292.84" 'Induced Mood Disorder
 dx[++i] = "292.83" 'Induced Persisting Amnestic Disorder
 dx[++i] = "292.82" 'Induced Persisting Dementia
 dx[++i] = "292.11" 'Induced Psychotic Disorder, With Delusions
 dx[++i] = "292.12" 'Induced Psychotic Disorder, With Hallucinations
 dx[++i] = "292.89" 'Induced Sexual Dysfunction
 dx[++i] = "292.89" 'Induced Sleep Disorder
 dx[++i] = "292.89" 'Intoxication
 dx[++i] = "292.81" 'Intoxication Delirium
 dx[++i] = "292.9"  'Related Disorder NOS
 dx[++i] = "292.0"  'Withdrawal
 dx[++i] = "292.81" 'Withdrawal Delirium
'Polysubstance-Related Disorder
 dx[++i] = "304.80" 'Polysubstance Dependence
'Other (or Unknown) Substance-Related Disorder
 dx[++i] = "305.90" 'Abuse
 dx[++i] = "304.90" 'Dependence
 dx[++i] = "292.89" 'Induced Anxiety Disorder
 dx[++i] = "292.81" 'Induced Delirium
 dx[++i] = "292.84" 'Induced Mood Disorder
 dx[++i] = "292.83" 'Induced Persisting Amnestic Disorder
 dx[++i] = "292.82" 'Induced Persisting Dementia
 dx[++i] = "292.11" 'Induced Psychotic Disorder, With Delusions
 dx[++i] = "292.12" 'Induced Psychotic Disorder, With Hallucinations
 dx[++i] = "292.89" 'Induced Sexual Dysfunction
 dx[++i] = "292.89" 'Induced Sleep Disorder
 dx[++i] = "292.89" 'ntoxication
 dx[++i] = "292.9" 'Related Disorder NOS
 dx[++i] = "292.0" 'Withdrawal
 (void)$dbread(02, client,c.dsmiiir,c.diag,c.dxaxi2,c.dxaxi3,c.dxaxi4,c.dxaxi5,c.dxaxi6)
 if ($find(c.diag,dx[],,"F") > 0) or ($find(c.dxaxi2,dx[],,"F") > 0) or ($find(c.dxaxi3,dx[],,"F") > 0) or ($find(c.dxaxi4,dx[],,"F")  > 0) or ($find(c.dxaxi5,dx[],,"F")  > 0) or ($find(c.dxaxi6,dx[],,"F")  > 0)
  DLA_SA = "Y"
 endif
end DLA_SA

'*******************************Pad a string with spaces*************************************
'Pad a string with hardspaces(ALT+0160) so that reports can be aligned correctly
'2/24/2015 R. Whaite.  Added argument for optinally sending the ALT+255 "Soft Space" by sending the 
'"S" character in the third argument.
'********************************************************************************************
function padstring(string, int, option) is x
 string is x
 int    is i
 len    is i
 option is x
 space  is x
 
 if option = "S"     	'soft space ALT+255
 	space = " "
 else
 	space = " "					'hard space ALT+0160
 endif
  len = $len(string)
 do while len < int
  string += space
  len = $len(string)
 enddo
 if $len(string) > int
  string = $seg(string,1,int)
 endif
 $allowupdate(string)
 PadString = string
end padstring		  

'******************************Get user location by ip address*******************************
'This function will get the users location by their ip address
'********************************************************************************************
function UserLocation(ip_address) is x
 octet1       is x
 octet2       is x
 octet3       is x
 octet4       is x
 location     is x
 ip_address   is x

 $parsem(ip_address,1,".",octet1,octet2,octet3,octet4)
 select $num(octet3)
'  case 1  location = "WF14"
  case 1  location = "WF2"
  case 6  location = "GR6"
  case 11 location = "WF13"
  case 12 location = "SE1"      
  case 14 location = "HA2"
  case 17 location = "VE2"
  case 18 location = "BO1"
  case 19 location = "CH2"
  case 21 location = "WF14"
  case 23 location = "DE3"
  case 20 location = "QU1"
  case other location = Location_Prompt()
 endselect
 UserLocation = location
end UserLocation

'********************************************************************************************
function BuiUserIP(username) is x
 username is x
 result[] is x
 n is i   'Count of result array.  We want the last one, not the first.
' (void)$unix(`"whodo | grep " + username + " | grep BUI | awk '{print $4}' | tr -d '()'"`, BuiUserIP)
' (void)$unix(`"who | grep " + username + " | grep BUI | awk '{print $6}' | tr -d '()'"`, BuiUserIP)
 (void)$unix(`"who | grep " + username + " | grep BUI | awk '{print $6}' | tr -d '()'"`, result[])

n = $maxarray(result[])

 BuiUserIP = result[n]
end BuiUserIP

dynamic function ConfirmExit() is x
 yes_btn  is x
 no_btn   is x
 $submitopt("off", "YES")
 $cancelopt("off", "NO")
 $form("confirm")
  $bstyle("buttondown","button")
  $text("{H1 align='CENTER'}ARE YOU SURE{/H1}")
  $text("{CENTER}If you cancel now, {u}{b}{font color=red}NONE OF THE DATA{/font}{/b}{/u} will be saved!{/CENTER}",,"font-family:times new roman; font-size:14pt; color:black; font-weight:bold;")
  $text("{CENTER}Do you wish to cancel and return to Main Menu?{/CENTER}",,"font-family:times new roman; font-size:14pt; color:darkblue; font-weight:bold;")
  $br(2)
  $tag("<center>")
   $submit(yes_btn,"YES")$ctag("&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;")$submit(no_btn,"NO")
  $tag("</center>")
  $sendform("confirm")
 if $endbutton = "SUBMIT" or yes_btn = "Y" then
  ConfirmExit = "Y"
 endif
end ConfirmExit

function maxdisplay() is null
 $ctag("<script language='javascript'>")
 $ctag("<!--")
 $ctag("if (navBar.full.firstChild.name != 'min' ) {")
 $ctag(" navBar.full.click();")
 $ctag("}")
 $ctag("//-->")
 $ctag("</script>")
end maxdisplay

function mindisplay() is null
 $ctag("<script language='javascript'>")
 $ctag("<!--")
 $ctag("if (navBar.full.firstChild.name != 'max' ) {")
 $ctag(" navBar.full.click();")
 $ctag("}")
 $ctag("//-->")
 $ctag("</script>")
end mindisplay

function TCOOMMIYN(clientid) is x
 %include inc_C_EL
 result     is x
 clientid   is x
 rc         is b
 TCOOMMIFS  is b
 switch     is b
 switch     = 0
 TCOOMMIFS  = 60
 rc = $dbread(02, clientid, c_el_dstlist)
 do while rc < 2 and switch = 0
  if(c.el.fs = TCOOMMIFS) and c.el.ef.dt <= $today and (c.el.la.dt > $today or c.el.la.dt !dp)
   result = "TCOOMMI"
   switch = 1
  endif
  rc = $dbreadnextdst(02, clientid, c_el_dstlist)
 enddo
 if result dp
  TCOOMMIYN = "Y"
 else
  TCOOMMIYN = "N" 
 endif
end TCOOMMIYN

function CheckStaffRU() is i
 s.ru 		   is b
 allowed_rus[] is b
 allowed_rus[1] = 106
 allowed_rus[2] = 401
 allowed_rus[3] = 201
 allowed_rus[4] = 202 
 allowed_rus[5] = 842
 allowed_rus[6] = 832
 (void)$dbread(3,$operstaffid,s.ru)
 if $find(s.ru,allowed_rus[],1,"F") > 0
  CheckStaffRU = 0
 else
  CheckStaffRU = 1 
 endif
end CheckStaffRU

'****************************************CHECK_MEDICARE STATUS*******************************
'THIS FUNCTION CHECKS A CLIENTS MEDICARE STATUS
function check_medicare(Client, mcare_result) is x
 %include inc_C_EL
 mcare_result   is x 'RESULT OF SEARCH
 Client         is x 'CLIENT ID
 rc             is b 'RETURN CODE
 switch         is b 'FS FOUND SWITCH
 $allowupdate(mcare_result)
 switch = 0
 rc = $dbread(02, Client, c_el_dstlist)
 do while rc < 2 and switch = 0
  if (c.el.fs = 3 and c.el.ef.dt <= $today) and (c.el.la.dt > $today or c.el.la.dt !dp)
   mcare_result = "Medicare Recipient"
   switch = 1 
  endif
  rc = $dbreadnextdst(02, Client, c_el_dstlist)
 enddo
 if mcare_result !dp
  mcare_result = "No Medicare"
 endif
 $tag("<CENTER>")
  $text(mcare_result,"error","color: #00FF00;background-color: #000000")  
 $tag("</CENTER>")
end check_medicare

function DisplayFile(FileNameIO) is null
 FileNameIO  is x
 filein[]    is x
 index       is i
 bytes       is n
 createdt    is d
 createtm    is t
 type        is x
 permissions is x
 owner       is x
 group       is x
 index    = 0
 (void)$checkfile(FileNameIO, bytes, createdt, createtm, type, permissions, owner, group)
 select $getfile(filein[],FileNameIO)
  case 0 $submitopt("off", "")
         $cancelopt("off", "Exit")
		 $form("DISPLAYFILE")
		  $br(2)$text("{center}Weather Report{/center}", "datatag")
		  $br()$text(`"Last Update: " + createdt + "  " + createtm`, "datatag")
		  $br(2)
		  do while index++ < $maxarray(filein[])
		   (void)$replace("^M","",filein[index])
		   $br()$text(filein[index])
		  enddo
		 $sendform("DISPLAYFILE")
  case 1 $brmsg(`"File not found for display: " + FileNameIO`, 1,"W","Error")
  case 2 $brmsg(`"File size greater than 32,767 bytes: " + FileNameIO`, 1,"W","Error")
 endselect
end DisplayFile

function IsTerminalSvr(ip_address) is x
 ip_address is x
 servers[] is x
 servers[1] = "172.16.1.103"   'svra-2
 servers[2] = "172.16.1.9"     'svra
 servers[3] = "172.16.1.62"    'svra-5
 servers[4] = "172.16.1.199"   'svra-10 
 servers[5] = "172.16.1.59"    'oklaunion
 ip_address = $spacecompress(ip_address)
 if $find(ip_address,servers[],1,"F") > 0
  IsTerminalSvr = "Y"
 else
  IsTerminalSvr = "N"
 endif
end IsTerminalSvr

function Location_Prompt() is x
 location     is x
 location_dct is b
 location_dct = 214
 do while 1 = 1
  $submitopt("off","Continue")
  $cancelopt("off","")
  $form("location")
   $bstyle("buttondown","button")
   $text("{h1}Location Selection{/h1}")
   $tag("<center>")
   $br()$text("Please select the location of the appointment/assessment.","datatag")
   $br()$dropboxdct(location,location_dct,,,,"Y")
   $tag("</center>")
  $sendform("location")
  if $endbutton = "SUBMIT"
   Location_Prompt = location
   return
  endif 
 enddo
end Location_Prompt

'function confirm_info(desc[],items[]) is x
''*************************************CONFIRM Correct information**********************************
''Confirm that the correct information was entered
''********************************************************************************************
' desc[]   is x
' items[]  is x
' yes_btn  is x
' no_btn   is x
' index    is i
' index = 0
' $submitopt("off","Yes")
' $cancelopt("off","No")
' $form("INFOCHECK")
'  $bstyle("buttondown","button")
'  $text("{h1}Please Review{/h1}")
'  $br()$text("{CENTER}Is this information correct?{/CENTER}",,"font-family:times new roman; font-size:14pt; color:darkblue; font-weight:bold;")
'  $tag("<center>")
'   do while index++ < $maxarray(desc[])
'    $br()$text(desc[index],"datatag")$text(items[index],"error")
'   enddo
'  $br(2)
'   $submit(yes_btn,"YES")$ctag("&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;")$submit(no_btn,"NO")
'  $tag("</center>")  
' $sendform("INFOCHECK")
' if $endbutton = "CANCEL" or no_btn = "Y"
'  confirm_info = "N"
' endif
'end confirm_info

function confirm_client() is x
'*************************************CONFIRM Correct Client**********************************
'Confirm that the correct client ID was picked before starting an assessment
'********************************************************************************************
 c.fn           is x
 c.ln           is x
 yes_btn        is x
 no_btn         is x
 MondayColor    is x  MondayColor    = "White"
 TuesdayColor   is x  TuesdayColor   = "DarkSalmon "
 WednesdayColor is x  WednesdayColor = "Pink"
 ThursdayColor  is x  ThursdayColor  = "LightGreen "
 FridayColor    is x  FridayColor    = "Salmon"
 SaturdayColor  is x  SaturdayColor  = "Orange"
 SundayColor    is x  SundayColor    = "LightGreen"
 TodaysColor    is x
 (void)$dbread(2,$regid,c.fn,c.ln)
 select $day($today,"DOW")
  case 1 TodaysColor = SundayColor
  case 2 TodaysColor = MondayColor
  case 3 TodaysColor = TuesdayColor
  case 4 TodaysColor = WednesdayColor
  case 5 TodaysColor = ThursdayColor
  case 6 TodaysColor = FridayColor
  case 7 TodaysColor = SaturdayColor
 endselect 
 $setstyle(".sb3", "font-family:arial", "font-size:10pt", "color:black", "font-weight:bold")
 $submitopt("off","Yes")
 $cancelopt("off","No")
 $form("confirm")
  $bstyle("buttondown","button")
  $tag(`"<div style='background-color: " + TodaysColor + ";'>"`)
   $br()$tag("<center>")$image("http://websvr/HFRNet/Images/RoddyStop.jpg")$tag("</center>")
   $br()$text("{h1}Stop and Please Review Before Continuing{/h1}")
   $text(`"{CENTER}You are about to start a process for:  {u}{b}{font color=red}" + c.fn + " " + c.ln + " (" + $regid + "){/font}{/b}{/u}{/CENTER}"`,,"font-family:times new roman; font-size:14pt; color:black; font-weight:bold;")
   $br()$text("{CENTER}{u}{b}Is this the correct client?{/b}{/u}{/CENTER}",,"font-family:times new roman; font-size:14pt; color:darkblue; font-weight:bold;")
   $table("nest2",,"width='100%' cellspacing='0' cellpadding='0'")
    $row()
     $col("center")PrnDemoFS()
     $col("center")PrnAddrFS()
     $col("center")PrnCaseFS()
    $row()
     $col(,,,"2")PrnPCorrFS()
   $endtable("nest2")
   $br()
   $table("dxandua",,"width='100%' cellspacing='0' cellpadding='0'")
    $row()
	 $col(,,"50%")PrnDXFS()
'                  $br()Prn5SerFS()
                  $br()Prn5Pe()
'                  $br()PrnFsFS()
'New
				  $br(2)
				  	$tag("<center>")
						$text("Press Here for Fee/Charge Display  ", "datatag")
						$br()
						$uscWinButton("Fee/Charge","PAYVIEW1","Fee/Charge",1024,768,"","","",$regid)
						$tag("</center>")
'/New						
     $col(,,"2%")	
     $col()PrnUAFS()  
	       $br()PrnPreFS()
'New
		   $br()PrnAdmitFS()
'/New
'	       $br()PrnAcctFS()
if $operstaffid = "3737"
		   $br()PrnInsFS()
endif		   
   $endtable("dxandua") 
'New
'	$br()Prn5Pe()$br()
	$br()Prn5SerFS()$br()

	$br()PrnFsFS()$br()
'/New
   $br(2)
   $tag("<center>")  
    $submit(yes_btn,"YES")$ctag("&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;")$submit(no_btn,"NO")
   $tag("</center>")  
  $tag("</div>")
 $sendform("confirm")
 if $endbutton = "CANCEL" or no_btn = "Y"
  confirm_client = "N"
 endif
end confirm_client

'Returns a selected ru
function Select_RU(msg,submitopt,cancelopt) is b
 msg       is x
 submitopt is x
 cancelopt is x
 e_ru      is b
 if msg !dp
  msg = "Please select an RU:  "
 endif 
 if submitopt !dp
  submitopt = "Continue"
 endif
 if cancelopt !dp
  cancelopt = "Back"
 endif
 do while 1 = 1
  $submitopt("off","submitopt")
  $cancelopt("off","cancelopt")
  $form("SELECTRU")
   $text("{h2}RU Selection{/h2}")
   $tag("<center>")
	$br(2)$text(msg,"datatag")  $textbox(e_ru,"RUA",3,3,"Y")$editmsg(e_ru)
   $tag("</center>")
  $sendform("SELECTRU")
  if $endbutton = "SUBMIT"
   Select_RU = e_ru
  endif
  return
 enddo   
end Select_RU

function UnorderedList(list[],style,sort) is null
 list[] is x
 style  is x
 sort   is x
 index  is i
 index = 0
 select $uc(sort)
  case "A" (void)$sort(list[],"A")
  case "D" (void)$sort(list[],"D")
  case "B" (void)$sort(list[],"B")
  case "F" (void)$sort(list[],"F")
  case "H" (void)$sort(list[],"H")
  case "L" (void)$sort(list[],"L")
 endselect 
 $tag("<ul>")
  do while index++ < $maxarray(list[])
   $tag("<li>")
    $text(list[index],style)
   $tag("</li>")
  enddo
 $tag("</ul>")
end UnorderedList

function OrderedList(list[],style,sort,oltype,startnum) is null
 list[]   is x
 style    is x
 sort     is x
 oltype   is x
 startnum is x
 oltag    is x
 index    is i
 index = 0
 select $uc(sort)
  case "A" (void)$sort(list[],"A")
  case "D" (void)$sort(list[],"D")
  case "B" (void)$sort(list[],"B")
  case "F" (void)$sort(list[],"F")
  case "H" (void)$sort(list[],"H")
  case "L" (void)$sort(list[],"L")
 endselect
 if oltype !dp and startnum !dp
  oltag = "<ol>"
 elseif oltype dp and startnum !dp
  oltag = "<ol type='" + oltype + "'>"
 elseif oltype !dp and startnum dp
  oltag = "<ol start='" + startnum + "'>" 
 elseif oltype dp and startnum dp
  oltag = "<ol type='" + oltype + "' start='" + startnum + "'>" 
 endif 
 $tag(oltag)
  do while index++ < $maxarray(list[])
   $tag("<li>")
    $text(list[index],style)
   $tag("</li>")
  enddo
 $tag("</ol>") 
end OrderedList

function DefinitionList(list1[],style1,list2[],style2,sort) is null
 list1[] is x
 style1  is x
 list2[] is x
 style2  is x
 sort    is x 
 index   is i
 index = 0
 select $uc(sort)
  case "A" (void)$sort(list1[],"A",list2[],"A")
  case "D" (void)$sort(list1[],"D",list2[],"D")
  case "B" (void)$sort(list1[],"B",list2[],"B")
  case "F" (void)$sort(list1[],"F",list2[],"F")
  case "H" (void)$sort(list1[],"H",list2[],"H")
  case "L" (void)$sort(list1[],"L",list2[],"L")
 endselect
 $tag("<dl>")
  do while index++ < $maxarray(list1[])
   $tag("<dt>")
    $text(list1[index], style1)
   $tag("</dt>")
   $tag("<dt>")
    $text(list2[index], style2)
   $tag("</dt>")
  enddo
 $tag("</dl>")  
end DefinitionList

'Upper Corner Live clock script credit: JavaScript Kit (www.javascriptkit.com)
function LiveClock() is null
 $ctag("<span id='liveclock' ></span>")
 $ctag("<script language='JavaScript'>")
 $ctag("<!--")
 $ctag(" function show5(){")
 $ctag("  if (!document.layers&&!document.all&&!document.getElementById)")
 $ctag("   return")
 $ctag("  var Digital=new Date()")
 $ctag("  var hours=Digital.getHours()")
 $ctag("  var minutes=Digital.getMinutes()")
 $ctag("  var seconds=Digital.getSeconds()")
 $ctag("  var dn='PM'")
 $ctag("  if (hours<12)")
 $ctag("   dn='AM'")
 $ctag("  if (hours>12)")
 $ctag("   hours=hours-12")
 $ctag("  if (hours==0)")
 $ctag("   hours=12")
 $ctag("  if (minutes<=9)")
 $ctag("   minutes='0'+minutes")
 $ctag("  if (seconds<=9)")
 $ctag("    seconds='0'+seconds")
 $ctag("//change font size here to your desire")
 $ctag("  myclock='<b>Current Time: '+hours+':'+minutes+':' +seconds+' '+dn+'</b>'")
 $ctag("  if (document.layers){")
 $ctag("   document.layers.liveclock.document.write(myclock)")
 $ctag("   document.layers.liveclock.document.close()")
 $ctag("   }")
 $ctag("  else if (document.all)")
 $ctag("   liveclock.innerHTML=myclock")
 $ctag("  else if (document.getElementById)")
 $ctag("   document.getElementById('liveclock').innerHTML=myclock")
 $ctag("   setTimeout('show5()',1000)")
 $ctag("    }")
 $ctag("   window.onload=show5")
 $ctag("    //-->")
 $ctag("</script>")
end LiveClock

function ClientRequest() is x
 yes_btn is x
 no_btn  is x
 $submitopt("off", "YES")
 $cancelopt("off", "NO")
 $form($funcname)
  $ctag("<div align='center'>")
   $br(4)$text("Will this copy be provided to the client?","H1")
   $br(2)$submit(yes_btn,"YES")$ctag("&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;")$submit(no_btn,"NO")
  $ctag("</div>")
 $sendform($funcname)
 select $endbutton
  case "CANCEL" ClientRequest = "N"
  case "SUBMIT" ClientRequest = "Y"
 endselect
 if no_btn = "Y"
  ClientRequest = "N"  
 elseif yes_btn = "Y"
  ClientRequest = "Y"
 endif
end ClientRequest

function ClientStatus(regid) is null
 regid  is x
 c.type is x
 if c.type !dp
  (void)$dbread(2,regid,c.type)
 endif
 $tag("<CENTER>")
  $text($ncs($dct(38,c.type)),"error","color: #FFFF00;background-color: #000000")  
 $tag("</CENTER>")   
end ClientStatus

function StaffStatus(regid) is null
 regid  is x
 s.type is x
 if s.type !dp
  (void)$dbread(3,regid,s.type)
 endif
 $tag("<CENTER>")
  $text($nc($dct(39,s.type)),"error","color: #FFFF00;background-color: #000000")  
 $tag("</CENTER>")   
end StaffStatus

function ConfirmValue(value,msg_banner,msg_text) is x
 value      is x
 msg_banner is x
 msg_text   is x
 yes_btn    is x
 no_btn     is x
 msg_style  is x
 msg_style = "font-family:times new roman; font-size:14pt; color:darkblue; font-weight:bold;"
 if msg_banner !dp
  msg_banner = "ARE YOUR SURE"
 endif
 if msg_text !dp
  msg_text = "Is this the correct value?"
 endif
 $submitopt("off", "YES")
 $cancelopt("off", "NO")
 $form($funcname)
  $bstyle("buttondown","button")
  $tag("<center>")
   $br(3)$text(msg_banner,"H1")
   $br(2)$text(msg_text,,msg_style)$text(":  ",,msg_style)$tag("<u>")$text(Value,"error")$tag("</u>")
   $br(2)$submit(yes_btn,"YES")$ctag("&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;")$submit(no_btn,"NO")
  $tag("</center>")
  $sendform($funcname)
 if $endbutton = "SUBMIT" or yes_btn = "Y" then
  ConfirmValue = "Y"
 endif
end ConfirmValue

function StfCredentials(staffid, s.enc.sttp06, s.mcred.tp, s.rehab.c, s.cam.ipep, tp_cred, tp_cred_dct, sigline, CredentialDesc) is x
 %include inc_CREDENTIALS
 staffid        is x
 enc_cred_tbl   is b
 sigline        is x
 s.mcred.tp     is x 'Medicaid Credential
 s.rehab.c      is x 'Rehab credential   1 = LPHA, 2 = QMHP, 3 = QMHPP
 s.enc.sttp06   is x 'CAM Staff Type
 s.cam.ipep     is x 'CAM Internal/External
 tp_cred        is x
 tp_cred_dct    is b
 CredentialDesc is x
 index          is i
 $allowupdate(s.enc.sttp06, s.mcred.tp, s.rehab.c, s.cam.ipep,sigline, tp_cred, CredentialDesc)
 (void)$dbread(3,staffid, s.mcred.tp, s.rehab.c, s.enc.sttp06, s.cam.ipep)
 sigline = $dct(9071,staffid,"D") 
'Alt1 for HFC, ? for PV
 select $sysname 
  case "/c0/MIS" or "/c3/TEST"
        if tp_cred_dct dp and s.enc.sttp06 dp
         tp_cred = $dct(tp_cred_dct, s.enc.sttp06, "1") 
		 if tp_cred !dp and (s.rehab.c = "2" or s.rehab.c = "3")
		  tp_cred = "4"
		 endif
         index = $find(tp_cred, Credential_Code[])
         CredentialDesc = Credential_Desc[index]
        endif 
  case "/c2/PV" or "/c4/PVTEST"
        if tp_cred_dct dp and s.enc.sttp06 dp
         tp_cred = $dct(tp_cred_dct, s.enc.sttp06, "1") 
         index = $find(tp_cred, Credential_Code[])
         CredentialDesc = Credential_Desc[index]
        endif 
 endselect		
end StfCredentials

function CheckSigLineDCT() is i
 if $dct(2071,$oper,"D") !dp
  $brmsginit(6,80)
  $brmsg("Your staffname is not currently in the Staff Signature Line table.",1,,"ERROR")
  $brmsg("Please contact the MIS Dept with your credentials so that your signature",3)
  $brmsg("line can be created.", 4)
  $brmsg("Press OK to Continue", 5,"C")
  $brmsg("", 6,"W")
  CheckSigLineDCT = 1
 endif
end CheckSigLineDCT

dynamic function ClientAge(regid, date) is i
 regid is x
 date  is d
 c.bd  is d
 age   is n
 if date !dp
  date = $today
 endif
 if $dbread(2,regid,c.bd) = 0
  age = (date - c.bd) / 365.25
  age = $round(age, 0.001)
  if $month(date) = $month(c.bd) and $day(date) = $day(c.bd)
   age = $round(age, 0.01)
  endif
  ClientAge = age
 else
  ClientAge = 0
 endif
end ClientAge

dynamic function StaffAge(regid, date) is i
 regid is x
 date  is d
 s.bd  is d
 age   is i
 if date !dp
  date = $today
 endif
 if $dbread(3,regid,s.bd) = 0
  age = (date - s.bd) / 365.25
  age = $round(age, 0.001)
  if $month(date) = $month(s.bd) and $day(date) = $day(s.bd)
   Staffage = $round(age, 0.01)
  endif
  StaffAge = age
 else
  StaffAge = 0
 endif 
end StaffAge

function isNumeric(s,IgnoreDash) is x
 s          is x
 i          is i
 x          is x
 IgnoreDash is x
 s = $trim(s)
 if s !dp
  isNumeric = "N"
  return
 endif
 x = $tran(s," ()-+.0123456789","")
 if x dp
  isNumeric = "N"
  return
 endif  
 i = $find(".",s)
 if i > 0
  i = $find(".",s,++i)       
  if i > 0
   isNumeric = "N"
   return
  endif
 endif
 if IgnoreDash !dp or $uc(IgnoreDash) = "N"
  i = $find("-",s)
  if i > 0
   if i != 1
    isNumeric = "N"
    return
   endif
   i = $find("-",s,++i)                       
   if i > 0
    isNumeric = "N"
    return
   endif
  endif
 endif
 isNumeric = "Y"    
end isNumeric

function ValidAddr(regid) is x
 regid    is x
 %include inc_C_AD_REC
 ValidAddr = "Y"
 (void)$dbread(2, regid, c_ad_rec_dstlist)
 if $uc(c.addr1) = "HOMELESS" or $uc(c.addr1) = "GENERAL DELIVERY" or c.addr1 !dp or $uc(c.addr1) = "UNKNOWN" or $uc($seg(c.addr1,1,11)) = "BAD ADDRESS" or $uc($seg(c.addr1,1,16)) = "NEED NEW ADDRESS" or $uc($seg(c.addr1,1,8)) = "NEED NEW"
  ValidAddr = "N"
 endif
end ValidAddr

function ValidTelephone(regid) is x
 regid    is x
 %include inc_C_AD_REC
 (void)$dbread(2, regid, c_ad_rec_dstlist)
 if c.tel dp and IsNumeric(c.tel,"Y") = "Y"
  ValidTelephone = "Y"
 else
  ValidTelephone = "N"
 endif
end ValidTelephone

function DisplayInvalid(InvalidTel[],InvalidAddr[]) is null
 index    is i
 cm       is x
 c.fn     is x
 c.ln     is x
 c.type   is x
 c.cm     is x
 c.2cm    is x
 %include inc_C_AD_REC 
 InvalidTel[]  is x
 InvalidAddr[] is x                                                        
 $submitopt("off","Continue")
 $cancelopt("off","") 
 $form($funcname)
  if $maxarray(InvalidTel[]) > 0
   $br(2)$text("{center}Clients with Bad or Missing Telephone Number{/center}","H1")
'   $br(2)$text("The clients listed below will not have letters printed because of a problem with their primary telephone number.")
   $br(2)$text("The clients listed below will have letters printed as long as there is no further problems with their address record.")
   $br(2)
   $table("TEL",,"background-color='transparent' width='100%' border='0' cellspacing='0'")
    $row()
      $col(,,"%2")
      $col(,,,,,"style='border-bottom:0.05em solid #000000;'")$text("{center}Name{/center}","datatag")
      $col(,,,,,"style='border-bottom:0.05em solid #000000;'")$text("{center}Current Telephone{/center}","datatag")
      $col(,,,,,"style='border-bottom:0.05em solid #000000;'")$text("{center}Primary Case Manager{/center}","datatag")
      $col(,,,,,"style='border-bottom:0.05em solid #000000;'")$text("{center}Current Status{/center}","datatag")
      $col(,,"%2")
     index = 0
     do while index++ < $maxarray(InvalidTel[]) 
      (void)$dbread(2,InvalidTel[index], c.fn, c.ln, c.type, c.cm, c.2cm)
	  (void)$dbread(2,InvalidTel[index],c_ad_rec_dstlist)
	  if c.2cm dp
	   cm = c.2cm
	  elseif c.cm dp
	   cm = c.cm
	  elseif 
	   cm = "NO CM ASSIGNED"
	  endif
	  $row()
	   $col()
	   $col()$text(c.fn)$text(" ")$text(c.ln)
	   $col("center")$text(c.tel)
	   $col("center")$text(cm)
	   $col("center")$text(c.type)
	   $col()
	 enddo
   $endtable("TEL")
  endif
  if $maxarray(InvalidAddr[]) > 0
   $br(2)$text("{center}Clients with Bad or Missing Address{/center}","H1")
   $br(2)$text("The clients listed below will not have letters printed because of a problem with their address.")
   $br()
   $table("ADDR",,"background-color='transparent' width='100%' border='0' cellspacing='0'")
    $row()
     $col(,,"%2")
     $col(,,,,,"style='border-bottom:0.05em solid #000000;'")$text("{center}Name{/center}","datatag")
     $col(,,,,,"style='border-bottom:0.05em solid #000000;'")$text("{center}Current Address{/center}","datatag")
     $col(,,,,,"style='border-bottom:0.05em solid #000000;'")$text("{center}Primary Case Manager{/center}","datatag")
     $col(,,,,,"style='border-bottom:0.05em solid #000000;'")$text("{center}Current Status{/center}","datatag")
     $col(,,"%2")
     index = 0
     do while index++ < $maxarray(InvalidAddr[]) 
      (void)$dbread(2,InvalidAddr[index], c.fn, c.ln, c.type, c.cm, c.2cm)
	  (void)$dbread(2,InvalidAddr[index],c_ad_rec_dstlist)
	  if c.2cm dp
	   cm = c.2cm
	  elseif c.cm dp
	   cm = c.cm
	  elseif 
	   cm = "NO CM ASSIGNED"
	  endif
      $row()
	   $col()
	   $col()$text(c.fn)$text(" ")$text(c.ln)
	   $col()$text(c.addr1)
	         $br()$text(c.addr2)
			 $br()$text(c.city)$text(", ")$text(c.state)$text("    ")$text(c.zip)  
			 $br()$text($dct(68,c.county,"D"))
	   $col("center")$text(cm)
	   $col("center")$text(c.type)
	   $col()
	 enddo
   $endtable("ADDR")
   $br(3)
  endif
 %include c_pbutton
 $sendform($funcname) 
end DisplayInvalid

function CheckTelAddr(clients[],Display,InvalidTel[],InvalidAddr[]) is null
 clients[]     is x
 Display       is x
 InvalidTel[]  is x
 InvalidAddr[] is x
 index         is i
 $allowupdate(InvalidTel[],InvalidAddr[])
' if $operstaffid = "3737"
  $clear(InvalidTel[],InvalidAddr[])
  index = 0
  do while index++ < $maxarray(clients[])
   if ValidTelephone(clients[index]) = "N"
    (void)$arrpush(InvalidTel[], clients[index])
   endif
   if ValidAddr(clients[index]) = "N"
    (void)$arrpush(InvalidAddr[], clients[index])
   endif
  enddo
  if $maxarray(InvalidTel[]) > 0 or $maxarray(InvalidAddr[]) > 0 and $uc(Display) = "Y"
   DisplayInvalid(InvalidTel[],InvalidAddr[])
  endif
' endif
end CheckTelAddr

function RemoveInvalid(client[],InvalidTel[], InvalidAddr[],date[],time[],service[],sloc[]) is null
 client[]      is x
 InvalidTel[]  is x
 InvalidAddr[] is x
 date[]        is d
 time[]        is t
 service[]     is b
 sloc[]        is x
 index         is i
 do while $maxarray(InvalidTel[]) > 0
  index = $find(InvalidTel[1],client[],1,"F")
  if index > 0
   (void)$arrremove(client[index],1,date[],time[],service[],sloc[])
   (void)$arrremove(InvalidTel[1])
  else
   (void)$arrremove(InvalidTel[1])  
  endif
 enddo
 if $maxarray(client[]) > 0
  do while $maxarray(InvalidAddr[]) > 0
   index = $find(InvalidAddr[1],client[],1,"F")
   if index > 0
    (void)$arrremove(client[index],1,date[],time[],service[],sloc[])
    (void)$arrremove(InvalidAddr[1])
   else
    (void)$arrremove(InvalidAddr[1])
   endif
  enddo
 endif
 $allowupdate(client[],date[],time[],service[],sloc[])
end RemoveInvalid

function FiscalYear(date,FY) is null
 date            is d
 FY              is i
 month           is i
 year            is i
 if date dp
  month = $month(date)
  year  = $year(date)
  if month > 8 and month < 13  
   FY = ++year
  else
   FY = year   
  endif 
 $allowupdate(FY)
 endif
end FiscalYear

function CurrentMonth(date) is x
 date   is d
 month  is i
 year   is i
 mmyyyy is x
 if date !dp
  date = $today
 endif
 month = $month(date)
 year  = $year(date)
 if month < 10
  CurrentMonth = "0" + $castx(month) + $castx(year)
 else
  CurrentMonth = $castx(month) + $castx(year)
 endif 
end CurrentMonth

function PreviousMonth(date) is x
 date   is d
 month  is i
 year   is i
 if date !dp
  date = $today
 endif
 month = $month(date)
 year  = $year(date)
 if month = 1
  month = 12
  year--
 else
  month--
 endif 
 if month < 10
  PreviousMonth = "0" + $castx(month) + $castx(year)
 else
  PreviousMonth = $castx(month) + $castx(year)
 endif
end PreviousMonth

function NextMonth(date) is x
 date is d
 month  is i
 year   is i 
 if date !dp
  date = $today
 endif
 month = $month(date)
 year  = $year(date)
 if month = 12
  month = 1
  year++
 else
  month++
 endif
 if month < 10
  NextMonth = "0" + $castx(month) + $castx(year) 
 else
  NextMonth = $castx(month) + $castx(year) 
 endif 
end NextMonth

'yeah, i know you could just see if the 29th is in the year
function LeapYearYN(date) is x
 date is d
 if date !dp
  date = $today
 endif
 LeapYearYN = "N"
 if $mod($year(date),4) = 0
  if $mod($year(date),100) != 0
   LeapYearYN = "Y"
  elseif $mod($year(date),400) = 0
   LeapYearYN = "Y"
  endif
 endif 
end LeapYearYN

function ConfirmTime(time) is x
 time      is t
 starttime is t
 stoptime  is t
 yes_btn   is x
 no_btn    is x

 starttime = 00:00
 stoptime  = 07:00  

 if time >= starttime and time <= stoptime
  $submitopt("off", "YES")
  $cancelopt("off", "NO")
  $form("confirm")
   $bstyle("buttondown","button")
   $text(`"{H1 align='CENTER'}Time is between " + $format(starttime,"HH:MM AP") + " and " + $format(stoptime,"HH:MM AP") + "{/H1}"`)
   $text("{CENTER}Is the time that you entered correct?{/CENTER}",,"font-family:times new roman; font-size:14pt; color:black; font-weight:bold;")
   $br()$text(`"{CENTER}{u}" + $format(time,"HH:MM AP") + "{/u}{/CENTER}"`,,"font-family:times new roman; font-size:18pt; color:red; font-weight:bold;")
   $br(2)
   $tag("<center>")
    $submit(yes_btn,"YES")$ctag("&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;")$submit(no_btn,"NO")
   $tag("</center>")
   $sendform("confirm")
  if $endbutton = "SUBMIT" or yes_btn = "Y" then
   ConfirmTime = "Y"
  else
   ConfirmTime = "N"
  endif 
 else
  ConfirmTime = "Y"
 endif
end ConfirmTime

dynamic function ClientLastUA(Client,date, ua_date, ua_type, ua_locr, ua_loca, ua_due, client_age,ua_discharge, ua_rdmtrr, a_add_stg, a_add_sti, a_add_se, c_addfca, c_addgca, loca, loca_desc,trr_loca,restype) is null
 Client       is x
 date         is d
 ua_date      is d
 ua_type      is x
 ua_locr      is x
 ua_loca      is x
 ua_due       is d
 ua_discharge is d
 ua_rdmtrr    is x   'This var will hold a "R" if the UA is RDM or a "T" if the UA is TRR.  
 a_add_stg    is x
 a_add_sti    is x
 a_add_se     is x
 c_addfca     is x
 c_addgca     is x
 loca         is x
 loca_desc    is x
 trr_loca     is x
 client_age   is i
 restype      is x
              
 c.uabd          is h
 c.uabd.pur      is x
 c.uabd.aloc     is x
 c.uabd.rloc     is x
 c.uabd.date     is d
 c.uabd.extd     is x
 c.uabd.annual   is x
 c.uabd.disdt    is d
 c.uabd.addonstg is x 'Adult UA Skills Training Group Add on
 c.uabd.addonse  is x 'Adult UA Skills Supported Employment Add on
 c.uabd.addonsti is x 'Adult UA Skills Training Individual Add on 

 c.cabd.rec      is h
 c.cabd.ass      is x
 c.cabd.aloc     is x
 c.cabd.locr     is x
 c.cabd.date     is d
 c.cabd.extd     is x
 c.cabd.disdt    is d
 c.cabd.addonfca is x 'Child UA Addon Family Counseling
 c.cabd.addongca is x 'Child UA Addon Group Counseling
 
 c.ansa.rec       is h
 c.ansa.type      is x
 c.ansa.aloc      is x
 c.ansa.rloc      is x
 c.ansa.date  	  is d
 c.ansa.disdt 	  is d
 c.ansa.alocedate is d
 c.ansa.compd     is d
 c.ansa.restype   is x
 
 c.cans.rec   	  is h
 c.cans.type  	  is x
 c.cans.aloc  	  is x
 c.cans.rloc  	  is x
 c.cans.date  	  is d
 c.cans.disdt 	  is d
 c.cans.alocedate is d
 c.cans.compd     is d 
 c.cans.restype   is x 
 
 $clear(ua_date, ua_type, ua_locr, ua_loca, ua_due, client_age,a_add_stg, a_add_sti, a_add_se, c_addfca, c_addgca,loca,loca_desc,trr_loca)
 $allowupdate(ua_date, ua_type, ua_locr, ua_loca, ua_due, ua_discharge, client_age, ua_rdmtrr, a_add_stg, a_add_sti, a_add_se, c_addfca, c_addgca,loca,loca_desc,trr_loca)

 if date !dp
  date = $today
 endif
 client_age = ClientAge(Client,date)

 if client_age >= 18
'CALCULATE DUE DATE FOR ADULT UA  
'Read both UABD and ANSA record, then decide which date to use
  (void)$dbread(02, client, c.ansa.rec, c.ansa.type, c.ansa.aloc, c.ansa.rloc, c.ansa.date, c.ansa.disdt, c.ansa.alocedate, c.ansa.compd,c.ansa.restype)
  if c.ansa.rec dp and c.ansa.compd !dp or c.ansa.date > date
   (void)$dbreadnextdst(02, client, c.ansa.rec, c.ansa.type, c.ansa.aloc, c.ansa.rloc, c.ansa.date, c.ansa.disdt, c.ansa.alocedate, c.ansa.compd,c.ansa.restype)
  endif
  (void)$dbread(02, client, c.uabd, c.uabd.pur, c.uabd.aloc, c.uabd.date, c.uabd.extd, c.uabd.rloc, c.uabd.annual, c.uabd.disdt,c.uabd.addonstg,c.uabd.addonsti,c.uabd.addonse)  
  if c.ansa.rec dp and c.ansa.compd dp
   ua_due = c.ansa.alocedate
   if c.ansa.disdt dp
    ua_discharge = c.ansa.disdt
   else
    ua_date = c.ansa.date
    ua_type = c.ansa.type
    ua_due  = c.ansa.alocedate
    ua_locr = $dct(9712,c.ansa.rloc,"2")
	if ua_locr !dp
     ua_locr = $dct(9712,c.ansa.rloc,"1")	
	endif
	if ua_locr !dp
     ua_locr = $dct(9712,c.ansa.rloc,"3")	
	endif	
	if ua_locr !dp
     ua_locr = c.ansa.rloc
	endif			
    ua_loca = $dct(9712,c.ansa.aloc,"2")
	if ua_loca !dp
     ua_loca = $dct(9712,c.ansa.aloc,"1")	
	endif
	if ua_loca !dp
     ua_loca = $dct(9712,c.ansa.aloc,"3")	
	endif	
	if ua_loca !dp
     ua_loca = c.ansa.aloc
	endif
    loca = c.ansa.aloc
	loca_desc = $dct(9712,c.ansa.aloc,"D")
	trr_loca = $dct(9712,c.ansa.aloc,"1")
	restype = c.ansa.restype 
    ua_rdmtrr = "T"
    if ua_loca = "1S" or ua_loca = "2" or ua_loca = "3" or ua_loca = "4" or ua_loca = "5"
	 a_add_stg = "Y"
     a_add_sti = "Y"
     a_add_se = "Y"
    endif	
   endif
  elseif c.uabd dp
   if c.uabd.disdt dp 
    ua_discharge = c.uabd.disdt
   endif
   if (c.uabd dp and c.uabd.pur != "D" and c.uabd.aloc !dp) or
 'added to keep working down through the layers with the current layer has a UABD date > the date passed to the libarary
       c.uabd.date > date  'or c.uabd.pur = "D"
    (void)$dbreadnextdst(02, client, c.uabd, c.uabd.pur, c.uabd.aloc, c.uabd.date, c.uabd.extd, c.uabd.rloc, c.uabd.annual, c.uabd.disdt,c.uabd.addonstg,c.uabd.addonsti,c.uabd.addonse)    
   endif
   ua_date = c.uabd.date
   ua_type = c.uabd.pur
   ua_locr = c.uabd.rloc
   ua_loca = c.uabd.aloc
   a_add_stg = c.uabd.addonstg
   a_add_sti = c.uabd.addonsti
   a_add_se  = c.uabd.addonse
   c_addfca  = c.cabd.addonfca
   c_addgca  = c.cabd.addongca
   ua_rdmtrr = "R"   
   loca = c.uabd.aloc
   loca_desc = $dct(9002,c.uabd.aloc,"D")   
   if c.uabd.aloc = "1" and c.uabd.annual = "Y"
    ua_due = c.uabd.date + 365
   elseif (c.uabd.pur = "I" or c.uabd.pur = "U") and (c.uabd.aloc = "1" or c.uabd.aloc = "2" or c.uabd.aloc = "3" or  c.uabd.aloc = "4") and (c.uabd.extd != "Y")
    ua_due = c.uabd.date + 90
   elseif (c.uabd.pur = "I" or c.uabd.pur = "U") and (c.uabd.extd = "Y")
    ua_due = c.uabd.date + 180
   elseif (c.uabd.pur = "I" or c.uabd.pur = "U") and (c.uabd.aloc = "5")
    ua_due = c.uabd.date + 90
   elseif c.uabd.aloc = "0"
    ua_due = c.uabd.date + 7
   elseif c.uabd.aloc = "8"
    ua_due = c.uabd.date + 365
   else
    $clear(ua_due)
   endif
  endif
 elseif client_age < 18
'CALCULATE DUE DATE FOR CHILD UA
'read both CABD and CANS data and then decide which data to use
  (void)$dbread(02, client, c.cans.rec, c.cans.type, c.cans.aloc, c.cans.rloc, c.cans.date, c.cans.disdt, c.cans.alocedate, c.cans.compd,c.cans.restype)
  if c.cans.rec dp and c.cans.compd !dp or c.cans.date > date
   (void)$dbreadnextdst(02, client, c.cans.rec, c.cans.type, c.cans.aloc, c.cans.rloc, c.cans.date, c.cans.disdt, c.cans.alocedate, c.cans.compd,c.cans.restype)  
  endif
  (void)$dbread(02, client, c.cabd.rec, c.cabd.ass, c.cabd.aloc, c.cabd.date, c.cabd.extd, c.cabd.locr, c.cabd.disdt,c.cabd.addonfca,c.cabd.addongca)
  if c.cans.rec dp and c.cans.compd dp
   ua_due = c.cans.alocedate
   if c.cans.disdt dp
    ua_discharge = c.cans.disdt
   else
    ua_date = c.cans.date
    ua_type = c.cans.type
    ua_due  = c.cans.alocedate
    ua_locr = $dct(9705,c.cans.rloc,"1")
	if ua_locr !dp
     ua_locr = $dct(9705,c.cans.rloc,"2")	
	endif
	if ua_locr !dp
     ua_locr = $dct(9705,c.cans.rloc,"3")	
	endif	
	if ua_locr !dp
     ua_locr = c.cans.rloc
	endif			
    ua_loca = $dct(9705,c.cans.aloc,"1")
	if ua_loca !dp
     ua_loca = $dct(9705,c.cans.aloc,"2")	
	endif
	if ua_loca !dp
     ua_loca = $dct(9705,c.cans.aloc,"3")	
	endif	
	if ua_loca !dp
     ua_loca = c.cans.aloc
	endif
    loca = c.cans.aloc
	loca_desc = $dct(9705,c.cans.aloc,"D")
	trr_loca = $dct(9705,c.cans.aloc,"2")		
    restype = c.cans.restype
    ua_rdmtrr = "T"
	if ua_loca = "2" or ua_loca = "3" or ua_loca = "4" or ua_loca = "YC" or ua_loca = "5" or ua_loca = "2.1" or ua_loca = "2.2"
     c_addfca = "Y"
     c_addgca = "Y"
	endif    
   endif  
  elseif c.cabd.rec dp 
   if c.cabd.disdt dp 
    ua_discharge = c.cabd.disdt
   endif   
   if (c.cabd.rec dp and c.cabd.ass != "D" and c.cabd.aloc !dp) or
 'added to keep working down through the layers with the current layer has a UABD date > the date passed to the libarary
       c.cabd.date > date 'or c.cabd.ass = "D"
    (void)$dbreadnextdst(02, client, c.cabd.rec, c.cabd.ass, c.cabd.aloc, c.cabd.date, c.cabd.extd, c.cabd.locr, c.cabd.disdt,c.cabd.addonfca,c.cabd.addongca)  
   endif
   ua_date = c.cabd.date
   ua_type = c.cabd.ass
   ua_locr = c.cabd.locr
   ua_loca = c.cabd.aloc
   c_addfca = c.cabd.addonfca
   c_addgca = c.cabd.addongca   
   loca = c.cabd.aloc
   loca_desc = $dct(9014,c.cabd.aloc,"D")   
   ua_rdmtrr = "R"
   if (c.cabd.ass = "I" or c.cabd.ass = "U") and (c.cabd.aloc = "1.1" or c.cabd.aloc = "1.2" or c.cabd.aloc = "2.1" or c.cabd.aloc = "2.2" or c.cabd.aloc = "2.3" or c.cabd.aloc = "2.4" or c.cabd.aloc = "3" or c.cabd.aloc = "4") and
    (c.cabd.extd != "Y")
    ua_due = c.cabd.date + 90
   elseif (c.cabd.ass = "I" or c.cabd.ass = "U") and (c.cabd.extd = "Y")
    ua_due = c.cabd.date + 180
   elseif (c.cabd.ass = "I" or c.cabd.ass = "U") and (c.cabd.aloc = "5")
    ua_due = c.cabd.date + 90
   elseif c.cabd.aloc = "0"
    ua_due = c.cabd.date + 7
   elseif c.cabd.aloc = "8"
    ua_due = c.cabd.date + 365
   else
    $clear(ua_due)
   endif
  endif
 endif
end ClientLastUA

function User_Location_Ck(staffid,ip_address,location) is null
 staffid        is x
 ip_address     is x
 location       is x

 current_clinic is x
 dct_clinic     is x
 staffdct       is b
 clinicdct      is b

 staffc[]        is x
 staffd[]        is x
 staffa1[]       is x
 staffa2[]       is x
 staffa3[]       is x

 clinicsc[]      is x
 clinicsd[]      is x
 clinicsa1[]     is x
 clinicsa2[]     is x
 clinicsa3[]     is x
 ignore[]        is x

 staffdct  = 9040
 clinicdct = 9041 
 (void)$arrinsert(ignore[],"3001")     'Dr. Smith                 
 (void)$arrinsert(ignore[],"3547")     'Dr. Henderson             
 (void)$arrinsert(ignore[],"3617")     'Dr. Vachhani              
 (void)$arrinsert(ignore[],"3940")     'Dr. Patel                 
 (void)$arrinsert(ignore[],"4004")     'Dr. Seward                
 (void)$arrinsert(ignore[],"4076")     'Dr. Wamble                
 (void)$arrinsert(ignore[],"4084")     'Dr. Griffith              
 (void)$arrinsert(ignore[],"4101")     'Dr. Strebeck              
 '(void)$arrinsert(ignore[],"4102")     'Dr. Luke                   
 (void)$arrinsert(ignore[],"4104")     'Dr. Solano                
 (void)$arrinsert(ignore[],"4120")     'Dr. Nguyen                
 (void)$arrinsert(ignore[],"J003")     'Dr. Dejarnette            
 (void)$arrinsert(ignore[],"J994")     'JSA Doctor Seymour        
 (void)$arrinsert(ignore[],"J995")     'JSA Doctor Vernon         
 (void)$arrinsert(ignore[],"J996")     'JSA Doctor Quanah         
 (void)$arrinsert(ignore[],"J997")     'JSA Doctor Childress      
 (void)$arrinsert(ignore[],"J998")     'JSA Doctor Haskell        
 (void)$arrinsert(ignore[],"J999")     'JSA Doctor Denver Street  
 (void)$arrinsert(ignore[],"J999")     'JSA Doctor Denver Street  
 if staffid !dp
  staffid = $operstaffid
 endif
 if $find(staffid,ignore[]) = 0
  (void)$dctload(staffdct, staffc[], staffd[], staffa1[], staffa2[], staffa3[])
  if $find(staffid,staffc[]) > 0
   (void)$dctload(clinicdct, clinicsc[], clinicsd[], clinicsa1[], clinicsa2[], clinicsa3[])   
   if ip_address !dp
    ip_address = BuiUserIP($logname)
   endif 
   if IsTerminalSvr(ip_address) = "N" 
    if location !dp
     location = UserLocation(ip_address)
     location = clinicsc[`$find(location,clinicsa1[],,"F")`]
    endif 
    dct_clinic = $dct(staffdct,staffid,"1")
    if location != dct_clinic
     $brmsginit(5,80)
     $brmsg("Note: Your Clinic setting is different from your physical location.",1,"C")
     $brmsg("You can change your Clinic setting by using 'Set Staff Attendance'",2,"C")
	 $brmsg(`"Your Location:   " + location`,3,"C")
	 $brmsg(`"Current Setting: " + dct_clinic`,4,"C")
	 $brmsg(,5,"W","Location Changed")
	 location = dct_clinic
	 $allowupdate(location)
    endif 
   endif
  endif
 endif
end User_Location_Ck 

function ClientPageHeader(CID) is null
 CID  is x
 c.fn is x
 c.mn is x
 c.ln is x

 if $regid dp and cid !dp
  CID = $regid
 endif
 (void)$dbread(02, CID, c.fn, c.mn, c.ln)

 $table("PageHeader",,"width='100%'")
  $row()  
   $col("right",,"33%","1","1")$text("Consumer ID","hdrtag")$ctag("&nbsp;&nbsp;&nbsp;&nbsp;")$text(CID,"hdrdate")$col(,,"25%","1","1")
   $col(,,"42%","1","1")$text("Consumer Name","hdrtag")$ctag("&nbsp;&nbsp;&nbsp;&nbsp;")$text(`c.ln + ", " + c.fn`,"hdrdate")
   if c.mn dp
    $ctag("&nbsp;")$text(`$seg(c.mn,1,1) + "."`,"hdrdate")
   endif
 $endtable("PageHeader")
 $tag("<hr/>")
end ClientPageHeader

function GetReceipts(staffid, cid, startdate, enddate, rcpt_id[], rcpt_date[], rcpt_time[], rcpt_staff[], rcpt_client[], rcpt_method[], rcpt_chck_no[], rcpt_void[], rcpt_void_staff[], rcpt_void_date[], rcpt_void_time[], rcpt_amount[], rcpt_loc[]) is i
 test is x
 %include inc_RCPT
 staffid           is x
 cid               is x
 startdate         is d
 enddate           is d
 rcpt_id[]         is x     'RECEIPT ID
 rcpt_date[]       is d     'RECEIPT DATE
 rcpt_time[]       is t     'RECEIPT TIME
 rcpt_staff[]      is x     'RECEIPT STAFF
 rcpt_client[]     is x     'RECEIPT CLIENT
 rcpt_method[]     is x     'RECEIPT METHOD
 rcpt_chck_no[]    is x     'RECEIPT CHECK NUMBER
 rcpt_void[]       is x     'RECEIPT VOID
 rcpt_void_staff[] is x     'RECEIPT VOID STAFF
 rcpt_void_date[]  is d     'RECEIPT VOID DATE
 rcpt_void_time[]  is t     'RECEIPT VOID TIME
 rcpt_amount[]     is n     'RECEIPT AMOUNT
 rcpt_loc[]        is x     'RECEIPT LOCATION
 rc                is i
 parm[]            is x
 criteria[]        is x
 results[]         is x
 num-selected      is i
 index             is i
 
 index = 0
 $clear(rcpt_id[], rcpt_date[], rcpt_time[], rcpt_staff[], rcpt_client[], rcpt_method[], rcpt_chck_no[], rcpt_void[], rcpt_void_staff[], rcpt_void_date[], rcpt_void_time[], rcpt_amount[], rcpt_loc[])
 
'Don't get the voids.
 parm[++index]    = "DST# 19008"
 criteria[index]  = "!\DP"
 
 if staffid dp
  parm[++index]   = "DST# 19004"
  criteria[index] = staffid
 endif  
 
 if CID dp
  parm[++index]   = "DST# 19005"
  criteria[index] = cid
 endif  
 
 if startdate dp and enddate !dp
  parm[++index]   = "DST# 19002"
  criteria[index] = $replace("/","", $castx(startdate))
 endif  
 
 if startdate dp and enddate dp
  parm[++index]   = "DST# 19002"
  if startdate < enddate
   criteria[index] = $replace("/","", $castx(startdate)) + "-" + $replace("/","", $castx(enddate))
  else
   criteria[index] = $replace("/","", $castx(enddate)) + "-" + $replace("/","", $castx(startdate))
  endif
 endif  

 $searchparm(parm[])
 rc = $searchinit()
 rc = $search(criteria[],num-selected,,,results[])
 select rc
  case 0 index = 0
         do while index++ < num-selected
          (void)$dbread(63,results[index], rcpt.date, rcpt.time, rcpt.staff, rcpt.client, rcpt.method, rcpt.chck.no, rcpt.void, rcpt.void.staff, rcpt.void.date, rcpt.void.time, rcpt.amount, rcpt.loc)
          rcpt_id[index]         = results[index]
          rcpt_date[index]       = rcpt.date
          rcpt_time[index]       = rcpt.time
          rcpt_staff[index]      = rcpt.staff
          rcpt_client[index]     = rcpt.client
          rcpt_method[index]     = rcpt.method
          rcpt_chck_no[index]    = rcpt.chck.no
          rcpt_void[index]       = rcpt.void
          rcpt_void_staff[index] = rcpt.void.staff
          rcpt_void_date[index]  = rcpt.void.date
          rcpt_void_time[index]  = rcpt.void.time
          rcpt_amount[index]     = rcpt.amount
          rcpt_loc[index]        = rcpt.loc
         enddo
         $allowupdate(rcpt_id[], rcpt_date[], rcpt_time[], rcpt_staff[], rcpt_client[], rcpt_method[], rcpt_chck_no[], rcpt_void[], rcpt_void_staff[], rcpt_void_date[], rcpt_void_time[], rcpt_amount[], rcpt_loc[]) 
  case other GetReceipts = rc
       test = $errmsg
 endselect
end GetReceipts

function DisplayMSG(msg, bg-text, scriptid, linenum, returncode,contact) is null
 msg        is x
 bg-text    is x
 scriptid   is x
 linenum    is x
 returncode is x
 contact    is x
 if contact !dp
  contact = "Please call the Help Desk with this information at ext. 3160" 
 endif
 $brmsginit(7,80)
 $brmsg(msg,1,,bg-text)
 $brmsg(`"Script: " + scriptid`,2,,bg-text) 
 if returncode dp
  $brmsg(`"RC = " + returncode`,3)
 endif
 $brmsg(`"Line Number: " + linenum`,4)
 $brmsg(contact,5,"C")
 $brmsg("",7,"W",bg-text) 
end DisplayMSG

function CaseManager(CID,level) is x
 CID   is x
 level is x
 c.cm  is x
 c.2cm is x
 (void)$dbread(2,cid,c.cm, c.2cm)
 select level
  case "1" if c.cm dp
            CaseManager = c.cm
           else
		    CaseManager = ""		   
		   endif	
  case "2" if c.2cm dp
            CaseManager = c.2cm
		   else
		    CaseManager = ""		   		   
		   endif
  case other if c.2cm dp
              CaseManager = c.2cm
             elseif c.cm dp
              CaseManager = c.cm
             else
              CaseManager = ""
             endif
 endselect 
end CaseManager

function CaseManagers(CID)[] is x
 CID   is x
 c.cm  is x
 c.2cm is x
 (void)$dbread(2,cid,c.cm,c.2cm)
 if c.2cm dp and c.cm dp
  CaseManagers[1] = c.2cm
 endif
 if c.cm dp and c.2cm dp
  CaseManagers[2] = c.cm
 endif
 if c.cm dp and c.2cm !dp
  CaseManagers[1] = c.cm 
 endif
 if c.2cm dp and c.cm !dp
  CaseManagers[1] = c.2cm  
 endif
 if c.cm !dp and c.2cm !Dp
  $clear(CaseManagers[])
  CaseManagers[1] = ""
 endif
end CaseManagers

function PrnDemoFS() is null
 c.fn  is x
 c.mn  is x
 c.ln  is x
 c.bd  is d
 c.sex is x
 c.mar is x
 c.ssn is x
 c.race is x    'DCT 23
 age   is i
 age = ClientAge($regid)
%const sb3 "font-family:arial;font-size:10pt;color:black;font-weight:bold;"
 if $regid dp
  (void)$dbread(02, $regid, c.fn, c.mn, c.ln, c.bd, c.sex, c.mar, c.ssn, c.race)
  if c.bd !dp and $seg($regid,1,1) != "G"
   $brmsg("Client birthdate has not yet been entered, please update.",1,"W","Birthdate Missing")
  endif
  if c.bd >= $today and $seg($regid,1,1) != "G"
   $brmsg(`"Invalid birthdate, date is a future date: " + $castx(c.bd)`,1,"W","Birthdate Error")
  endif 
  $setstyle(".sb3", "font-family:arial", "font-size:10pt", "color:black", "font-weight:bold")
  $fieldset("Demographics",,"datatag")
   $table("Demographics",,"width='100%' cellspacing='0' cellpadding='0' bgcolor='#FFFFCC'")
    $row()
     $col()$text("First Name: ",,sb3)$text(c.fn)
    $row()
     $col()$text("Middle Name: ",,sb3)$text(c.mn)
    $row()
     $col()$text("Last Name: ",,sb3)$text(c.ln)
    $row()
     $col()$text("Birth Date: ",,sb3)$text(c.bd)
    $row()
     $col()$text("Age: ",,sb3) if c.bd >= $today
                                 $text(age,,"color: #00FF00;background-color: #000000")  
                                elseif c.bd !dp
                                 $text("N/A",,"color: red;background-color: #000000")  
                                else 
                                 $text(age)  
                                 endif 
    $row()
     $col()$text("Gender: ",,sb3)$text(c.sex)
    $row()
     $col()$text("SSN: ",,sb3)$text(c.ssn)
    $row()
     $col()$text("Marital Status: ",,sb3)$text($dct(28,c.mar))
    $row()
     $col()$text("Ethnicity: ",,sb3)$text($dct(23,c.race))
   $endtable("Demographics")
  $endfieldset()
 endif 
end PrnDemoFS

function PrnAddrFS() is null
 %include inc_C_AD_REC
%const sb3 "font-family:arial;font-size:10pt;color:black;font-weight:bold;"
 (void)$dbread(02, $regid, c_ad_rec_dstlist)
 $fieldset("Address",,"datatag")
  $table("address",,"width='100%' cellspacing='0' cellpadding='0' bgcolor='#FFFFCC'")
   $row()
    $col()$text("Address 1: ",,sb3)$text(c.addr1)
   $row()
    $col()$text("Address 2: ",,sb3)$text(c.addr2)
   $row()
    $col()$text("City: ",,sb3)$text(c.city)
   $row()
    $col()$text("State: ",,sb3)$text(c.state)
   $row()
    $col()$text("Zip Code: ",,sb3)$text(c.zip) 
   $row()
    $col()$text("County: ",,sb3)$text($dct(68,c.county,"D")) 
   $row()
    $col()$text("Telephone: ",,sb3)$text(c.tel)   	
   if c.tel.mobile dp
    $row()
	 $col()$text("Mobile Telephone: ",,sb3)$text(c.tel.mobile)
   endif
   if c.tel.mobile2 dp
    $row()
	 $col()$text("Mobile Telephone 2: ",,sb3)$text(c.tel.mobile2)   	
   endif
   if c.tel.work dp
    $row()
	 $col()$text("Work Telephone: ",,sb3)$text(c.tel.work)   	
   endif
   if c.tel.work2 dp
    $row()
	 $col()$text("Work Telephone2: ",,sb3)$text(c.tel.work2)   	
   endif 
  $endtable("address")
 $endfieldset()
end PrnAddrFS

function PrnPCorrFS() is null
 c.emercont  is h
 c.emername  is x
 c.emeraddr  is x
 c.emercity  is x
 c.emerrel   is x
 c.emerphon  is x
%const sb3 "font-family:arial;font-size:10pt;color:black;font-weight:bold;"
 (void)$dbread(02, $regid, c.emercont, c.emername, c.emeraddr, c.emercity, c.emerrel, c.emerphon,)
 $fieldset("Primary Correspondent",,"datatag")
  $table("PrimCorr",,"width='100%' cellspacing='0' cellpadding='0' bgcolor='#FFFFCC'")
   $row()
    $col()$text("Name: ",,sb3)$text(c.emername)
   $row()
    $col()$text("Address: ",,sb3)$text(c.emeraddr)
   $row()
    $col()$text("City, St, Zip: ",,sb3)$text(c.emercity)
   $row()
    $col()$text("Relation: ",,sb3)$text(c.emerrel)
   $row()
    $col()$text("Phone: ",,sb3)$text(c.emerphon) 
     $endtable("PrimCorr")
 $endfieldset()
end PrnPCorrFS

function PrnCaseFS() is null
 c.type          is x
 c.ru            is b
 c.2site         is b
 c.cm            is x
 c.2cm           is x
 s.type          is x
 c.fin.rvdt      is d
 c.adm.rec       is h
 c.adm.dt        is d
 c.adm.typ       is x
 c.dis.dt        is d
 c.liab          is n
 c.minfee        is x
 c.rp            is r 'responsible party record header
 c.rp.emp        is x 'responseible party employer
 c_cm            is x
 c_2cm           is x
 c_cm_type       is x
 c_2cm_type      is x
 finrvdt_lapse   is d
 days_to_finrvdt is i
 
 (void)$dbread(2,$regid, c.type, c.ru, c.2site, c.cm, c.2cm, c.fin.rvdt, c.adm.rec, c.adm.dt, 
                         c.adm.typ, c.dis.dt, c.liab, c.minfee, c.rp, c.rp.emp) 
 if c.fin.rvdt dp 
  finrvdt_lapse = c.fin.rvdt + 365
  days_to_finrvdt = finrvdt_lapse - $today
 endif
 if c.cm dp
  (void)$dbalpha(3, c.cm, c_cm)
  (void)$dbread(3,c.cm,s.type)
  c_cm_type = s.type
 else
  c_cm = "CM Not Assigned"
 endif 
 if c.2cm dp
  (void)$dbalpha(3, c.2cm, c_2cm)						   
  (void)$dbread(3,c.2cm,s.type)
  c_2cm_type = s.type
 else
  c_2cm = "N/A"
 endif 
%const sb3 "font-family:arial;font-size:10pt;color:black;font-weight:bold;"
if $today > 06/28/2010 then
 $fieldset("Case Information",,"datatag")
  $table("case",,"width='100%' cellspacing='0' cellpadding='0' bgcolor='#FFFFCC'")  
else
 $fieldset("Case Information - NEW!! Employer Information Added",,"datatag")
  $table("case",,"width='100%' cellspacing='0' cellpadding='0' bgcolor='#8AFB17'")  
endif
   $row()
    $col()$text("Primary CM: ",,sb3)$text(c_cm) if c_cm_type = "IS" 
                                                 $text(`" (" + c_cm_type + ")"`,,"color: #00FF00;background-color: #000000")
                                                endif	
   $row()
    $col()$text("Secondary CM: ",,sb3)$text(c_2cm) if c_2cm_type = "IS" 
                                                    $text(`" (" + c_2cm_type + ")"`,,"color: #00FF00;background-color: #000000")
                                                   endif	
   $row()
    $col()$text("Primary RU: ",,sb3)$text(c.ru)
   $row()
    $col()$text("Client Type: ",,sb3)$text(c.type)
   $row()
    $col()$text("Admit: ",,sb3)$text($dct(550, c.adm.typ))$text(c.adm.dt)
   $row()
    $col()$text("Last Financial Review: ",,sb3) if finrvdt_lapse <= $today
                                                 $text(c.fin.rvdt,,"color: #00FF00;background-color: #000000")
                                                else
                                                 $text(c.fin.rvdt)																	  
                                                endif 
   $row()
    $col()$text("Financial Review Lapse Date: ",,sb3) if finrvdt_lapse <= $today
                                                       $text(finrvdt_lapse)$text(`"  (" + days_to_finrvdt + " days)"`,,"color: #00FF00;background-color: #000000")
                                                      else
                                                       $text(finrvdt_lapse)$text(`"  (" + days_to_finrvdt + " days)"`)																				
                                                      endif 
   $row()
    $col()$text("Minimum Fee: ",,sb3)$text(c.minfee)
   $row()
    $col()$text("Maximum Fee: ",,sb3)$text(c.liab)
   $row()
    $col()$text("Employer/Support: ",,sb3)if c.rp.emp dp then
											   $text(c.rp.emp)
										  else $text("No Data Available")
										  endif
  $endtable("case")
 $endfieldset()
end PrnCaseFS

function PrnDXFS() is null
%const sb3 "font-family:arial;font-size:10pt;color:black;font-weight:bold;"
 dxdate is d
 dxdue  is d
 diag   is x
 diag2  is x
 dxtype is x
 dxcat  is x
 {"lib_COMMON2"}GETDX($regid, dxtype, diag, dxcat,dxdate,dxdue,diag2)
 $fieldset("Diagnosis",,"datatag")
  $table("dx",,"width='100%' cellspacing='0' cellpadding='0' bgcolor='#FFFFCC'")                   
  $row()$col() $text("Dx Date: ",,sb3) $text(dxdate)
  $row()$col() $text("Axis 1: ",,sb3)  $text(diag)$text($dct(400,diag,"D"))   
  $row()$col() $text("Axis 2: ",,sb3)  $text(diag2)$text($dct(401,diag2,"D"))	  
  $row()$col() $text("Expires: ",,sb3) if dxdue <= $today
                                        $text(dxdue,,"color: #00FF00;background-color: #000000")
                                       else
                                        $text(dxdue)
                                       endif 
  $endtable("dx")
 $endfieldset()      
end PrnDXFS

function Prn5SerFS(CID) is null
 cid        is x
 e_date[]   is d
 e_ser[]    is b
 e_staff[]  is x
 e_att[]    is x
 e_recip[]  is x
 e_start[]  is t
 e_cl_dur[] is t
 snapid[]   is x
 index      is i 
 s.fn       is x
 s.ln       is x
 if cid !dp
  cid = $regid
 endif 
%const sb3 "font-family:arial;font-size:10pt;color:black;font-weight:bold;"
 GETSVC(CID, e_date[], e_staff[], e_ser[], e_att[], e_cl_dur[], e_start[], e_recip[], 15, snapid[]) 
 $fieldset("Last 15 Services",,"datatag")
  $table("LAST15",,"border='1' width='100%' cellspacing='0' cellpadding='0' bgcolor='#FFFFCC'")
   $row()
    $col("center")$text("Date",,sb3)
    $col("center")$text("Staff",,sb3)
    $col("center")$text("Ser",,sb3)
    $col("center")$text("Att",,sb3)
    $col("center")$text("Rec",,sb3)
   index = 0
   if $maxarray(e_date[]) > 0
    do while index++ < $maxarray(e_date[])
	 (void)$dbread(3,e_staff[index], s.fn,s.ln)
     $row()
      $col("center") if snapid[index] = "NA" or snapid[index] !dp
	                  $text(e_date[index])
					 else
					  $bstyle("link","link")$uscwinbutton($castx(e_date[index]),"DISPLAYSNAP",$castx(e_date[index]),1024,768,snapid[index])
					 endif 
      $col("center")$text(e_staff[index])$text(" (")$text(s.fn)$text(" ")$text(s.ln)$text(")")
	  $col("center")$text(e_ser[index])$text(" (")$text($sam(e_ser[index]))$text(")")
      $col("center")$text(e_att[index])$text(" (") $text($dct(12,e_att[index])) $text(")")
      $col("center")$text(e_recip[index])$text(" (") $text($dct(11,e_recip[index])) $text(")")
    enddo
   else
    $row()
     $col(,,,"5")$text("No Services Found")
   endif
  $endtable("LAST15")
 $endfieldset()
end Prn5SerFS

'function PrnFsFS() is null
' c_el_fs[]    is b
' c_el_ef_dt[] is d
' c_el_id_1[]  is x
' c_el_id_2[]  is x
' index        is i
' {"lib_MEDICAL"}GETFS($regid, c_el_fs[], c_el_ef_dt[], c_el_id_1[], c_el_id_2[])
' %const sb3 "font-family:arial;font-size:10pt;color:black;font-weight:bold;"
' $fieldset("Fund Sources",,"datatag")
'  $table("FS", ,"border='1' width = '100%' cellspacing='0' cellpadding='0' bgcolor='FFFFCC'")	 
'   $row()
'    $col("center")$text("Fund Source",,sb3)
'    $col("center")$text("Eff Date",,sb3)
'    $col("center")$text("ID # 1",,sb3)
'    $col("center")$text("ID # 2",,sb3)
'    index = 0
'    if $maxarray(c_el_fs[]) > 0
'     do while index++ < $maxarray(c_el_fs[])
'      $row()
'       $col("center")$text(c_el_fs[index])$text($fs(c_el_fs[index], "D"))
'       $col("center")$text(c_el_ef_dt[index])
'       $col("center")$text(c_el_id_1[index])
'       $col("center") if c_el_id_2[index] dp
'                       $text(c_el_id_2[index])
'                      else
'                       $ctag("&nbsp;")
'                      endif
'     enddo
'    else
'     $row()
'      $col(,,,"4") $text("No Open Fund Sources")
'    endif
'  $endtable("FS")
' $endfieldset()
'end PrnFsFS

function PrnFsFS() is null
 c_el_fs[]         is b  'CLIENT FS NUMBER
 c_el_ef_dt[]      is d  'CLIENT FS DATE
 c_el_id_1[]       is x  'CLIENT FS ELIG ID 1
 c_el_id_2[]       is x  'CLIENT FS ELIG ID 2
 c_eg_insrc[]      is x  'FS Relationship to Insured array
 c_eg_insln[]      is x	'FS Insured Last Name array
 c_eg_insfn[]      is x	'FS Insured First Name Name array
 c_eg_insbd[]      is d	'FS Insured BirthDate array
 c_eg_inssx[]      is x	'FS Insured Gender array
 c_eg_icn[]        is x	'FS Insurance Company Name array
 c_eg_iadd1[]      is x	'FS Insurance Address 1 array
 c_eg_iadd2[]      is x	'FS Insurance Address 2 array
 c_eg_icity[]      is x	'FS Insurance City array
 c_eg_ist[]        is x	'FS Insurance State array
 c_eg_izip[]       is x	'FS Insurance Zip array
 c_eg_iph[]        is x	'FS Insurance Phone array
 el_cont[]         is x
 c_el_qmb[]				 is x 'QMB or MQMB
 index            is i


 %const sb3 "font-family:arial;font-size:10pt;color:black;font-weight:bold;"
 %const sb2 "font-family:arial;font-size:8pt;color:black;font-weight:normal;"

 {"lib_MEDICAL"}GETFS($regid, c_el_fs[], c_el_ef_dt[], c_el_id_1[], c_el_id_2[], c_eg_insrc[], c_eg_insln[], c_eg_insfn[], c_eg_insbd[], c_eg_inssx[], c_eg_icn[], c_eg_iadd1[], c_eg_iadd2[], c_eg_icity[], c_eg_ist[], c_eg_izip[], 
                              c_eg_iph[], el_cont[],c_el_qmb[])


 $fieldset("Fund Sources",,"datatag")
  $table("fs", ,"border='1' width = '100%' cellspacing='0' cellpadding='0' bgcolor='FFFFCC'")	 
  $row()
   $col("center")$text("Fund Source",,sb3)
   $col("center")$text("Eff Date",,sb3)
   $col("center")$text("ID # 1",,sb3)
   $col("center")$text("ID # 2",,sb3)
   $col("center")$text("Insurance Company",,sb3)
   $col("center")$text("Insurance Address",,sb3)
   $col("center")$text("Insurance Phone",,sb3)
   $col("center")$text("Client Relation",,sb3)$br()$text("to Insured",,sb3)
   $col("center")$text("Insured Name",,sb3)
   $col("center")$text("Insured DOB",,sb3)$br()$text("and Gender",,sb3)
   index = 0
   if $maxarray(c_el_fs[]) > 0
    do while index++ < $maxarray(c_el_fs[])
     $row()
      $col("center")$text(c_el_fs[index],,sb2)$text($fs(c_el_fs[index], "D"),,sb2)
      $col("center")$text(c_el_ef_dt[index],,sb2)
      $col("center")if c_el_id_1[index] dp
	                 $text(c_el_id_1[index],,sb2)
					else
					 $ctag("&nbsp;")
					endif 
      $col("center") if c_el_id_2[index] dp
                      $text(c_el_id_2[index],,sb2)
                     elseif (c_el_fs[index] = 13 or c_el_fs[index] = 210) and c_el_qmb[index] !dp
                      $text(c_el_qmb[index],,sb2)
                     else
                      $ctag("&nbsp;")
                     endif
 'Don't show Relation, Name, DOB, Gender Ins Co, Ins Add, or Ins Ph if FS != 2
     if c_el_fs[index] = 2 or c_el_fs[index] = 14 or c_el_fs[index] = 210 or c_el_fs[index] = 200 or c_el_fs[index] = 220 
      $col("center")if c_eg_icn[index] dp
	                 $text(c_eg_icn[index],,sb2)
					elseif el_cont[index] dp
					 (void)$dbalpha(12,el_cont[index],el_cont[index])
					 $text(el_cont[index],,sb2)
					else
					 $ctag("&nbsp;")
					endif 
      $col()$text(c_eg_iadd1[index],,sb2)$br()
            if c_eg_iadd2[index] dp
             $text(c_eg_iadd2[index],,sb2)$br()
            endif
            if c_eg_icity[index] dp
			 $text(c_eg_icity[index],,sb2)$text(", ",,sb2)$text(c_eg_ist[index],,sb2)$ctag("&nbsp;")$text(c_eg_izip[index],,sb2)
            endif
	  $col("center")$text(c_eg_iph[index],,sb2)
      $col("center")$text($dct(822,c_eg_insrc[index],"D"),,sb2)
	  if c_eg_insrc[index] != "18"
       $col("center")$text(c_eg_insfn[index],,sb2)$text(" ",,sb2)$text(c_eg_insln[index],,sb2)
       $col("center")$text(c_eg_insbd[index],,sb2)$br()$text(c_eg_inssx[index],,sb2)
      else
       $col("center")$ctag("&nbsp;")
       $col("center")$ctag("&nbsp;")			
      endif
     else
      $col("center")$ctag("&nbsp;")
      $col("left")  $ctag("&nbsp;")
      $col("center")$ctag("&nbsp;")
      $col("center")$ctag("&nbsp;")
      $col("center")$ctag("&nbsp;")
      $col("center")$ctag("&nbsp;")
     endif
    enddo
   else
    $row()
    $col(,,,"10") $text("No Open Fund Sources")
   endif
  $endtable("fs")
 $endfieldset()
end PrnFsFS

function PrnUAFS() is null
 {"lib_COMMON2"}PrnUAFS()
end PrnUAFS

function PrnPreFS() is null
 p_date[]    is d
 p_rxmed[]   is x
 p_dose[]    is x
 p_stength[] is x
 p_rxdue[]   is d
  p_days[]   is b
 parm[]      is x
 index       is i
 {"lib_MEDICAL"}GETRX($regid, p_date[], p_rxmed[], p_stength[], p_dose[], p_rxdue[], p_days[])
 %const sb3 "font-family:arial;font-size:10pt;color:black;font-weight:bold;" 
 $fieldset("Active Prescriptions",,"datatag")
  $table("ACTIVERX",,"border='1' width='100%' cellspacing='0' cellpadding='0' bgcolor='#FFFFCC'")
   $row()
    $col("center")$text("RX Date",,sb3)
    $col("center")$text("Med",,sb3)
    $col("center")$text("Str",,sb3)
    $col("center")$text("Dose",,sb3)
    $col("center")$text("Next Due",,sb3)
    index = 0
    if $maxarray(p_rxmed[]) > 0
     do while ++index <= $maxarray(p_date[])
      $row()
       $col("center")$text(p_date[index])
       $col("center")$text(p_rxmed[index])
       $col("center")$text(p_stength[index])
       $col("center")$text(p_dose[index])
       $col("center")$text(p_rxdue[index])
    enddo
    else
    $row()
    $col(,,,"5") $text("No Active Prescriptions")
    endif
  $endtable("ACTIVERX")
 $endfieldset()		  
end PrnPreFS

function PrnAcctFS() is null
 current  is n
 previous is n
 credits  is n
 payments is n
 {"lib_MEDICAL"}GETBALANCE($regid, current, previous, credits, payments)   
 %const sb3 "font-family:arial;font-size:10pt;color:black;font-weight:bold;" 
 $fieldset("Account Balance",,"datatag")
  $table("account",,"width='100%' cellspacing='0' cellpadding='0' bgcolor='#FFFFCC'")
   $row()
    $col()$text("Current Month Charges: ",,sb3)$text($format(current, "$LZ,ZZZ,ZZ9.99-"))
   $row()
    $col()$text("Balance Forward: ",,sb3)$text($format(previous, "$LZ,ZZZ,ZZ9.99-"))
   $row()
    $col()$text("Current Month Payments: ",,sb3)$text($format(payments, "$LZ,ZZZ,ZZ9.99-"))
  $endtable("account")
 $endfieldset()
end PrnAcctFS

function PrnAdmitFS() is null
 c_adm_dt[]  is d
 c_dis_dt[]  is d
 c_adm_typ[] is x
 c_adm_acu[] is x
 c_dis_rea[] is x
 index       is i
 {"lib_MEDICAL"}GETADMHX($regid, c_adm_dt[], c_dis_dt[], c_adm_typ[], c_adm_acu[], c_dis_rea[])
 %const sb3 "font-family:arial;font-size:10pt;color:black;font-weight:bold;" 
 $fieldset("Admission History",,"datatag")
  $table("ADM", ,"border='1' width = '100%' cellspacing='0' cellpadding='0' bgcolor='FFFFCC'")	 
   $row()
    $col("center")$text("Admit Date",,sb3)
    $col("center")$text("Disc Date",,sb3)
    $col("center")$text("Admit Type",,sb3)
    $col("center")$text("Admit Acuity",,sb3)                       
    $col("center")$text("Disc Reason",,sb3)                       
    index = 0
    if $maxarray(c_adm_dt[]) > 0
     do while ++index <= $maxarray(c_adm_dt[])
      $row()
       $col("center")$text(c_adm_dt[index])
       $col("center")if c_dis_dt[index] dp
	                  $text(c_dis_dt[index])
 					 else
					  $ctag("&nbsp;") 
					 endif 					  
       $col("center")if c_adm_typ[index] dp
	                  $text(c_adm_typ[index])
					 else
					  $ctag("&nbsp;") 
					 endif 
       $col("center")if c_adm_acu[index] dp
	                  $text(c_adm_acu[index])
					 else
					  $ctag("&nbsp;") 
					 endif	   
       $col("center")if  c_dis_rea[index] dp
	                  $text(c_dis_rea[index])
					 else
					  $ctag("&nbsp;") 
					 endif	   
     enddo
    else
     $row()
      $col(,,,"4") $text("No Prior Admission History")
    endif
  $endtable("ADM")
 $endfieldset()
end PrnAdmitFS

function PrnInsFS() is null
 c_insurnce[] is d
 c_ins#[]      is x
 c_insaddrs[]  is x
 c_insadrs2[]  is x
 c_insplcy#[]  is x
 c_insgrp#[]   is x
 c_policynm[]  is x
 c_insefdte[]  is d
 c_medicare[]  is x
 c_medicaid[]  is x
 c_pan[]       is x 
 c_insmqmb[]   is x
 c_insothbd[]  is d
 c_insothsx[]  is x
 c_insm_m[]    is x
 c_ins_tel[]   is x
 index         is i
 GetInsurance(c_insurnce[], c_ins#[], c_insaddrs[], c_insadrs2[], c_insplcy#[], c_insgrp#[], c_policynm[], c_insefdte[], c_medicare[], c_medicaid[], c_pan[], c_insmqmb[], c_insothbd[], c_insothsx[], c_insm_m[], c_ins_tel[])
 %const sb3 "font-family:arial;font-size:10pt;color:black;font-weight:bold;" 

 $fieldset("Insurance",,"datatag")
  $table("INSURANCE", ,"border='1' width = '100%' cellspacing='0' cellpadding='0' bgcolor='FFFFCC'")
   $row()
    $col()$text("Insurance Number",,sb3)
	$col()$text("Policy Holder Name",,sb3)	 
	$col()$text("Address",,sb3)	 
	$col()$text("Phone Numbers",,sb3)	 
	$col()$text("Policy #",,sb3)	 
	$col()$text("Group #",,sb3)	 
	$col()$text("Effective Date",,sb3)	 
	$col()$text("Medicare",,sb3)	 
	$col()$text("Medicaid",,sb3)	 
    index = 0
	do while index++ < $maxarray(c_insurnce[])
     $row()
      $col()$text(c_ins#[index])
	  $col()$text(c_policynm[index])
	  $col()$text(c_insaddrs[index])
	        $br()$text(c_insadrs2[index])
	  $col()if c_ins_tel[index] dp
	         $text(c_ins_tel[index])
			else
			 $ctag("&nbsp;")
			endif
	  $col()if c_insplcy#[index] dp
	         $text(c_insplcy#[index])
			else
			 $ctag("&nbsp;") 
			endif 
	  $col()if c_insgrp#[index] dp
	         $text(c_insgrp#[index])
			else
			 $ctag("&nbsp;")
			endif
	  $col()if c_insefdte[index] dp
	         $text(c_insefdte[index])
			else
			 $ctag("&nbsp;")
			endif
	  $col()if c_medicare[index] dp
	         $text(c_medicare[index])
			else
			 $ctag("&nbsp;")
			endif
	  $col()if c_medicaid[index] dp
	         $text(c_medicaid[index])
			else
			 $ctag("&nbsp;")
			endif
	enddo
  $endtable("INSURANCE")
 $endfieldset()
end PrnInsFS

function GetInsurance(c_insurnce[], c_ins#[], c_insaddrs[], c_insadrs2[], c_insplcy#[], c_insgrp#[], c_policynm[], c_insefdte[], c_medicare[], c_medicaid[], c_pan[], c_insmqmb[], c_insothbd[], c_insothsx[], c_insm_m[], c_ins_tel[]) is null
 c.insurnce    is h
 c.ins#        is x
 c.insaddrs    is x
 c.insadrs2    is x
 c.insplcy#    is x
 c.insgrp#     is x
 c.policynm    is x
 c.insefdte    is d
 c.medicare    is x
 c.medicaid    is x
 c.pan         is x
 c.insmqmb     is x
 c.insothbd    is d
 c.insothsx    is x
 c.insm.m      is x
 c.ins.tel     is x
 c_insurnce[] is d
 c_ins#[]      is x
 c_insaddrs[]  is x
 c_insadrs2[]  is x
 c_insplcy#[]  is x
 c_insgrp#[]   is x
 c_policynm[]  is x
 c_insefdte[]  is d
 c_medicare[]  is x
 c_medicaid[]  is x
 c_pan[]       is x 
 c_insmqmb[]   is x
 c_insothbd[]  is d
 c_insothsx[]  is x
 c_insm_m[]    is x
 c_ins_tel[]   is x
 (void)$dbreadtoarray(2,$regid,c.insurnce, c.ins#, c.insaddrs, c.insadrs2, c.insplcy#, c.insgrp#, c.policynm, c.insefdte, c.medicare, c.medicaid, c.pan, c.insmqmb, c.insothbd, c.insothsx, c.insm.m, c.ins.tel,
                               c_insurnce[],, c_ins#[],, c_insaddrs[],, c_insadrs2[],, c_insplcy#[],, c_insgrp#[],, c_policynm[],, c_insefdte[],, c_medicare[],, c_medicaid[],, c_pan[],, c_insmqmb[],, c_insothbd[],, c_insothsx[],, c_insm_m[],, c_ins_tel[])




































































































































































































































































































































































 $allowupdate(c_insurnce[], c_ins#[], c_insaddrs[], c_insadrs2[], c_insplcy#[], c_insgrp#[], c_policynm[], c_insefdte[], c_medicare[], c_medicaid[], c_pan[], c_insmqmb[], c_insothbd[], c_insothsx[], c_insm_m[], c_ins_tel[]) 							  
end GetInsurance

function VeteranCPT_YN(CID) is x
 CID       is x
 yes_btn   is x
 no_btn    is x
 c.cpt.vet is x
 rc        is i
 if DX_AXI_YN(CID, "309.81") = "Y"  and clientage(CID) > 17
  $submitopt("off", "YES")
  $cancelopt("off", "NO")
  $form($funcname)
  $bstyle("buttondown","button")
   $tag("<center>")
    $br(3)$text("Veterns CPT","H1")
    $br(2)$text("Will this client receive any Veterns CPT Services? ","datatag")
    $br(2)$submit(yes_btn,"YES")$ctag("&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;")$submit(no_btn,"NO")
   $tag("</center>")  
  $sendform($funcname) 
  if $endbutton = "SUBMIT" or yes_btn = "Y"
   VeteranCPT_YN = "Y"
   $dblock()
   (void)$dbread(2,CID,c.cpt.vet)
   c.cpt.vet = "Y"
   (void)$dbupdate(2,CID,c.cpt.vet)   
  else
   VeteranCPT_YN = "N"
   $dblock()
   (void)$dbread(2,CID,c.cpt.vet)
   c.cpt.vet = "N"
   (void)$dbupdate(2,CID,c.cpt.vet)   
  endif
 endif
end VeteranCPT_YN

'old type
function VeternCPT_YN(CID) is x
 CID is x
 VeternCPT_YN = VeteranCPT_YN(CID)
end VeternCPT_YN

function DX_AXI_YN(CID, dx) is x
 CID       is x
 dx        is x
 Axis[]    is x
 %include inc_DX
 (void)$dbread(2,CID, c.dsmiiir, c.diag, c.dxaxi2, c.dxaxi3, c.dxaxi4, c.dxaxi5, c.dxaxi6)
 Axis[1] = c.diag
 Axis[2] = c.dxaxi2
 Axis[3] = c.dxaxi3
 Axis[4] = c.dxaxi4
 Axis[5] = c.dxaxi5
 Axis[6] = c.dxaxi6
 if $find(dx, Axis[],1,"F") != 0
  DX_AXI_YN = "Y"
 else
  DX_AXI_YN = "N"
 endif
end DX_AXI_YN

function DX_AXII_YN(CID, dx) is x
 CID       is x
 dx        is x
 c.dsmiiir is h
 c.dxaxii1 is x 'AXIS II LEVEL 1
 c.dxaxii2 is x 'AXIS II LEVEL 2
 c.dxaxii3 is x 'AXIS II LEVEL 3
 c.dxaxii4 is x 'AXIS II LEVEL 4
 c.dxaxii5 is x 'AXIS II LEVEL 5
 c.dxaxii6 is x 'AXIS II LEVEL 6
 Axis[]    is x
 (void)$dbread(2,CID, c.dsmiiir, c.dxaxii1, c.dxaxii2, c.dxaxii3, c.dxaxii4, c.dxaxii5, c.dxaxii6)
 Axis[1] = c.dxaxii1
 Axis[2] = c.dxaxii2
 Axis[3] = c.dxaxii3
 Axis[4] = c.dxaxii4
 Axis[5] = c.dxaxii5
 Axis[6] = c.dxaxii6
 if $find(dx, Axis[],1,"F") != 0
  DX_AXII_YN = "Y"
 else
  DX_AXII_YN = "N"
 endif
end DX_AXII_YN

function DX_AXIII_YN(CID, dx) is x
 CID        is x
 dx         is x
 c.dsmiiir  is h
 c.dxaxiii1 is x 'AXIS III LEVEL 1
 c.dxaxiii2 is x 'AXIS III LEVEL 2
 c.dxaxiii3 is x 'AXIS III LEVEL 3
 c.dxaxiii4 is x 'AXIS III LEVEL 4
 c.dxaxiii5 is x 'AXIS III LEVEL 5
 c.dxaxiii6 is x 'AXIS III LEVEL 6
 Axis[]    is x
 (void)$dbread(2,CID, c.dsmiiir, c.dxaxiii1, c.dxaxiii2, c.dxaxiii3, c.dxaxiii4, c.dxaxiii5, c.dxaxiii6)
 Axis[1] = c.dxaxiii1
 Axis[2] = c.dxaxiii2
 Axis[3] = c.dxaxiii3
 Axis[4] = c.dxaxiii4
 Axis[5] = c.dxaxiii5
 Axis[6] = c.dxaxiii6
 if $find(dx, Axis[],1,"F") != 0
  DX_AXIII_YN = "Y"
 else
  DX_AXIII_YN = "N"
 endif
end DX_AXIII_YN

'Wesley Williams
dynamic function LoadJSLib(sLibname) is null 
 sLibname is x 
 select $uc(sLibname)
'  case "JQUERY" or !dp 
'   $ctag("<SCRIPT type='text/javascript' src='/cmhcbui/cmhcbuilocal/javascript/jquery-1.4.2.min.js'></SCRIPT>")
'  case "FLOT" $ctag("<!--[if IE]><SCRIPT type='text/javascript' src='/cmhcbui/cmhcbuilocal/javascript/excanvas.min.js'></SCRIPT><![endif]-->")
'   $ctag("<SCRIPT type='text/javascript' src='/cmhcbui/cmhcbuilocal/javascript/jquery-1.4.2.min.js'></SCRIPT>")
'   $ctag("<SCRIPT type='text/javascript' src='/cmhcbui/cmhcbuilocal/javascript/jquery.flot.min.js'></SCRIPT>")
'  endselect 
  case "JQUERY" or !dp
   $ctag("<SCRIPT type='text/javascript' src='/cmhcbui/cmhcbuilocal/javascript/jquery-1.4.2.min.js'></SCRIPT>")
  case "FLOT"
   $ctag("<!--[if IE]><SCRIPT type='text/javascript' src='/cmhcbui/cmhcbuilocal/javascript/excanvas.min.js'></SCRIPT><![endif]-->")
   $ctag("<SCRIPT type='text/javascript' src='/cmhcbui/cmhcbuilocal/javascript/jquery-1.4.2.min.js'></SCRIPT>")
   $ctag("<SCRIPT type='text/javascript' src='/cmhcbui/cmhcbuilocal/javascript/jquery.flot.min.js'></SCRIPT>")
  case "FLOTUI"
   $ctag("<link type='text/css' href='/cmhcbui/cmhcbuilocal/styles/jquery-ui-1.8.13.custom.css' rel='Stylesheet' />")
   $ctag("<!--[if IE]><SCRIPT type='text/javascript' src='/cmhcbui/cmhcbuilocal/javascript/excanvas.min.js'></SCRIPT><![endif]-->")
   $ctag("<SCRIPT type='text/javascript' src='/cmhcbui/cmhcbuilocal/javascript/jquery-1.4.2.min.js'></SCRIPT>")
   $ctag("<SCRIPT type='text/javascript' src='/cmhcbui/cmhcbuilocal/javascript/jquery-ui-1.8.13.custom.min.js'></SCRIPT>")
   $ctag("<SCRIPT type='text/javascript' src='/cmhcbui/cmhcbuilocal/javascript/jquery.flot.min.js'></SCRIPT>")
  case "UI"
   $ctag("<link type='text/css' href='/cmhcbui/cmhcbuilocal/styles/jquery-ui-1.8.13.custom.css' rel='Stylesheet' />")
   $ctag("<SCRIPT type='text/javascript' src='/cmhcbui/cmhcbuilocal/javascript/jquery-1.4.2.min.js'></SCRIPT>")
   $ctag("<SCRIPT type='text/javascript' src='/cmhcbui/cmhcbuilocal/javascript/jquery-ui-1.8.13.custom.min.js'></SCRIPT>")
  case "FLOTUIMTS"
   $ctag("<link type='text/css' href='/cmhcbui/cmhcbuilocal/styles/jquery-ui-1.8.13.custom.css' rel='Stylesheet' />")
   $ctag("<!--[if IE]><SCRIPT type='text/javascript' src='/cmhcbui/cmhcbuilocal/javascript/excanvas.min.js'></SCRIPT><![endif]-->")
   $ctag("<SCRIPT type='text/javascript' src='/cmhcbui/cmhcbuilocal/javascript/jquery-1.4.2.min.js'></SCRIPT>")
   $ctag("<SCRIPT type='text/javascript' src='/cmhcbui/cmhcbuilocal/javascript/jquery-ui-1.8.13.custom.min.js'></SCRIPT>")
   $ctag("<SCRIPT type='text/javascript' src='/cmhcbui/cmhcbuilocal/javascript/jquery.flot.min.js'></SCRIPT>")
  case "UIMTS"
   $ctag("<link type='text/css' href='/cmhcbui/cmhcbuilocal/styles/jquery-ui-1.8.13.custom.css' rel='Stylesheet' />")
   $ctag("<SCRIPT type='text/javascript' src='/cmhcbui/cmhcbuilocal/javascript/jquery-1.4.2.min.js'></SCRIPT>")
   $ctag("<SCRIPT type='text/javascript' src='/cmhcbui/cmhcbuilocal/javascript/jquery-ui-1.8.13.custom.min.js'></SCRIPT>")
  case "GROUP"
   $ctag("<link type='text/css' href='/cmhcbui/cmhcbuilocal/styles/jquery-ui-1.8.13.custom.css' rel='Stylesheet' />")
   $ctag("<!--[if IE]><SCRIPT type='text/javascript' src='/cmhcbui/cmhcbuilocal/javascript/excanvas.min.js'></SCRIPT><![endif]-->")
   $ctag("<SCRIPT type='text/javascript' src='/cmhcbui/cmhcbuilocal/javascript/jquery-1.4.2.min.js'></SCRIPT>")
   $ctag("<SCRIPT type='text/javascript' src='/cmhcbui/cmhcbuilocal/javascript/jquery-ui-1.8.13.custom.min.js'></SCRIPT>")
   $ctag("<SCRIPT type='text/javascript' src='/cmhcbui/cmhcbuilocal/javascript/jquery.tablesorter.min.js'></SCRIPT>")
 endselect
end LoadJSLib

function HCS_CM(clientid, evdate) is x
 
 c.ipchcs.rec    is header   'IPCHCS RECORD HEADER DST
 c.ipchcs.eff    is date     'IPCHCS EFFECTIVE DATE DST
 c.ipchcs.end    is date     'IPCHCS END DATE DST
 evdate          is date     'Date to check
 clientid   		 is x
 rc         	   is b
 switch     		 is b

 switch     = 0
 
'If the evdate value is not passed to this function, default it to $today
 if evdate !dp
 	evdate = $today
 endif
 
 rc = $dbread(02, clientid, c.ipchcs.rec, c.ipchcs.eff, c.ipchcs.end)
 do while rc < 2 and switch = 0
  if c.ipchcs.eff <= evdate and c.ipchcs.end >= evdate
      switch = 1
  endif
  rc = $dbreadnextdst(02, clientid, c.ipchcs.rec, c.ipchcs.eff, c.ipchcs.end)
 enddo
 if switch = 1
  HCS_CM = "Y"
 else
  HCS_CM = "N" 
 endif
end HCS_CM

dynamic function Prn5Pe() is null
%const sb3 "font-family:arial;font-size:10pt;color:black;font-weight:bold;"
 client           is x	'Client id
 s.type           is x
 P.DATE           is d	'Planned Event date
 P.STAFF          is x	'Planned Event staff
 P.CL             is x	'Planned Event case #
 P.SAM            is b	'Planned Event service
 P.TIME           is t	'Planned Event start time
 P.RU             is b	'Planned Event RU
 P.DESC           is x   'Planned Event Description

 p_date[]         is d	'Planned Event date array variable
 p_staff[]        is x	'Planned Event staff array variable
 p_staffname      is x	'Planned Event staff array variable
 e_cl[]           is x	'Planned Event case # array variable
 p_sam[]          is b	'Planned Event service array variable
 p_time[]         is t	'Planned Event start time array variable
 p_ru[]           is b	'Planned Event RU array variable
 p_desc[]         is x   'Planned Plan event Description array variable

 found            is n	'Array subscript
 rc               is b	'Return code
 descsame         is x   'Is the PE Desc the same as the SAM Description
 index            is i
 description      is x
 bgcolor          is x

 description = "Next 5 Appointments"
 bgcolor     = "#FFFFCC"
 
 $clear(p_date[], p_staff[], e_cl[], p_sam[], p_time[], p_ru[], p_desc[])
 (void)$startpe(,$regid, $today)
 rc = $readnextpe(P.DATE, P.STAFF, P.CL, P.SAM, P.TIME, P.RU, P.DESC)
 (void)$dbread(3,p.staff,s.type)
'See if there are any planned events at all.
 if rc = 0
  found = 0 
  do while rc < 1 and found < 5
   if s.type = "AS"
    (void)$arrpush(p_date[], P.DATE)  
    (void)$arrpush(p_staff[],P.STAFF) 
    (void)$arrpush(e_cl[], P.CL)      
    (void)$arrpush(p_sam[], P.SAM)    
    (void)$arrpush(p_time[], P.TIME)  
    (void)$arrpush(p_ru[], P.RU)      
    (void)$arrpush(p_desc[], P.DESC)  
    found++
   endif
   rc = $readnextpe(P.DATE, P.STAFF, P.CL, P.SAM, P.TIME, P.RU, P.DESC)
   (void)$dbread(3,p.staff,s.type)
  enddo
 endif

 if found = 0
  $clear(p_date[], p_staff[], e_cl[], p_sam[], p_time[], p_ru[], p_desc[])
 endif

 if $today < 6/28/2010
  bgcolor = "#8AFB17"
  description = "Next 5 Appointments - NEW!!"
 endif

 $fieldset(description,,"datatag")
  $table("NEXT5",,`"border='1' width='100%' cellspacing='0' cellpadding='0' bgcolor='" + bgcolor + "'"`)
   $row()
    $col("center")$text("Date",,sb3)
    $col("center")$text("Time",,sb3)
    $col("center")$text("Staff ID",,sb3)
    $col("center")$text("Staff Name",,sb3)
    $col("center")$text("Service Cd",,sb3)
    $col("center")$text("Service Description",,sb3)
   index = 0
   if $maxarray(p_date[]) > 0
    do while index++ < $maxarray(p_date[])	
	 (void)$dbalpha(3,p_staff[index],p_staffname)
     $row()
      $col("center")$text(p_date[index])
      $col("center")$text(p_time[index])
      $col("center")$text(p_staff[index])
      $col("center")$text(p_staffname)	  
      $col("center")$text(p_sam[index])
	if $seg($sam(p_sam[index]),1,24) = $seg(p_desc[index],1,24)
      $col("center")$text(p_desc[index])
	else
      $col("center")$text($sam(p_sam[index]))$br()$text(p_desc[index])
	endif
    enddo
   else
    $row()
     $col(,,,"6")$text("No Appointments Found")
   endif
  $endtable("NEXT5")
 $endfieldset()
end Prn5PE

'pass the staff ID and the function returns the staff members full name in camel case 
dynamic function setStaffName(id) is x
 id   is x
 s.fn is x 
 s.ln is x 	
 (void)$dbread(3, id, s.fn, s.ln)
 setStaffName = $nc(s.fn) + " " + $nc(s.ln)
end setStaffName

'pass a client ID and the function returns the clients full name in camel case
dynamic function setClientName(id) is x
 id   is x 
 c.fn is x 
 c.ln is x 	
 (void)$dbread(2,id, c.fn, c.ln)
 setClientName = $nc(c.fn) + " " + $nc(c.ln)
end setClientName

'pass a client ID and the function returns the clients First and Last Initial
dynamic function setClientInitial(id) is x
 id   is x 
 c.fn is x 
 c.ln is x 	
 (void)$dbread(2,id, c.fn, c.ln)
 setClientInitial = $left(c.fn,1) + "." + $left(c.ln,1) + "."
end setClientInitial


'returns array of ID's for active cpc's
dynamic function activeCPC(CPCid[]) is null	
 param[]    is x
 cri[]      is x
 output[]   is x
 CPCid[]    is x
 rc1        is x
 msg_string is x
 param[1] = "DST# 0105"    's.type
 param[2] = "DST# 0562"    's.cpc.stf	
 $searchparm(param[])
 rc1 = $searchinit()
 if rc1 = 0 
  cri[1] = "AS"
  cri[2] = "Y" 
  rc1 = $search(cri[],,,,output[])		
  if rc1 > 0 
   msg_string = "activeCPC $search did not complete return code:  " + rc1
   $brmsg(msg_string,1,"WC")
  elseif rc1 = 0 			
   CPCid[] = output[]
  endif
 else
  msg_string = "activeCPC $searchparm did not complete:  " + rc1
  $brmsg(msg_string,1,"C")
  $brmsg($errmsg,2,"WC",)
 endif
 $allowupdate(CPCid[])
end activeCPC

'returns array of ID's for active cpc's
dynamic function rInactiveCPC(CPCid[]) is null	
 param[]    is x
 cri[]      is x
 output[]   is x
 CPCid[]    is x
 rc1        is x
 msg_string is x
 startDate  is d
 endDate    is d
 ds         is x
 startDate = $today - 90
 endDate = $today 
 ds = x"22" + startDate + "-" + endDate + x"22"
 ds = "7/01/2010"	
 param[1] = "DST# 0105"  's.type
 param[2] = "EFFD 0105"  's.type[effd]
 param[3] = "DST# 0562"  's.cpc.stf	
 $searchparm(param[])
 rc1 = $searchinit()
 if rc1 = 0
  cri[1] = "IS"
  cri[2] = ">=" + ds
  cri[3] = "Y"
  rc1 = $search(cri[],,,,output[])		
  if rc1 > 1 
   msg_string = "recent inactiveCPC $search did not complete return code:  " + rc1
   $brmsg(msg_string,1,"C")
   $brmsg($errmsg,2,"WC",)
  elseif rc1 = 0 			
   CPCid[] = output[]
  endif
 else
  msg_string = "recent inactiveCPC $searchparm did not complete:  " + rc1
  $brmsg(msg_string,1,"C")
  $brmsg($errmsg,2,"WC",)
 endif
 $allowupdate(CPCid[])
end rInactiveCPC

'Pass array of staff ID's and function returns the locations
dynamic function staffLocation(CPCid[], wloc[]) is null
 CPCid[]    is x	'cpc id array 
 rc1        is x    'return code
 wloc[]     is x	'work location array 
 x          is i 	'counter 
 s.pos.no   is x 	'staff position number
 s.pos.rerc is h 	'staff position rec
 p.wloc     is x	'position work location 
 x = 0
 do while x++ < $maxarray(CPCid[])
  rc1 = $dbread(3,CPCid[x], s.pos.rerc, s.pos.no)
  if rc1 = 0
   rc1 = $dbread(50, s.pos.no, p.wloc)
   if rc1 = 0 
    rc1 = $arrPush(wloc[], p.wloc)
   else 
    rc1 = $arrPush(wloc[], "WF2")
   endif
  else
   rc1 = $arrPush(wloc[], "WF2")
  endif	
 enddo
 $allowupdate(wloc[])'return array results 	
end staffLocation

'pass location code and location description array.  Updates both arrays with locations that 
'have valid CPC's assigned
dynamic function locationList(loc_code[], loc_desc[], rIA) is null
 loc_code[]    is x
 loc_desc[]    is x
 CPCloc_code[] is x  
 CPCid[]       is x 
 rIACPCid[]    is x 
 rIA           is x 		'recent inactive CPC's	
 rc1           is x
 x             is i
 msg_string    is x
 string        is x  
 CPCid[1] = 1 
 activeCPC(CPCid[])
 if rIA dp 
  rInactiveCPC(rIACPCid[])
  rc1 = $arraymerge(CPCid[], rIACPCid[])
  rc1 = $sort(CPCid[])
 endif 
 staffLocation(CPCid[], CPCloc_code[])
 rc1 = $sort(loc_code[], loc_desc[])
 rc1 = $sortu(CPCloc_code[])
 x = 0
 do while x < $maxarray(loc_code[])
  rc1 = $bsrch(loc_code[x], CPCloc_code[], "FF")
  if rc1 = 0 
   rc1 = $arrRemove(loc_code[x],1, loc_desc[])
  else 
   x++
  endif			
 enddo	
 $allowupdate(loc_code[], loc_desc[])
end locationList

' pass the location and get two array's containing active cpc's that are assigned to that location 
dynamic function filterByLoc(loc, fidList[], nameList[], rIA) is null 
 loc        is x
 idList[]   is x
 fidList[]  is x
 nameList[] is x
 wloc[]     is x 
 rIA        is x 
 rIACPCid[] is x 
 x          is i
 xx         is i
 rc1        is x
 activeCPC(idList[])
 if rIA dp 
  rInactiveCPC(rIACPCid[])
  rc1 = $arraymerge(idList[], rIACPCid[])
  rc1 = $sort(idList[])
 endif 
 staffLocation(idList[], wloc[])
 x = 0 
 xx = 1
 do while x++ < $maxarray(idList[])
  if loc = wloc[x]
   fidList[xx] = idList[x]
   xx++
   endif
 enddo	
 x = 0 
 do while x++ < $maxarray(fidList[])
  nameList[x] = setStaffName(fidList[x])
 enddo
 rc1 = $sort(nameList[], fidList[])
 $allowupdate(fidList[], nameList[])
end filterByLoc

'pass staff ID and get the manager's name and ID....   return 1 on error and 0 on normal operation 
dynamic function getMngr(s_ID, mngr_ID, mngr_name, loc)is i 
' $trace("path","/c0/EXPORT/trace/lib_COMMON_getMngr.txt")                                
' $trace("on") 
 rc1        is x 	'return code 
 s_ID       is x 	'staff ID 
 mngr_ID    is x 	'manager's ID 
 mngr_name  is x 	'managers name 
 p.wloc     is x 	'work location
 loc        is x 	'location variable 
 s.pos.no   is x 	'position number 
 s.pos.rerc is h	'position record header 	
 if s_ID dp and s_ID != "9999"
  rc1 = $dbread(3,s_ID, s.pos.rerc, s.pos.no)
  if rc1 = "0"
   rc1 = $dbread(50, s.pos.no, p.wloc)
   loc = p.wloc
  else
   loc = 0
  endif
 endif	

 select loc 
  case "BO1" mngr_name = "Denise Truax"
             mngr_ID = 2323
             getMngr = 0
 case "CH1" or "CH2"
            mngr_name = "Edna Tipa"
            mngr_ID = 2321
            getMngr = 0
 case "DE1" or "DE2" or "DE3" or "DE4"
            mngr_name = "Donna Walker"
            mngr_ID = 4323
'			mngr_name = "Kent Floerke"
'           mngr_ID = 4169
            getMngr = 0
 case "GR1" or "GR2" or "GR3" or "GR4" or "GR5" or "GR6"
            mngr_name = " Elizabeth Sconce"
            mngr_ID = 2293
'Temp for Elizabeth while she's out
            mngr_name = " Cara Mullenix"
            mngr_ID = 4008
            getMngr = 0
 case "HA1" or "HA2" or "SE1"
            mngr_name = " Denise French"
            mngr_ID = 4329
            getMngr = 0
'            mngr_name = " Donna Walker"
'            mngr_ID = 4323
'            getMngr = 0
''            mngr_name = "Sheri Urbanczyk"
''            mngr_ID = 3003
''            getMngr = 0
 case "HE1" or "WF1" or "WF11" or "WF12" or "WF13" or "WF14" or "WF15" or "WF2" or "WF3" or "WF6" or "WF7" or "WF8" or "WF9" 
' 			mngr_name = "Irma Escobedo"
'			mngr_ID = "3908"
'            mngr_name = "Paula Maloney"
'            mngr_ID = 1951
            mngr_name = "Lauren Hargrove"
            mngr_ID = 4284
            getMngr = 0
 case "VE1" or "VE2" or "VE3" or "QU1" or "QU2" 'or "HA1" or "HA2" or "SE1"
            mngr_name = "Gloria Simmons"
            mngr_ID = 2296
            getMngr = 0
 case other 
            mngr_name = "not on list"
            getMngr = 1		
 endselect		
 if s_id = "3709" or s_id = "4219" or s_id = "4319" or s_id = "4371" or s_id = "4369" or s_id = "3809" or s_id = "4467"
  mngr_name = "Charles Martin"
  mngr_ID = 2221
  getMngr = 0 
 endif
 
 $allowupdate(mngr_ID, mngr_name, loc)
' $trace("off") 
end getMngr

'pass a single or array of staff ID's 
'returns array of staff's email addresses 
function getEmail(staffID[], email[]) is null 
 staffID[] is x  'staff id array
 email[]   is x  'email array 
 s.email   is x	 'staff email 
 x         is i  'counter 
 rc1       is x  'return code 
 $clear(email[])
 x = 0 	
 do while x++ < $maxarray(staffID[])
  if staffid[x] != "c001"
   rc1 = $dbread(3, staffID[x], s.email)
   rc1 = $arrpush(email[], s.email)	
  endif
 enddo
 $allowupdate(email[])
end getEmail

'****************************************CHECK_CHIP STATUS*******************************
'THIS FUNCTION CHECKS A CLIENTS MEDICARE STATUS
function check_chip(Client, chip_result, copay) is x
 %include inc_C_EL
 c.rp            is h   'Responsible Party Record Header
 c.rp.emp        is x   'Responsible Party Employer name, this is also where the CHIP copay is entered for now.
 chip_result     is x   'RESULT OF SEARCH
 Client          is x   'CLIENT ID
 rc              is b   'RETURN CODE
 switch          is b   'FS FOUND SWITCH
 copay           is n   'copay variable
 copayx          is x   'alpha var for copay string
 seq             is x   'Holds the unique sequence number
 update_btn      is x    
 cancel_btn      is x
 newcopay        is n
 $allowupdate(chip_result, copay)
 switch = 0
 rc = $dbread(02, Client, c_el_dstlist)
 do while rc < 2 and switch = 0
  if (c.el.fs = 14 and c.el.ef.dt <= $today) and (c.el.la.dt > $today or c.el.la.dt !dp)
   chip_result = "CHIP_Recipient"
   switch = 1
   seq = c.seqnumb
   copay = c.el.chip.copay
  endif
  if switch = 0
   rc = $dbreadnextdst(02, Client, c_el_dstlist)
  endif
 enddo
 if chip_result !dp
  chip_result = "No CHIP"
 endif
end check_chip

'****************************************CHECK and UPDATE CHIP STATUS*************************
'THIS FUNCTION CHECKS A CLIENTS CHIP STATUS AND UPDATES IF NECESSARY
function checkupdate_chip(Client, chip_result, copay) is x
 %include inc_C_EL
 c.rp            is h   'Responsible Party Record Header
 c.rp.emp        is x   'Responsible Party Employer name, this is also where the CHIP copay is entered for now.
 chip_result     is x   'RESULT OF SEARCH
 Client          is x   'CLIENT ID
 rc              is b   'RETURN CODE
 switch          is b   'FS FOUND SWITCH
 copay           is n   'copay variable
 copayx          is x   'alpha var for copay string
 seq             is x   'Holds the unique sequence number
 update_btn      is x    
 cancel_btn      is x
 newcopay        is n
 $allowupdate(chip_result, copay)
 switch = 0
 rc = $dbread(02, Client, c.rp, c.rp.emp)
 copayx = c.rp.emp
 rc = $dbread(02, Client, c_el_dstlist)
 do while rc < 2 and switch = 0
  if (c.el.fs = 14 and c.el.ef.dt <= $today) and (c.el.la.dt > $today or c.el.la.dt !dp)
   chip_result = "CHIP_Recipient"
   switch = 1
   seq = c.seqnumb
   copay = c.el.chip.copay
  endif
  if switch = 0
   rc = $dbreadnextdst(02, Client, c_el_dstlist)
  endif
 enddo
 if chip_result !dp
  chip_result = "No CHIP"
 endif
 select chip_result
  case "No CHIP" $clear(copay)
  case "CHIP_Recipient"
		if c.el.chip.copay !dp and copayx dp
	  	 copayx = copayx
		 if $seg(copayx, 1,10) = "CHIP COPAY"
		  copayx = $seg(copayx, 13)
		  copay  = $castn(copayx)
		  seq = c.seqnumb
		  $dblock()
		  rc = $dbread(02, Client, c_el_dstlist)
		  if c.seqnumb != seq
		   do while rc < 2 and c.seqnumb != seq
		    $dblock()
			rc = $dbreadnextdst(02, Client, c_el_dstlist)
		    if c.seqnumb = seq
		     c.el.chip.copay = copay
			 rc = $dbupdate(02,Client, c.el, c.el.chip.copay)
		    else
		     $dbunlock()
		    endif	
		   enddo	
		  else
		   c.el.chip.copay = copay
		   rc = $dbupdate(02,Client, c.el, c.el.chip.copay)
		  endif 
		 endif
		endif
		copay = c.el.chip.copay
	    $submitopt("off","")
	    $cancelopt("off","")
	    $form("chip")
	     $tag("<CENTER>")
	      $text("Records Indicate that this patient has CHIP Insurance","H5")$br()
	      $text("Please Request to see the CHIP Insurance Card and Verify the Copay Amount","error")$br(3)
	      $table("chip")
	       $row()
	        $col("right",,"50%")$text("Current Copay on Record:  ", "datatag")
	        $col("left",,"50%")$text($format(c.el.chip.copay, "$$,$$$.$$"))
	       $row()
	        $col("right",,"50%")$text("If the above amount is incorrect, please enter correct amount here:  ", "datatag")
	        $col("left",,"50%")$textbox(newcopay)
	       $row()
	        $col("right",,"50%")$submit(update_btn,"Update")
	        $col("left",,"50%")$submit(cancel_btn,"Cancel")
	      $endtable()
	    $tag("</CENTER>")
	   $sendform()
       if update_btn = "Y"
 		$dblock()
 		seq = seq
 		rc = $dbread(02, Client, c_el_dstlist)
		if c.seqnumb != seq
		 do while rc < 2 and c.seqnumb != seq
		  $dblock()
		  rc = $dbreadnextdst(02, Client, c_el_dstlist)
		  if c.seqnumb = seq
		   c.el.chip.copay = newcopay
		   rc = $dbupdate(02,Client, c.el, c.el.chip.copay)
		  else
		   $dbunlock()
		  endif	
		 enddo	
		else
		 c.el.chip.copay = newcopay
		 rc = $dbupdate(02,Client, c.el, c.el.chip.copay)
		endif 
       endif	
       $submitopt("off","")
       $cancelopt("off","Finish")
  endselect
end checkupdate_chip

function PayDates(today,last_paydate,next_paydate) is null
 today          is d
 last_paydate   is d
 next_paydate   is d
 rc             is i
 index          is i
 holiday_date[] is d
 month          is i
 day            is i
 year           is i
 next_month     is i
 next_day       is i
 next_year      is i

 GetHolidays(holiday_date[])

 if today !dp
  today = $today
 endif 

 day   = $day(today)
 month = $month(today)
 year  = $year(today)

 if month = 12
  next_month = 1
  next_year = year + 1  
 else
  next_month = month
  next_year = year
 endif    
 
 if day > 15
  last_paydate = $castx(month) + "/15/" + $castx(year)
  select month
   case 2 if LeapYearYN(last_paydate) = "Y"
           next_day = 29
          else
           next_day = 28
          endif
   case 4 or 6 or 9 or 11 next_day = 30
   case other next_day = 31
  endselect
  next_paydate = $castx(month) + "/" + next_day + "/" + $castx(year)
 else
  next_paydate = $castx(month) + "/15/" + $castx(year)
  if month > 1
   month--
  else
   month = 12
   year--
  endif  
  last_paydate = $castx(month) + "/01/" + $castx(year)
  select month
   case 2 if LeapYearYN(last_paydate) = "Y"
           day = 29
          else
           day = 28
          endif
   case 4 or 6 or 9 or 11 day = 30
   case other day = 31
  endselect 
  last_paydate = $castx(month) + "/" + day + "/" + $castx(year) 
 endif 

  if $find(next_paydate,holiday_date[],1,"F") > 0
   next_paydate = next_paydate - 1
  endif 
  select $day(next_paydate,"DOW")
   case 1  next_paydate = next_paydate - 2
   case 7  next_paydate = next_paydate - 1
  endselect
  if $find(last_paydate,holiday_date[],1,"F") > 0
   last_paydate = last_paydate - 1
  endif 
  select $day(last_paydate,"DOW")
   case 1  last_paydate = last_paydate - 2
   case 7  last_paydate = last_paydate - 1
  endselect
  $allowupdate(last_paydate,next_paydate) 
end PayDates

function LastPayDate(today) is d
 today is d
 last   is d
 PayDates(today,last) 
 LastPayDate = last
end LastPayDate

function NextPayDate(today) is d
 today is d
 next is d
 PayDates(today,,next)
 NextPayDate = Next 
end NextPayDate

function GetHolidays(holiday_date[],holiday_desc[]) is null
 holiday_file   is x
 holidays[]     is x
 holiday_date[] is d
 holiday_desc[] is x
 index          is i
 rc             is i
 holiday_file = $sysname + "/holidays.txt"
 rc = $getfile(holidays[],holiday_file)
 index = 0
 do while index++ < $maxarray(holidays[])
  $parsem(holidays[index],1,"|",holiday_date[index], holiday_desc[index])
 enddo
 $allowupdate(holiday_date[],holiday_desc[])
end GetHolidays

dynamic function AnnoyConfirm() is x
 yes_btn is x
 no_btn  is x
 staff_to_annoy[] is x

' (void)$arrinsert(staff_to_annoy[],"4049")
 (void)$arrinsert(staff_to_annoy[],"3158")
 (void)$arrinsert(staff_to_annoy[],"2175") 'chamlin
 if $scriptid = "DAYHABGRP1" or $scriptid  = "DAYHABGRP2" or $scriptid = "ussaldif2" or $scriptid = "USSALDIF2"
  (void)$arrinsert(staff_to_annoy[],$operstaffid) 
 endif  
 if $find($operstaffid,staff_to_annoy[],1,"F") = 0
  AnnoyConfirm = "Y"
  return
 endif
 $submitopt("off", "YES")
 $cancelopt("off", "NO")
 $form($funcname)
  $tag("<center>")
   $br()$text("Please Confirm Ready to Save!","H1")
   $br(2)$image("../cmhcbuilocal/our_images/stop_sign.png")
   $br(4)$text("Are you absolutely sure that you're ready to save?","error")
   $br()$text("Did you review the information before attempting to save?","error")
   if $scriptid = "DAYHABGRP1" or $scriptid  = "DAYHABGRP2" or $scriptid = "ussaldif2" or $scriptid = "USSALDIF2"
    $br()$text("Is the {u}{b}Date Correct{/b}{/u}?","error")
    $br()$text("Sure the {u}{b}Date is Correct{/b}{/u}??","error")
    $br()$text("Is the {u}{b}Duration Correct{/b}{/u}??","error")
    $br()$text("Is the {u}{b}Start Time Correct{/b}{/u}??","error")
    $br()$text("Is {u}{b}everyone that was in the group present{/b}{/u}?","error")
    $br()$text("Was {u}{b}someone left out of the group{/b}{/u}?","error")
   endif
   $br(2)$submit(yes_btn,"YES")$ctag("&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;")$submit(no_btn,"NO")
  $tag("</center>")  
 $sendform($funcname)
 if $endbutton = "SUBMIT" or yes_btn = "Y"
  AnnoyConfirm = "Y"
 else
  AnnoyConfirm = "N"
 endif 
end AnnoyConfirm

dynamic function AnnoyConfirm2() is x
 cancel_btn   is x
 continue_btn is x
 last_name    is x
 s.ln         is x
 staff_to_annoy[] is x
' (void)$arrinsert(staff_to_annoy[],"4049")
 (void)$arrinsert(staff_to_annoy[],"3158")  
 if $scriptid = "DAYHABGRP1" or $scriptid  = "DAYHABGRP2"
  (void)$arrinsert(staff_to_annoy[],$operstaffid) 
 endif   
 if $find($operstaffid,staff_to_annoy[],1,"F") = 0
  AnnoyConfirm2 = "Y"
  return
 endif
 (void)$dbread(3,$operstaffid,s.ln)
 do while 1 = 1
  $submitopt("off", "Continue")
  $cancelopt("off", "Cancel")
  $form($funcname)
   $tag("<center>")
    $br()$text("Please Confirm Ready to Save!","H1")
    $br(2)$image("../cmhcbuilocal/our_images/stop_sign.png")	
    $br(4)$text("Please type your last name to confirm that you are ready to save and all information is correct.","error")  
    $br(2)$textbox(last_name,,32,33)
    $br()$submit(continue_btn,"Continue")$ctag("&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;")$submit(cancel_btn,"Cancel")
   $tag("</center>")   
  $sendform($funcname)
  if $endbutton = "SUBMIT" or continue_btn = "Y"
   if $uc(last_name) = $uc(s.ln)
    AnnoyConfirm2 = "Y"
	return
   else
    $brmsg("Your entry does not match. Try again or cancel",1,"W","No Match")
	AnnoyConfirm2 = "N"
   endif
  else
   AnnoyConfirm2 = "N"
   return
  endif
 enddo
end AnnoyConfirm2

function DisplayMultiSnap(snapshots[]) is null
 snapshots[] is x
 index      is i
 index = 0
 $submitopt("off", "Exit")
 $cancelopt("off", "")
 $form($funcname)
 do while index++ < $maxarray(snapshots[])
  {"l_snapLibSC"}sn_viewSnap(snapshots[index])
  $tag("<STYLE TYPE='text/css'>P.breakhere{page-break-before:always}</STYLE>")
  $tag("<p class='breakhere'>")$tag("</p>")
 enddo
  %include c_pbutton 
 $sendform($funcname)
end DisplayMultiSnap 

function NewYearReminder(date) is null
 date          is d
 date_month    is i
 date_day      is i
 date_year     is i
 current_month is i
 current_day   is i
 current_year  is i

 date_month    = $month(date)
 date_day      = $day(date)
 date_year     = $year(date)
 current_month = $month($today)
 current_day   = $day($today)
 current_year  = $year($today)
 if current_month = 1 or current_month = 2
  if (date_month = current_month and date_day = current_day and date_year < current_year) or
     (date_month = current_month and date_day < current_day and date_year < current_year)
   $brmsg("Please check the date entered, it appears to be for the previous year",1,"W","Check Date Warning")
  endif
 endif
end NewYearReminder

function ActiveStaff(staff[]) is x
 staff[]    is x
 s.type     is x
 param[]    is x
 cri[]      is x
 output[]   is x
 rc         is x
 rc = $searchinit(s.type)
 cri[1] = "AS"
 rc = $search(cri[],,,,Staff[])		
 $allowupdate(staff[])
end ActiveStaff

function InactiveStaff(staff[]) is x
 staff[]    is x
 s.type     is x
 param[]    is x
 cri[]      is x
 output[]   is x
 rc         is x
 rc = $searchinit(s.type)
 cri[1] = "IS"
 rc = $search(cri[],,,,Staff[])		
 $allowupdate(staff[])
end InactiveStaff

function ActiveClients(clients[]) is x
 clients[]  is x
 c.type     is x
 param[]    is x
 cri[]      is x
 output[]   is x
 rc         is x
 rc = $searchinit(c.type)
 cri[1] = "AC"
 rc = $search(cri[],,,,Clients[])		
 $allowupdate(clients[])
end ActiveClients

function InactiveClients(clients[]) is x
 clients[]  is x
 c.type     is x
 param[]    is x
 cri[]      is x
 output[]   is x
 rc         is x
 rc = $searchinit(c.type)
 cri[1] = "IC"
 rc = $search(cri[],,,,Clients[])		
 $allowupdate(clients[])
end InactiveClients

function ActiveGroups(groups[]) is x
 groups[]   is x
 c.type     is x
 param[]    is x
 cri[]      is x
 output[]   is x
 rc         is x
 rc = $searchinit(c.type)
 cri[1] = "AG"
 rc = $search(cri[],,,,Groups[])		
 $allowupdate(groups[])
end ActiveGroups

function InactiveGroups(groups[]) is x
 groups[]   is x
 c.type     is x
 param[]    is x
 cri[]      is x
 output[]   is x
 rc         is x
 rc = $searchinit(c.type)
 cri[1] = "IG"
 rc = $search(cri[],,,,Groups[])		
 $allowupdate(groups[])
end InactiveGroups

function ActiveMeds(meds1[],meds2[],meds3[],meds4[],meds5[],meds6[],meds7[],meds8[],meds9[],meds10[]) is x
 meds[]           is x
 meds1[]          is x
 meds2[]          is x
 meds3[]          is x
 meds4[]          is x
 meds5[]          is x
 meds6[]          is x
 meds7[]          is x
 meds8[]          is x
 meds9[]          is x
 meds10[]         is x
 P.DATE           is d	'RX date dst
 P.RXMED          is x	'RX medication dst
 P.STENGTH        is x	'RX strength dst
 P.DOSE           is x	'RX dose dst
 P.RXDUE          is d	'RX due date dst
 P.DAYS           is b	'RX # days dst
 P.ORIGREFILL     is b	'RX refills dst
 P.RXREFILL       is b	'RX refills remaining dst
 P.PRINT          is x	'RX local dst
 parm[]           is x	'RX search parm
 cri[]            is x	'RX search criteria
 output[]         is x	'RX search output
 overdue          is d	'RX overdue date
 counter          is n	'Array index
 endofscript      is b	'Script ends in x days
 rc               is b	'Return code
 index            is i
 clients[]        is x
 ActiveClients(clients[])
 parm[1] = "DST# 6201"
 parm[2] = "DST# 6210"
 $searchparm(parm[])
 rc = $searchinit()
 index = 0
 do while index++ < $maxarray(clients[])
  cri[1] = clients[index]
  cri[2] = "\dnp"
  rc = $search(cri[],,,,output[])
  counter = 0
  do while counter++ < $maxarray(output[])
   rc = $dbread(62, output[counter], P.DATE, P.RXMED, P.DOSE, P.STENGTH, P.DAYS, P.RXDUE, P.ORIGREFILL, P.PRINT, P.RXREFILL)
   endofscript = P.DAYS + (P.DAYS * P.ORIGREFILL)
   overdue = P.DATE + endofscript
   if (P.DATE <= $today and overdue >= $today) or (P.RXDUE >= $today) or (P.PRINT = "N" and P.RXREFILL > 0)
    if $maxarray(meds1[]) < 32766
	 rc = $arrinsert(meds1[], output[counter])
	elseif $maxarray(meds2[]) < 32766
	 rc = $arrinsert(meds2[], output[counter])
	elseif $maxarray(meds3[]) < 32766
	 rc = $arrinsert(meds3[], output[counter])
	elseif $maxarray(meds4[]) < 32766
	 rc = $arrinsert(meds4[], output[counter])	 
	elseif $maxarray(meds5[]) < 32766
	 rc = $arrinsert(meds5[], output[counter])	 
	elseif $maxarray(meds6[]) < 32766
	 rc = $arrinsert(meds6[], output[counter])	 
	elseif $maxarray(meds7[]) < 32766
	 rc = $arrinsert(meds7[], output[counter])	 
	elseif $maxarray(meds8[]) < 32766
	 rc = $arrinsert(meds8[], output[counter])	 
	elseif $maxarray(meds9[]) < 32766
	 rc = $arrinsert(meds9[], output[counter])	 
	elseif $maxarray(meds10[]) < 32766
	 rc = $arrinsert(meds10[], output[counter])	 
	endif
   endif
  enddo
 enddo
 $allowupdate(meds1[],meds2[],meds3[],meds4[],meds5[],meds6[],meds7[],meds8[],meds9[],meds10[])
end ActiveMeds

function InactiveMeds(meds1[],meds2[],meds3[],meds4[],meds5[],meds6[],meds7[],meds8[],meds9[],meds10[]) is x
 meds[]           is x
 meds1[]          is x
 meds2[]          is x
 meds3[]          is x
 meds4[]          is x
 meds5[]          is x
 meds6[]          is x
 meds7[]          is x
 meds8[]          is x
 meds9[]          is x
 meds10[]         is x 
 P.DATE           is d	'RX date dst
 P.RXMED          is x	'RX medication dst
 P.STENGTH        is x	'RX strength dst
 P.DOSE           is x	'RX dose dst
 P.RXDUE          is d	'RX due date dst
 P.DAYS           is b	'RX # days dst
 P.ORIGREFILL     is b	'RX refills dst
 P.RXREFILL       is b	'RX refills remaining dst
 P.PRINT          is x	'RX local dst
 parm[]           is x	'RX search parm
 cri[]            is x	'RX search criteria
 output[]         is x	'RX search output
 overdue          is d	'RX overdue date
 counter          is n	'Array index
 endofscript      is b	'Script ends in x days
 rc               is b	'Return code
 index            is i
 clients[]        is x
 Inactive[]       is x
 ActiveClients(clients[])
 parm[1] = "DST# 6201"
 parm[2] = "DST# 6210"
 $searchparm(parm[])
 rc = $searchinit()
 index = 0
 do while index++ < $maxarray(clients[]) 
  cri[1] = clients[index]
  cri[2] = "\dnp"
  rc = $search(cri[],,,,output[])
  counter = 0
  do while counter++ < $maxarray(output[])
   rc = $dbread(62, output[counter], P.DATE, P.RXMED, P.DOSE, P.STENGTH, P.DAYS, P.RXDUE, P.ORIGREFILL, P.PRINT, P.RXREFILL)
   endofscript = P.DAYS + (P.DAYS * P.ORIGREFILL)
   overdue = P.DATE + endofscript
   if (P.DATE > $today and overdue < $today) or (P.RXDUE < $today) or (P.PRINT = "Y" and P.RXREFILL = 0)
    if $maxarray(meds1[]) < 32766
	 rc = $arrinsert(meds1[], output[counter])
	elseif $maxarray(meds2[]) < 32766
	 rc = $arrinsert(meds2[], output[counter])
	elseif $maxarray(meds3[]) < 32766
	 rc = $arrinsert(meds3[], output[counter])
	elseif $maxarray(meds4[]) < 32766
	 rc = $arrinsert(meds4[], output[counter])	 
	elseif $maxarray(meds5[]) < 32766
	 rc = $arrinsert(meds5[], output[counter])	 
	elseif $maxarray(meds6[]) < 32766
	 rc = $arrinsert(meds6[], output[counter])	 
	elseif $maxarray(meds7[]) < 32766
	 rc = $arrinsert(meds7[], output[counter])	 
	elseif $maxarray(meds8[]) < 32766
	 rc = $arrinsert(meds8[], output[counter])	 
	elseif $maxarray(meds9[]) < 32766
	 rc = $arrinsert(meds9[], output[counter])	 
	elseif $maxarray(meds10[]) < 32766
	 rc = $arrinsert(meds10[], output[counter])	 
	endif
   endif
  enddo
  parm[1] = "DST# 6201"
  parm[2] = "DST# 6210"
  $searchparm(parm[])
  rc = $searchinit()
  cri[1] = clients[index]
  cri[2] = "\dp"
  rc = $search(cri[],,,,Inactive[]) 
 enddo
 $allowupdate(meds1[],meds2[],meds3[],meds4[],meds5[],meds6[],meds7[],meds8[],meds9[],meds10[])
end InactiveMeds

function MEDNECANNUAL(client)is x
 MEDNECANNUAL = "N"
 client          is x
 $looplimit = 0
 index1          is i
 index2          is i
 rc              is i

 c.uabd          is h
 c.uabd.staff2   is x
 c.uabd.date1    is d
 c.uabd.pur      is x
 c.uabd.disdt    is d

 c.cabd.rec      is h
 c.cabd.staff3   is d
 c.cabd.date3    is d
 c.cabd.ass      is x
 c.cabd.disdt    is d
 
 
 
 
 
 
 
 
 
 
 startdate       is d
 enddate         is d
 last_ua         is d
 first_ua        is d

 c_uabd_rec[]    is x
 c_uabd_effd[]   is d
 c_uabd_staff2[] is x
 c_uabd_date1[]  is d
 c_uabd_pur[]    is x
 c_uabd_disdt[]  is d

 c_cabd_rec[]    is x
 c_cabd_effd[]   is d
 c_cabd_staff3[] is x
 c_cabd_date3[]  is d
 c_cabd_ass[]    is x
 c_cabd_disdt[]  is d 

 lpha_count      is i
 qmhp_count      is i
 clients_need[]  is x
 s.uardm.cred    is x
 age             is i
 age = ClientAge(client)
 startdate = $today - 366
 enddate   = $today
 if age < 18
  rc = $dbreadtoarray(02,client,c.uabd,c.uabd.staff2,c.uabd.date1,c.uabd.pur,c.uabd.disdt,
                                 c_uabd_rec[],c_uabd_effd[],c_uabd_staff2[],,c_uabd_date1[],,c_uabd_pur[],,c_uabd_disdt[])
  index2 = 0
  lpha_count = 0
  qmhp_count = 0
  do while index2++ < $maxarray(c_uabd_rec[]) and c_uabd_date1[index2] >= startdate and lpha_count = 0
   rc = $dbread(03,c_uabd_staff2[index2],s.uardm.cred)
   select s.uardm.cred
    case "1" if c_uabd_date1[index2] >= startdate
              qmhp_count++
		     endif 
    case "6" if c_uabd_date1[index2] >= startdate
              lpha_count++   
		     endif 
   endselect
  enddo
  if c_uabd_pur[index2] = "D" and c_uabd_disdt[index2] >= startdate
   lpha_count++
  endif
 else
  rc = $dbreadtoarray(02,client,c.cabd.rec,c.cabd.staff3,c.cabd.date3,c.cabd.ass,c.cabd.disdt,
                                 c_cabd_rec[],c_cabd_effd[],c_cabd_staff3[],,c_cabd_date3[],,c_cabd_ass[],,c_cabd_disdt[])
  index2 = 0
  lpha_count = 0
  qmhp_count = 0
  do while index2++ < $maxarray(c_cabd_rec[]) and c_cabd_date3[index2] >= startdate and lpha_count = 0
   rc = $dbread(03,c_cabd_staff3[index2],s.uardm.cred)
   select s.uardm.cred
    case "1" if c_cabd_date3[index2] >= startdate
              qmhp_count++
		     endif 
    case "6" if c_cabd_date3[index2] >= startdate
              lpha_count++   
		     endif 
   endselect
  enddo
  if c_cabd_ass[index2] = "D" and c_cabd_disdt[index2] >= startdate
   lpha_count++
  endif
 endif
 if qmhp_count > 0 and lpha_count = 0
  MEDNECANNUAL = "Y"
 endif
end MEDNECANNUAL    

function TextReplacement(key1) is x
 rc               is i
 kfile            is x
 kfile-num        is i
 key1             is x
 key2             is x
 text_replacement is x
 kfile = $operstaffid + "_TR"
 kfile-num = 1
 rc = $openkfile(kfile-num,kfile,"I")
 select rc
  case 0 rc = $readk(kfile-num, key1, , text_replacement)
         if rc = 0
		  TextReplacement = text_replacement
		 endif
         rc = $closekfile(kfile-num)
  case 1 $brmsg("Incorrect code value (not I, O, or U)",1,"W","OpenKFile error")
  case 2 $brmsg("File number in kfile-num already in use",1,"W","OpenKFile error")
  case 3 $brmsg("The code argument specified I or U and the file wasn't found or the code argument specified O and the file already exists.",1,"W","OpenKFile error")
  case 4 $brmsg("Invalid file number (kfile-num must be 1, 2, or 3)",1,"W","OpenKFile error")
  case 5 if $filestat = 41
		  rc = $readk(kfile-num, key1, , text_replacement)
          if rc = 0
		   TextReplacement = text_replacement
		  endif
          rc = $closekfile(kfile-num)
		 else
		  $brmsg(`"An error condition returned from the open $filestat= " + $filestat`,1,"W","OpenKFile error")
 		 endif
 endselect
end TextReplacement

function TextReplace(string) is null
 string      is x
 rc          is i
 words[]     is x
 punctuation is x
 index       is i
 replacement is x
 $parsem(string,1," ",words[])
 $clear(string)
 index = 0
 do while index++ < $maxarray(words[])
'  if $seg(words[index],1,1) = "@" 
   $clear(punctuation)
   select $seg(words[index],$len(words[index]),1)
    case "." punctuation = "."
	case "!" punctuation = "!"
	case "?" punctuation = "?"
	case "," punctuation = ","
	case ";" punctuation = ";"
	case "/" punctuation = "/"
   endselect
   if punctuation dp
    words[index] = $replace(punctuation,,words[index])
   endif	
   replacement =  TextReplacement(words[index])
   if replacement dp
    words[index] = replacement
	if punctuation dp
	 words[index] += punctuation
	endif 
   endif 
'  endif 
  string += words[index] + " "  
 enddo
 $allowupdate(string)
end TextReplace

'****************************************CHECK_Private Insurance STATUS*******************************
'THIS FUNCTION CHECKS A CLIENTS Private Insurance STATUS
function check_privins(Client, ins_result, ins_name, ins_id, ins_group, ins_who, ins_dob, ins_relation, ins_employer) is x
%include inc_C_EL
 ins_result   is x 'Private Insurance Result
 ins_name	  is x 'Insurance Company Name
 ins_id		  is x 'Insurance Company ID
 ins_group    is x 'Insuracen Company Group
 ins_who      is x 'Insured Name
 ins_dob      is d 'Insured DOB
 ins_relation is x 'Client Relation to Insured
 ins_employer is x 'Insuured's Employer
 Client       is x 'CLIENT ID
 rc           is i 'RETURN CODE
 switch       is i 'FS FOUND SWITCH
 $$con.nm			is x 'Contract Name from DB 12 needed for FS's >= 200
 $allowupdate(ins_result, ins_name, ins_id, ins_group, ins_who, ins_dob, ins_relation, ins_employer)
 switch = 0
 rc = $dbread(02, Client, c_el_dstlist)
 do while rc < 2 and switch = 0
  if ((c.el.fs = 2 or c.el.fs = 14 or c.el.fs = 200 or c.el.fs = 210 or c.el.fs = 220) and c.el.ef.dt <= $today) and (c.el.la.dt > $today or c.el.la.dt !dp)
   if c.el.fs = 14
    ins_result = "Chip Recipient"
   else
   	ins_result = "PrivIns Recipient"
   	if c.el.fs >= 200 and c.el.fs <= 220
   		rc = $dbread(12,$$el.cont, $$con.nm)
   		ins_name = $$con.nm
   	else
   		ins_name = c.eg.icn
   	endif
   endif
'   ins_name     = c.eg.icn
   ins_id       = c.el.id.1
   ins_group    = c.el.id.2
   ins_who      = `c.eg.insfn + " " + c.eg.insln`
   ins_dob      = c.eg.insbd
   ins_relation = $dct(822, c.eg.insrc, "D")
   ins_employer = c.eg.insem
   switch = 1 
  endif
  rc = $dbreadnextdst(02, Client, c_el_dstlist)
 enddo
 if ins_result !dp
  ins_result = "No PrivIns"
 endif
end check_privins

function MOTD() is null
 rc           is i
 msg[]        is x
 motd_file    is x
 file-size    is n
 create-date  is d
 create-time  is t
 type         is x
 permissions  is x
 owner        is x
 group        is x 
 index        is i
 display_line is i
 motd_file = $sysname + "/motd" 
 index = 0
 display_line = 4
 rc = $checkfile(motd_file,file-size,create-date,create-time,type,permissions,owner,group)
 if rc = 0 and file-size > 0
  if $getfile(msg[],motd_file) = 0
   if $bui = "Y"
    $submitopt("off", "")
    $cancelopt("off", "Continue")
	$form()
	$br(3)$text("{center}Message of the Day{/center}","H1")
	$br(3)
	do while index++ < $maxarray(msg[])
	 $br()$text(msg[index],"datatag")
	enddo
	$sendform()
   else
    $disp("Message of the Day",2,20,,"H")
	do while index++ < $maxarray(msg[])
	 $disp(msg[index],display_line++,10,)
	enddo
	display_line += 3
	$disp("Press any key to continue...",display_line,20,,"H")
    $acpt()
   endif
  endif
 endif
end MOTD

function Staff_Message() is null
 rc           is i
 msg[]        is x
 message_file    is x
 file-size    is n
 create-date  is d
 create-time  is t
 type         is x
 permissions  is x
 owner        is x
 group        is x 
 index        is i
 display_line is i
 display_pos  is i
 start_date   is d
 end_date     is d
 message      is x
 message2[]   is x
 message_file = $sysname + "/MESSAGES/" + $operstaffid 
 index = 0
 display_line = 4
 display_pos = 10
 rc = $checkfile(message_file,file-size,create-date,create-time,type,permissions,owner,group)
 if rc = 0 and file-size > 0
  if $getfile(msg[],message_file) = 0
   start_date = msg[1]
   end_date = msg[2]
   message = msg[3]
   if end_date !dp
    end_date = start_date
   endif
   if $today >= start_date and $today <= end_date     
    if $bui = "Y"
     $submitopt("off", "")
     $cancelopt("off", "Continue")
	 $form()
	 $br(3)$text("{center}Staff Login Message{/center}","H1")
	 $br(3)$br()$text(message,"datatag")
	 $sendform()
    else
	 rc = $getds(message2[],message," ")
	 $disp("Staff Login Message",2,20,,"H")
	 do while index++ < $maxarray(message2[])	   
	  $disp(message2[index],display_line,display_pos,)
	  display_pos += $len(message2[index]) + 1
	  if display_pos > 64
	   display_pos = 10
	   display_line++
	  endif
	 enddo    
	 display_line += 3
	 $disp("Press any key to continue...",display_line,20,,"H")
     $sleep(2)
	 $acpt()
    endif
   endif
  endif
 endif
end Staff_Message

function STAFF_LOGIN_SCRN(s.id) is null
 if $bui = "Y" 
  rc    is i
  index is i
  s.id  is x
  s.fn  is x
  s.mn  is x
  s.ln  is x
  s.bd  is d

  c.dsmiiir is h
  c.diag    is x

  time[]      is t
  client[]    is x
  client-fn[] is x
  client-ln[] is x
  service[]   is b
  desc[]      is x
  ru[]        is b
  duration[]  is t
  pe-key[]    is x
  
  ua_date[]      is d
  ua_type[]      is x
  ua_type_desc[] is x
  ua_locr[]      is x
  ua_locr_desc[] is x
  ua_loca[]      is x
  ua_loca_desc[] is x
  ua_due[]       is d
  client_age[]   is i
  diagnosis[]    is x
  
  optout         is x
  current_optinout is x

  dct_ai         is x
  dct_desc       is x
  dct_alt1       is x
  dct_alt2       is x
  dct_alt3       is x
  
  row_color      is x
  row_color1     is x
  row_color2     is x


  if s.id !dp
   s.id = $operstaffid
  endif
 
  if $dct(9072,$operstaffid,"2") != "Y" or $calledby = "STAFFMENU"
   row_color1 = "lemonchiffon"
   row_color2 = "white"
   rc = $pertoarray(s.id,,$today,$today,,,,, time[], client[], client-fn[], client-ln[], service[], desc[], ru[], duration[],,,,,pe-key[])
   if rc = 0
    rc = $dbread(03,s.id,s.fn,s.mn,s.ln,s.bd)
    rc = $dcv(9072,$operstaffid,,,,optout)     
    index = 0
    do while index++ < $maxarray(pe-key[index]) 
     ClientLastUA(client[index],, ua_date[index], ua_type[index], ua_locr[index], ua_loca[index], ua_due[index], client_age[index])
     if client_age[index] < 18
      ua_type_desc[index] = $dct(9009,ua_type[index])
  '	ua_locr_desc[index] = $dct(9013,ua_locr_desc[index])
  '	ua_loca_desc[index] = $dct(9014,ua_locr_desc[index])
     else
      ua_type_desc[index] = $dct(9000,ua_type[index])
  '	ua_locr_desc[index] = $dct(9001,ua_locr_desc[index])
  '	ua_loca_desc[index] = $dct(9002,ua_loca_desc[index])
     endif	
     rc = $dbread(02,client[index],c.dsmiiir,c.diag)  
     diagnosis[index] = c.diag
    enddo 
    $submitopt("off", "")
    $cancelopt("off", "Continue")
    $form() 
     $tag("<center>")
	  $br(2)$text("Todays Schedule","H1")$ctag("&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;")$text($today,"H1")
	  $br()$text(s.id,"H1")$text(" - ","H1")$text($ncs(s.fn),"H1")$text(" " )$text($ncs(s.ln),"H1")
     $tag("</center>")	
     $br(4)$text("Appointments: ","siginfo")$text($maxarray(pe-key[],"siginfo"))
     $br()
     $table("APPTS",,"width='100%' cellspacing='0' cellpadding='0'")
	  $row(,"bgcolor='navy'")
	   $col(,,"2%")
	   $col(,,"5%")$text("Time",,"color=white")
	   $col(,,"2%")
	   $col()$text("Client",,"color=white")
	   $col(,,"2%")
	   $col()$text("Name",,"color=white")
	   $col(,,"2%")
	   $col()$text("Age",,"color=white")
	   $col(,,"2%")
	   $col()$text("Service",,"color=white")
	   $col(,,"2%")
	   $col()$text("Description",,"color=white")
	   $col(,,"2%")
	   $col()$text("Duration",,"color=white")
	   $col(,,"2%")
	   $col()$text("Last UA Date",,"color=white")	 
	   $col(,,"2%")
	   $col()$text("UA Type",,"color=white")	 
	   $col(,,"2%")
	   $col()$text("Current SP",,"color=white")	 
	   $col(,,"2%")
	   $col()$text("Next UA Due Date",,"color=white")	 	 
	   $col(,,"2%")
	   $col()$text("Diagnosis",,"color=white")	 	 
	   $col(,,"2%")
	  index = 0
	  do while index++ < $maxarray(pe-key[])
       select $mod(index,2)
        case 0     row_color = "bgcolor='" + row_color2 + "'"
        case other row_color = "bgcolor='" + row_color1 + "'"
       endselect	
	   $row(,row_color)
	    $col()
	    $col()$text($format(time[index],"HH:MM ap"))
	    $col()
        $col()$text(client[index])
	    $col()
        $col()$text($ncs(client-fn[index]))$text(" ")$text($ncs(client-ln[index]))
	    $col()
	    $col()$text(client_age[index])
	    $col()
        $col()$text(service[index])$text(" - ")$text($sam(service[index]))
	    $col()
	    $col()$text(desc[index])
	    $col()
	    $col()$text($format(duration[index],"HH.MM"))  
	    $col()
	     if ua_date[index] dp
	      $col()$text(ua_date[index])	  
		 else
		  $col(,,,,,"bgcolor='gainsboro'")
	     endif 
	    $col()
	     if ua_type_desc[index] dp
	      $col()$text(ua_type_desc[index])
		 else
		  $col(,,,,,"bgcolor='gainsboro'")		 
   	     endif 
	    $col()
	     if ua_loca[index] dp
	      $col()$text(ua_loca[index])'$text(" - ")$text(ua_loca_desc[index])	  
		 else
		  $col(,,,,,"bgcolor='gainsboro'")	   
	     endif 
	    $col() 
		 if ua_due[index] dp
	      if ua_due[index] <= $today
	       $col(,,,,,"bgcolor='#CC0000'")$text(ua_due[index],,"color=white")
	      else
	       $col()$text(ua_due[index])	  
	      endif 
	     else
		  $col(,,,,,"bgcolor='gainsboro'")
		 endif
	    $col()
         if diagnosis[index] dp
          $col()$text(diagnosis[index])$text(" - ")$text($dct(400,c.diag))
         else
		  $col(,,,,,"bgcolor='gainsboro'")
	    endif 
	    $col()
	  enddo 	  
     $endtable("APPTS")
     $tag("<center>")
	  $br(2)$text("If you would like to Opt Out of this seeing this screen when you login to eCet click Opt Out","datatag")$checkbox(optout,"Opt Out","Y")
	  $br() $text("{i}If you Opt Out now you can re-enable this screen by using the menu Option {u}{b}Today's Appointments{/b}{/u} from your staff menu (green screen){/i}","siginfotag")	 
	  $br(2)
	  %include c_pbutton
     $tag("</center>")
    $sendform()
    rc = $dcv(9072,$operstaffid,dct_ai,dct_desc,dct_alt1,dct_alt2,dct_alt3)
	if rc = 0
     rc = $updatedcv(9072,$operstaffid,dct_desc,dct_ai,dct_alt1,optout,dct_alt3)   
	else
     rc = $adddcv(9072,$operstaffid,dct_desc,dct_alt1,optout,dct_alt3)   	
	endif 
   else
    if $calledby = "STAFFMENU"
     $submitopt("off", "")
     $cancelopt("off", "Continue")    
	 $form()
	  $tag("<center>")
       $br(2)$text("Todays Schedule","H1")$ctag("&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;")$text($today,"H1")
	   $br()$text(s.id,"H1")$text(" - ","H1")$text($ncs(s.fn),"H1")$text(" " )$text($ncs(s.ln),"H1")
       $br(4)$text("Appointments: ","siginfo")$text($maxarray(pe-key[],"siginfo"))	
	   $br(2)$text("If you would like to Opt Out of this seeing this screen when you login to eCet click Opt Out","datatag")$checkbox(optout,"Opt Out","Y")
	   $br() $text("{i}If you Opt Out now you can re-enable this screen by using the menu Option {u}{b}Today's Appointments{/b}{/u} from your staff menu (green screen){/i}","siginfotag")	 
	   $br(2)
	   %include c_pbutton
      $tag("</center>")
	 $sendform()
     rc = $dcv(9072,$operstaffid,dct_ai,dct_desc,dct_alt1,dct_alt2,dct_alt3)
	 if rc = 0
      rc = $updatedcv(9072,$operstaffid,dct_desc,dct_ai,dct_alt1,optout,dct_alt3)   
	 else
      rc = $adddcv(9072,$operstaffid,dct_desc,dct_alt1,optout,dct_alt3)   	
	 endif 	
	endif	
   endif
  endif
 endif 
end STAFF_LOGIN_SCRN

static function DisplayOnce() is null
 display_once is i
 if display_once = 0
  display_once++
  Staff_Login_Scrn($operstaffid)
 endif
end DisplayOnce

function OnMedWaitingList(CID,date) is x
 %include inc_CMEDWL
 CID          is x
 date         is d
 rc           is i
 if $regid dp and cid !dp
  CID = $regid
 endif
 if date !dp
  date = $today
 endif
 rc = $dbread(2,cid,c.medwl.rec,c.medwl.effdt,c.medwl.lapdt)
 if c.medwl.rec dp
  if c.medwl.effdt <= date and (c.medwl.lapdt !dp or date < c.medwl.lapdt)
   OnMedWaitingList = "Y"
  else
   OnMedWaitingList = "N"
  endif 
 endif
end OnMedWaitingList

dynamic function ScriptWrapper(script,var1,var2,var3,var4) is i
 script is x
 var1   is x
 var2   is x
 var3   is x
 var4   is x

 parmfile is x
 option   is x
 client   is x
 retcode  is b
 staff    is x

 other[]  is x

'      (TaskScript[TaskSLOT],TaskRegID[TaskSLOT], TaskOther[TaskSLOT], StaffID, TaskUID[TaskSLOT])

 select script
  case "ANSA"
       (void)$getds(other[],var2,"|")
	   client = var1
	   parmfile = other[1]
	   option = other[2]	   
       call script(parmfile,option,client,retcode)
  case "CANS35"
       (void)$getds(other[],var2,"|")
	   client = var1
	   parmfile = other[1]
	   option = other[2]	   
       call script(parmfile,option,client,retcode)	   
  case "CANS617"
       (void)$getds(other[],var2,"|")
	   client = var1
	   parmfile = other[1]
	   option = other[2]	   
       call script(parmfile,option,client,retcode)	   
  case "CANSWRAPPER"
       (void)$getds(other[],var2,"|")
	   client = var1
	   parmfile = other[1]
	   option = other[2]	   
       call script(parmfile,option,client,retcode)	   
  case "UABDFORM"
       (void)$getds(other[],var2,"|")
	   client = var1
	   parmfile = other[1]
	   option = other[2]	   
       call script(parmfile,option,client,retcode)
  case "CABDFORM"
       (void)$getds(other[],var2,"|")
	   client = var1
	   parmfile = other[1]
	   option = other[2]	   
       call script(parmfile,option,client,retcode)
  case "DIAGNOSIS"
       (void)$getds(other[],var2,"|")
	   client = var1
	   parmfile = other[1]
	   option = other[2]	   
       call script(parmfile,option,client,retcode)
  case other  (void)$getds(other[],var2,"|")
	          client = var1
	          parmfile = other[1]
	          option = other[2]	   
              call script(parmfile,option,client,retcode)
 endselect
end ScriptWrapper

dynamic function PreLastDelivered(p.pres.id) is d
 p.pres.id is x
 p.delrcrh is h
 p.rxtrans is x
 p.rxrec   is d
 rc        is i
 rc = $dbread(62,p.pres.id, p.delrcrh, p.rxtrans, p.rxrec)
 if p.delrcrh dp
  do while p.rxtrans != "RX Delivered" and rc < 2
   rc = $dbreadnextdst(62,p.pres.id, p.delrcrh, p.rxtrans, p.rxrec)
  enddo
 endif
 if p.rxrec dp
  PreLastDelivered = p.rxrec
 endif 
end PreLastDelivered

function GetCounty() is x
 drop_county is x
 $clear(drop_county)
 $submitopt("off", "CONTINUE")
 $cancelopt("off", "BACK")
 $form("county")
  $br()$text("{H1}County Selection{/H1}")$br(2)
  $tag("<center>")
   $br(2)$text("Please select the Callers County: ","datatag")
   $dropboxdct(drop_county,68,"A","D")
  $tag("</center>")
 $sendform("county")   
 if $endbutton = "SUBMIT"
  GetCounty = drop_county 
 endif
end GetCounty

function GetFiles(import-dir,file-type-orig,file-name[],file-size[],file-date[],file-time[],file-owner[]) is null
 import-dir   is x
 file-type-orig is x
 file-name[]  is x
 file-size[]  is n
 file-date[]  is d
 file-time[]  is t
 file-owner[] is x
 checkfile    is i
 sort         is i
 i            is i 
 z            is i
 file-list[]  is x
 file-type-new is x
 file-type-len  is i
 i = 0
 z = 0
 if $right(import-dir,1,) != "/"
  import-dir += "/"
 endif
 $clear(file-type-new,file-name[],file-size[],file-date[],file-time[],file-owner[])
 file-type-len = $len(file-type-orig)
 do while i++ < file-type-len
  file-type-new += "[" + $uc($seg(file-type-orig,i,1)) + $lc($seg(file-type-orig,i,1)) + "]"
 enddo
 $clear(file-list[],file-name[],file-size[],file-date[],file-time[],file-owner[])
 (void)$unix(`"cd " + import-dir + ";ls -l *." + file-type-new + " | awk '{print$9}'"`, file-list[])
 i = 0
 do while i++ < $maxarray(file-list[])
  checkfile = $checkfile(`import-dir + file-list[i]`)
  if checkfile = 0
   file-name[++z] = file-list[i]
   checkfile = $checkfile(`import-dir + file-name[z]`,file-size[z],file-date[z], file-time[z],,,file-owner[z])
  endif
 enddo 
 sort = $sort(file-date[], "D", file-time[],"D",file-size[],"D",file-owner[],file-name[])
 $allowupdate(file-name[],file-size[],file-date[],file-time[],file-owner[])
end GetFiles

function ChkStfRehabCred(staffid,show_message) is x
 staffid         is x
 show_message    is x

 s.fn            is x
 s.ln            is x
 s.rehab.c       is x

 email_subject   is x
 email_body      is x
 email_address[] is x
 linefeed        is x

 linefeed         = x"0a"
 email_address[1] = "mis@helenfarabee.org"
 
 if staffid !dp 
  staffid = $operstaffid
 endif 
 (void)$dbread(3,staffid,s.fn, s.ln, s.rehab.c)
 ChkStfRehabCred = s.rehab.c
 if s.rehab.c !dp
  email_subject = "Staff Rehab Credential Missing: " + $operstaffid + ": " + s.fn + " " + s.ln 
  email_body    = "Please create an entry for staff: " + $operstaffid + ": " + s.fn + " " + s.ln + linefeed + linefeed + "This entry is required to complete progress notes correctly" + linefeed + "AUTOMATED MESSAGE"
  (void)$email(email_address[],email_subject,email_body)
  if $uc(show_message) = "Y" or $uc($seg(show_message,1,1)) = "Y"
   $submitopt("off", "Exit")
   $cancelopt("off", "")
   $form()
    $tag("<center>")	
     $br(4)$text("Error: Missing Staff Credential Field, Rehab","error")
	 $br(2)$text("A required credential field is missing from your staff setup.","Error") 
	 $br()$text("An automated email has been sent to the MIS Dept to correct the field and you will be able to continue when it is entered.","Error") 
	 $br()$text("Until it is entered you will not be able to complete progress notes.","Error") 
   $tag("</center>")		
   $sendform()
  endif
 endif
end ChkStfRehabCred

'*************************************Get a Client ID*****************************************
'This function is a simple BUI form to get a client ID and return it                         *
'*********************************************************************************************
function GetISNID() is x
 isn.id is x
 $clear(isn.id) 
 $submitopt("off", "NEXT")
 $cancelopt("off", "CANCEL")
 $form()
   $text("{H1}Enter ISN ID{/H1}")
   $table("t1",,"width='100%'")
   $row()
    $col("right",,"50%") $text("ENTER ISN ID: ","datatag")  
    $col(,,"50%") $textbox(isn.id,"DB``09",10,10,"Y") $editmsg(isn.id)
   $endtable("t1")
 $sendform()
 if $endbutton = "SUBMIT" then
  GetISNID = isn.id
 endif
end GetISNID

'*************************************Get a Date*****************************************
function GetDate(message) is d
 message is x
 thedate is x
 $clear(thedate) 
 $submitopt("off", "NEXT")
 $cancelopt("off", "CANCEL")
 $form()
   $text("{H1}Select Date{/H1}")
   if message dp
    $br()$text(`"{H1}" + message + "{/H1}"`)   
   endif
   $table("t1",,"width='100%'")
    $row()
     $col("right",,"50%") $text("Date: ","datatag")  
     $col()$textbox(thedate,"CAL",10,6)
   $endtable("t1")
 $sendform()
 if $endbutton = "SUBMIT"
  GetDate = thedate
 endif
end GetDate

function UMSTAFF(staff[]) is x
 staff[]    is x
 code[]     is x
 desc[]     is x
 act-code[] is x
 a1[]       is x
 a2[]       is x
 a3[]       is x
 (void)$arrpush(staff[],"3479")   'Andy Martin
 '(void)$arrpush(staff[],"1951")   'Paula Staats Maloney
 '(void)$arrpush(staff[],"3908")   'Irma Escobedo
 (void)$arrpush(staff[],"2481")   'Gianna Harris
 (void)$arrpush(staff[],"1529")   'Judy Michael (For displaying authorized UA's only)
 (void)$arrpush(staff[],"4561")   'Tiffany Childs (For displaying authorized UA's only)						 
 '(void)$arrpush(staff[],"3971")   'Claudia Urista (For displaying authorized UA's only)
 (void)$arrpush(staff[],"4008")   'Cara Mulenix
 (void)$dctloada(110,code[], desc[], act-code[], a1[], a2[], a3[])
 if ($find($operstaffid, staff[],1,"F") > 0) or ($find($operstaffid, code[],1,"F") > 0)
  UMSTAFF = "Y"
 else
  UMSTAFF = "N"
 endif 
end UMSTAFF

function MISStaff(staff[]) is x
 staff[]   is x
 s.ru      is b
 s.type    is x
 MIS_ru is b

 MIS_ru = 106
 staff[1] = "3243"  'Ralph Whaite
 staff[2] = "1343"  'Scott Reeves
 staff[3] = "3737"  'Chris Love
 staff[4] = "3956"  'Chris Ashley

 (void)$dbread(3,$operstaffid,s.ru,s.type)
 if s.ru = MIS_ru and s.type = "AS"
  (void)$arrinsert(staff[],$operstaffid)
  MISStaff = "Y"
 elseif $find($operstaffid, staff[],1,"F") > 0
  MISStaff = "Y"
 else
  MISStaff = "N"
 endif  
end MISStaff

function StaffCanDo(script) is i
 script is x
 select script
  case "CANS" if (MISStaff() = "Y") or ($operstaffid = "3479")
               StaffCanDo = 0
              endif
  case "ANSA" if (MISStaff() = "Y") or ($operstaffid = "3479")
               StaffCanDo = 0
              endif
 endselect
 if StaffCanDo != 0
  $brmsg("You are not authorized to use this function!", 1, "W", "ERROR")
 endif
end StaffCanDo

'-----------------------------------------------------------------------------

dynamic function MsgBox(DialogMessage, Icon, DialogTitle, Button1, Button2, Button3, Button4, Button5, Button6, Button7, Button8, Button9, Button10) is b
 DialogMessage	 is x
 Icon		     is b
 DialogTitle	 is x
 Button1		 is x
 Button2		 is x
 Button3		 is x 
 Button4		 is x 
 Button5		 is x 
 Button6		 is x 
 Button7		 is x 
 Button8		 is x 
 Button9		 is x 
 Button10		 is x 
 Buttons[]       is x
 ClickedButton[] is x
 IconURL		 is x
 WorkX		     is x 
 TitleFGColor    is x
 TitleBGColor    is x
 IconBase        is x
 IconH           is x
 IconW           is x
 IconH = "32"
 IconW = "32"
 
 TitleFGColor = "#FFFFFF"
 TitleBGColor = "#008000"
 IconBase = "../cmhcbuilocal/our_images/"
 IconBase = "/cmhcbui/cmhcbuilocal/our_images/"
 if DialogTitle !DP
  DialogTitle =  $scriptid
 endif

 if Button1 !DP
  Button1 = "Ok"
 endif

 Select Icon
  case 1 IconURL = IconBase + "Information.gif"
  case 2 IconURL = IconBase + "Question.gif"
  case 3 IconURL = IconBase + "Warning.gif"
  case 4 IconURL = IconBase + "Critical.gif"
  case 5 IconURL = IconBase + "oatmeal_tumbeasts/tbrun1.png"
         IconH = "120"
		 IconW = "240"
  case 6 IconURL = IconBase + "oatmeal_tumbeasts/tbrun2.png"
         IconH = "186"
		 IconW = "256"
  case 7 IconURL = IconBase + "oatmeal_tumbeasts/tbsit1.png"
         IconH = "262"
		 IconW = "174"
  case 8 IconURL = IconBase + "oatmeal_tumbeasts/tbsit2.png"
         IconH = "267"
		 IconW = "151"
  case 9 IconURL = IconBase + "oatmeal_tumbeasts/tbstand1.png"
         IconH = "199"
		 IconW = "247"		 
  case 10 IconURL = IconBase + "oatmeal_tumbeasts/server.png"
         IconH = "269"
		 IconW = "203"
 endselect

 $submitopt("OFF","")
 $cancelopt("OFF","")
 $form("MsgBox")
  $style()
  $bstyle()
  $table("T1",," border='0' cellspacing='0' cellpadding='0' id='AutoNumber1' width='100%' height='100%'")
   $row()
    $col("center","middle",,,,)$table("T2",," border='1' cellspacing='1' width='75%' id='AutoNumber2'")
		                        $row()
		                         $col("center",,"100%",,,`" bgcolor='" + TitleBGColor + "'"`)$ctag(`"<font color='" + TitleFGColor + "' size='5'>"`)$text(DialogTitle)$ctag("</font>")
		                        $row()
		                         $col(,,"100%",,," bgcolor='#FFFFFF'")$ctag("<div align='center'>")
		                                                               $ctag("<center>")
			                                                            $table("T3",," border='0' style='border-collapse: collapse' bordercolor='#111111' id='AutoNumber4' cellpadding='2'")
			                                                             $row()
			                                                             if IconURL DP and IconBase DP
				                                                          $col("center","middle",,,,)$ctag(`"<img border='0' src='" + IconURL + "' width='" + IconW + "' height='" + IconH + "'>"`)
			                                                             endif
			                                                             $col(,"middle")$text(DialogMessage)
			                                                            $endtable("T3")
			                                                            $table("T4",," border='0' cellspacing='0' style='border-collapse: collapse' bordercolor='#111111' cellpadding='0' id='AutoNumber5'")
			                                                             $row()
			                                                              $col(,,,,,)$submit(ClickedButton[1],Button1)
			                                                                         if Button2 DP
				                                                                      $ctag("&nbsp;")$submit(ClickedButton[2],Button2)
			                                                                         endif
			                                                                         if Button3 DP
				                                                                      $ctag("&nbsp;")$submit(ClickedButton[3],Button3)
			                                                                         endif
			                                                                         if Button4 DP
				                                                                      $ctag("&nbsp;")$submit(ClickedButton[4],Button4)
			                                                                         endif									 
			                                                                         if Button5 DP
				                                                                      $ctag("&nbsp;")$submit(ClickedButton[5],Button5)
			                                                                         endif											 
			                                                             if Button6 dp or button7 dp or button8 dp or button9 dp or button10 dp
																		  $row()
																		  $row()
			                                                               if Button6 dp
																		    $col(,,,,,)$submit(ClickedButton[6],Button6)
																		   endif 
			                                                                           if Button7 DP
				                                                                        $ctag("&nbsp;")$submit(ClickedButton[7],Button7)
			                                                                           endif
			                                                                           if Button8 DP
				                                                                        $ctag("&nbsp;")$submit(ClickedButton[8],Button8)
			                                                                           endif
			                                                                           if Button9 DP
				                                                                        $ctag("&nbsp;")$submit(ClickedButton[9],Button9)
			                                                                           endif									 
			                                                                           if Button10 DP
				                                                                        $ctag("&nbsp;")$submit(ClickedButton[10],Button10)
			                                                                           endif									 
                                                                         endif
			                                                            $endtable("T4")
		                                                               $ctag("</center>")
		                                                              $ctag("</div>")
		                        $endtable("T2")
  $endtable("T1")
 $sendform("MsgBox")
 $submitopt("ON","Submit")
 $cancelopt("ON","Cancel")
 MsgBox = $maxarray(ClickedButton[]) 
end MsgBox

dynamic function mkdir(directory, option) is i
  directory is x
  option    is x
  rc        is i
  cmd       is x
  if directory dp
   rc = $checkfile(directory) 
   if rc != 0
    cmd = "mkdir " + option + " '" + directory + "'"
    mkdir = $unix(cmd)
   else
    mkdir = rc
   endif   
  else
   mkdir = 99
  endif 
 end mkdir 

function StaffBD(s.bd,s.fn) is null
 rc            is i
 s.bd          is d
 s.fn          is x 
 this_years_bd is d 
 birth_month   is i
 birth_day     is i
 birth_year    is i 
 current_month is i
 current_day   is i
 current_year  is i
 days_til_bd   is i 
 file          is x
 disp_date     is x
 
 select $bui
  case "Y" file = $sysname + "/W/" + $oper + "_bui"
  case "N" file = $sysname + "/W/" + $oper + "_chr" 
 endselect
 rc = $checkfile(file)
 if rc = 1
  if s.bd !dp
   rc = $dbread(03,$operstaffid, s.bd) 
  endif 
  if s.bd dp
   current_month = $month($today)
   current_day   = $day($today)
   current_year  = $year($today)
   birth_month   = $month(s.bd)
   birth_day     = $day(s.bd)
   birth_year    = $year(s.bd)  
   if birth_day = current_day and birth_month = current_month      
    rc = $putfile($castx($today),file)
	BirthdayMsg(,s.fn)
   else
    this_years_bd = $date(`"" + birth_month + "/" + birth_day + "/" + current_year`) 
    days_til_bd = this_years_bd - $today
    if birth_month = current_month and this_years_bd > $today
     select $day(this_years_bd, "DOW") 
      case 1 or 7 if $day($today,"DOW") = 6 and (days_til_bd < 3)
                   rc = $putfile($castx($today),file)
	               BirthdayMsg("It's a little early, but...",s.fn)
				  endif
     endselect	
    endif
   endif
  endif
 elseif rc = 0
  rc = $getfile(disp_date,file)
  if $date(disp_date) != $today
   rc = $filedelete(file)
  endif
 endif 
end StaffBD

function BirthdayMsg(msg,s.fn) is null
 msg          is x
 s.fn         is x
 file         is x
 index        is i
 ascii[]      is x
 ascii_file   is x
 bui_file     is x
 display_line is i
 logfile      is x
 index        = 0
 ascii_file   = "/c0/MIS/birthday.txt"
 bui_file     = "../cmhcbuilocal/images/birthday-cake2.png"
 display_line = 2

 select $sysname
  case "/c2/PV" or "/c4/PVTEST" logfile = "/c0/EXPORT/LOGS/birthday_msg.txt"
  case other logfile = "/c0/EXPORT/LOGS/birthday_msg.txt"
 endselect 

 (void)$openfile(1,logfile,"E")
 (void)$writefile(1,`"" + $today + "|" + $timenow + "|" + $operstaffid + "|" + $bui`)
 (void)$closefile(1,"C")
 select $bui
  case "Y" $submitopt("off", "")
           $cancelopt("off", "Get me out of here")
           $setstyle(".Footer","text-align:center","position:absolute","bottom:12px","font-size:12px","font-weight:normal","text-decoration:none","font-family:Verdana",
                                    "margin-top:10px","margin-left:0px","margin-bottom:2px","padding:0px", "color:#999999","white-space:nowrap","width:100%")
           $form("BIRTHDAY")
		    $tag("<center>")
			 if msg dp
			  $br(2)$text(msg,"error")			 
			 else
			  $br(2)
			 endif
			 $text(`"Happy Birthday " + $nc(s.fn) + "!!"`,"error")
			 $br(4)$image(bui_file)
		    $tag("</center>")
            $text("This annoyance created by Chris Love", "Footer")
           $sendform("BIRTHDAY")
  case "N"  if $getfile(ascii[],ascii_file) = 0
             if msg dp
			  $disp(msg,display_line,19,,"HE")
			  display_line++
			  $disp("Happy Birthday ",display_line,15,,"H")
			 else
			  $disp("Happy Birthday ",display_line,15,,"HE")
			 endif
			 $disp($nc(s.fn),display_line,,,"H")$disp("!!",display_line++,,,"H")
             do while index++ < $maxarray(ascii[])
              $disp(ascii[index],display_line++,5,,"H")			  
			 enddo
			 display_line += 3
			 $disp("Press any key to continue...",display_line,15,,"H")
			 display_line += 2
			 $disp("This annoyance created by Chris Love",display_line++,1)
			 $acpt()
            endif
 endselect		   
end BirthdayMsg

function NSA() is null
 logfile is x
 logfile = "/c0/SQLTRANSFER/t_staff_logins.txt"
 if $uc($dct(9111,$operstaffid,"2")) = "Y" or $uc($dct(9111,$oper,"2")) = "Y" or $uc($dct(9111,$logname,"2")) = "Y"
  $log(`$castx($today) + "|" + $castx($timenow) + "|" + $operstaffid + "|" + $BUI + "|" + $mismenu + "|" + $calledby + "|" + $regid + "|" + $scriptid`, logfile)
 endif
 TrackStaffLogins()
end NSA

function TrackStaffLogins() is null
 logfile is x
 logfile = "/c0/SQLTRANSFER/t_staff_logins.txt"
 if $dct(9111,$operstaffid) dp or $dct(9111,$oper) dp or $dct(9111,$logname) dp
  select $calledby
'Menu changes
   case "MENU_SCR" if $uc($dct(9111,$operstaffid,"2")) = "Y" or $uc($dct(9111,$oper,"2")) = "Y" or $uc($dct(9111,$logname,"2")) = "Y"
                    $log(`$castx($today) + "|" + $castx($timenow) + "|" + $operstaffid + "|" + $BUI + "|" + $mismenu + "|" + $calledby + "|" + $regid + "|" + $scriptid`, logfile)
                   endif
'Logins
   case "MENU_SCR1" if $uc($dct(9111,$operstaffid,"1")) = "Y" or $uc($dct(9111,$oper,"1")) = "Y" or $uc($dct(9111,$logname,"1")) = "Y"
                     $log(`$castx($today) + "|" + $castx($timenow) + "|" + $operstaffid + "|" + $BUI + "|" + $mismenu + "|" + $calledby + "|" + $regid + "|" + $scriptid`, logfile)
                    endif
   case other  $log(`$castx($today) + "|" + $castx($timenow) + "|" + $operstaffid + "|" + $BUI + "|" + $mismenu + "|" + $calledby + "|" + $regid + "|" + $scriptid`, logfile)
  endselect 
 endif 
end TrackStaffLogins 

function IsMounted(mountpoint) is i
 mountpoint is x
 cmd        is x
 cmd = "/usr/sbin/mount | grep " + mountpoint
 IsMounted = $unix(cmd)
end IsMounted

function UnMount(mountpoint) is i
 mountpoint is x
 cmd        is x
 cmd = "/usr/sbin/unmount -f " + mountpoint
 if IsMounted(mountpoint) = 0
  UnMount = $unix(cmd)
 endif
end UnMount

function MountFS(host,share,mountpoint) is i
'0 Success
'1 Error from mount command, unix
'2 variable overflow
'3 stdout-var pathname is invalid or too long
'4 already mounted
'5 Mount point not created
 host       is x
 share      is x
 mountpoint is x
 mount_cmd  is x
 mount_cmd = "/usr/sbin/mount " + host + ":" + share + " " + mountpoint
 if IsMounted(mountpoint) != 0
  if mkdir(mountpoint,"-p") = 0
   MountFS = $unix(mount_cmd)
  else
   MountFS = 5
  endif 
 else
  MountFS = 4
 endif 
end MountFS

function CheckPID(pid) is i
 pid            is x
 process_tree[] is x
 rc             is i
 if pid !dp
  CheckPID = 99
 else
  rc = $unix(`"ps -T" + pid`, process_tree[])
  select rc
   case 0 if $maxarray(process_tree[]) = 1
           CheckPID = 0
          else
           CheckPID = 1
          endif
   case 1 CheckPID = 96
   case 2 CheckPID = 97
   case 3 CheckPID = 98
  endselect 
 endif 
end CheckPID

'THIS FUNCTION IS USED TO GET THE CLIENTS LAST 5 SERVICES AND LOAD INTO ARRAYS
static function GETSVC(client, e_date[], e_staff[], e_ser[], e_att[], e_cl_dur[], e_start[], e_recip[], limit, snapid[]) is null
 client      is x 'Client id
 e.date      is d 'Event date
 e.staff     is x 'Event staff
 e.case.no   is x 'Event case #
 e.ser       is b 'Event service
 e.att       is x 'Event attendance code
 e.cl.dur    is i 'Event client duration
 e.start     is t 'Event start time
 e.recip     is x 'Event recipient code 
 e_date[]    is d 'Event date
 e_staff[]   is x 'Event staff
 e_case_no[] is x 'Event case #
 e_ser[]     is b 'Event service
 e_att[]     is x 'Event attendance code
 e_cl_dur[]  is i 'Event client duration
 e_start[]   is t 'Event start time
 e_recip[]   is x 'Event recipient code
 found       is n 'Array subscript
 rc          is b 'Return code
 limit       is i
 e.isn.key       is x
 $$isn.doc   is h
 $$isn.didid is x 
 snapid[]    is x 
 if limit !dp or limit = 0
  limit = 5
 endif
 $clear(e_date[], e_staff[], e_ser[], e_att[], e_cl_dur[], e_start[], e_recip[],snapid[])
 (void)$startevents(,client, $today)
 rc = $readnextevent(e.date, e.staff, e.ser, e.att, e.cl.dur, e.start, e.recip, e.isn.key)
 found = 1
 do while rc = 0 and found <= limit
  if e.ser > 1 and e.ser != 25
   $clear($$isn.didid)
   if e.isn.key dp
    (void)$dbread(9,e.isn.key,$$isn.doc, $$isn.didid)   
   endif	
   (void)$arrpush(e_date[], e.date)
   (void)$arrpush(e_staff[], e.staff)
   (void)$arrpush(e_ser[], e.ser)
   (void)$arrpush(e_att[], e.att)
   (void)$arrpush(e_cl_dur[], e.cl.dur)
   (void)$arrpush(e_start[], e.start)
   (void)$arrpush(e_recip[], e.recip)   
   if $$isn.didid dp 
    $$isn.didid	= $replace("&","&amp;",$$isn.didid)
	(void)$arrpush(snapid[], $$isn.didid)
   else
    (void)$arrpush(snapid[], "NA")   	
   endif	
   found++
  endif
  rc = $readnextevent(e.date, e.staff, e.ser, e.att, e.cl.dur, e.start, e.recip, e.isn.key) 
 enddo
 if found = 1
  $clear(e_date[], e_staff[], e_ser[], e_att[], e_cl_dur[], e_start[], e_recip[], snapid[])
 endif
 $allowupdate(e_date[], e_staff[], e_ser[], e_att[], e_cl_dur[], e_start[], e_recip[], snapid[])
end GETSVC

function check_medicaid(Client, result, number, output) is x
 %include inc_C_EL
 Client is x
 result is x
 number is x
 output is x
 rc     is b
 switch is b
 $allowupdate(result, number)
 switch = 0
 rc = $dbread(02, Client, c_el_dstlist)
 do while rc < 2 and switch = 0
  if(c.el.fs = 4 or c.el.fs = 5 or c.el.fs = 7 or c.el.fs = 13 or c.el.fs = 30 or c.el.fs = 40 or c.el.fs = 45 or c.el.fs = 210) and  c.el.ef.dt <= $today and (c.el.la.dt > $today or c.el.la.dt !dp)
   result = "Medicaid Recipient"
   number = c.el.id.1
   switch = 1 
  endif
  rc = $dbreadnextdst(02, Client, c_el_dstlist)
 enddo
 if result !dp
  result = "No Medicaid"
  $clear(number)
 endif

 if output != "N"
  $tag("<CENTER>")
   $text(result,"error","color: #00FF00;background-color: #000000")  
  $tag("</CENTER>")
  $tag("<br/>")
 endif
end check_medicaid

function CountOccurance(values_to_find[],possible_values[], results[]) is null
 values_to_find[]  is x
 possible_values[] is x
 results[]         is n
 index             is n
 found             is n
 next              is n
 index = 0
 (void)$sort(possible_values[],"A")
 (void)$sortu(values_to_find[],"A") 
 do while index++ < $maxarray(values_to_find[])
  found = $find(values_to_find[index],possible_values[],1,"F")
  results[index] = 0
  do while found > 0
   results[index]++
   next = found + 1
   found = $find(values_to_find[index],possible_values[],next,"F")  
  enddo 
 enddo
 $allowupdate(values_to_find[],possible_values[],results[])
end CountOccurance

dynamic function UpdateInjections(thedate, injections[]) is i
 thedate        is d
 injections[]   is x
 c.inj.rec      is h       'injection record header
 c.inj.inject   is dbtext  'injection information
 c.inj.date     is d       'injection date
 c.inj.staff    is x       'injection staff
 c.inj.isn      is x       'injection isn reference
 c.inj.recid    is x       'injection record id 
 c_inj_inject[] is x
 rc             is i
 index          is i
 $allowupdate(injections[])
 rc = $dbread(02, $regid, c.inj.rec, c.inj.date, c.inj.inject, c.inj.isn)		 
'If injections are dnp then this process is not allow it, injections should be added through the normal MedCheck/LabOrder process that is in place
 if c.inj.date !dp
'  $brmsg("Injections cannot be updated through this process.", 1, "C", "ERROR")
'  {"ns-libDialog"}MsgBox("New Injections cannot be added through this process. Please use the normal Lab Order function within the Med Clinic Menus to add",4,"Cannot Add Injections","OK")
  UpdateInjections = 9
  return
 endif
 $parsem(c.inj.inject, 1,"|",c_inj_inject[])  
 do while 1 = 1
  $submitopt("off", "SAVE")
  $cancelopt("off", "BACK")
  $form()
   ClientPageHeader($regid)
   $text("{H1}Enter Injections{/H1}") $br()
   $ctag("<div align='center'>")
	$table("t1", , "width='80%' bgcolor='FFFFCC' cellspacing='0' cellpadding='0'")
	 $row()
	  $col()$text("Injection Date:", "datatag") $text(thedate)
	 $row()
	  $col()$ctag("&nbsp")
	$endtable("t1")
	$table("t2",,"width='80%' bgcolor='FFFFCC' border='1' cellspacing='0' cellpadding='0'")
	 $row(,"align='center'")
	  $col()$text("Physician","datatag")
	  $col()$text("Medication Name","datatag")
	  $col()$text("Dosage","datatag")
	  $col()$text("Route","datatag")
	  $col()$text("Administered?","datatag")
	 $row(,"align='center'")
	  $col()$dropboxdct(c_inj_inject[1], 708)
	  $col()$text("Prolixin D")
	  $col()$dropbox(c_inj_inject[2],"","")
			$dropbox(c_inj_inject[2],"25 mg","25 mg")
			$dropbox(c_inj_inject[2],"37.5 mg","37.5 mg")
			$dropbox(c_inj_inject[2],"50 mg","50 mg")
			$dropbox(c_inj_inject[2],"62.5 mg","62.5 mg")
			$dropbox(c_inj_inject[2],"75 mg","75 mg")
			$dropbox(c_inj_inject[2],"100 mg","100 mg")
			$dropbox(c_inj_inject[2],"125 mg","125 mg")
			$dropbox(c_inj_inject[2],"150 mg","150 mg")
	  $col()$text("IM")
	  $col()$radio(c_inj_inject[3], "Yes","Yes")
			$radio(c_inj_inject[3], "No","No")
	 $row(,"align='center'")
	  $col()$dropboxdct(c_inj_inject[4], 708)
	  $col()$text("Haldol D")
	  $col()$dropbox(c_inj_inject[5],"","")
			$dropbox(c_inj_inject[5],"25 mg","25 mg")
			$dropbox(c_inj_inject[5],"50 mg","50 mg")
			$dropbox(c_inj_inject[5],"75 mg","75 mg")
			$dropbox(c_inj_inject[5],"100 mg","100 mg")
			$dropbox(c_inj_inject[5],"150 mg","150 mg")
			$dropbox(c_inj_inject[5],"200 mg","200 mg")
	  $col()$text("IM")
	  $col()$radio(c_inj_inject[6], "Yes","Yes")
			$radio(c_inj_inject[6], "No","No")
	 $row(,"align='center'")
	  $col()$dropboxdct(c_inj_inject[7], 708)
	  $col()$text("Risperdal Consta")
	  $col()$dropbox(c_inj_inject[8],"","")
			$dropbox(c_inj_inject[8],"25 mg","25 mg")
			$dropbox(c_inj_inject[8],"37.5 mg","37.5 mg")
			$dropbox(c_inj_inject[8],"50 mg","50 mg")
	  $col()$text("IM")
	  $col()$radio(c_inj_inject[9], "Yes","Yes")
			$radio(c_inj_inject[9], "No","No")
'9/28/2010 R. Whaite - Invega Sustenna added per Elsie Mathews and Renee Beasley.
	 $row(,"align='center'")
	  $col()$dropboxdct(c_inj_inject[10], 708)
	  $col()$text("Invega Sustenna")
	  $col()$dropbox(c_inj_inject[11],"","")
			$dropbox(c_inj_inject[11],"39 mg","39 mg")
			$dropbox(c_inj_inject[11],"78 mg","78 mg")
			$dropbox(c_inj_inject[11],"117 mg","117 mg")
			$dropbox(c_inj_inject[11],"156 mg","156 mg")
			$dropbox(c_inj_inject[11],"234 mg","234 mg")
	  $col()$text("IM")
	  $col()$radio(c_inj_inject[12], "Yes","Yes")
			$radio(c_inj_inject[12], "No","No")
'added 4/21/2014
	 $row(,"align='center'")
	  $col()$dropboxdct(c_inj_inject[13], 708)
	  $col()$text("Abilify Maintena")
	  $col()$dropbox(c_inj_inject[14],"","")
			$dropbox(c_inj_inject[14],"160 mg","160 mg")
			$dropbox(c_inj_inject[14],"200 mg","200 mg")
			$dropbox(c_inj_inject[14],"300 mg","300 mg")
			$dropbox(c_inj_inject[14],"400 mg","400 mg")
	  $col()$text("IM")
	  $col()$radio(c_inj_inject[15], "Yes","Yes")
			$radio(c_inj_inject[15], "No","No")
	$endtable("t2")
   $ctag("</div>")
  $sendform()
  if $endbutton = "CANCEL"
   UpdateInjections = 10
   return
  elseif $endbutton = "SUBMIT"
   $dblock()
   rc = $dbread(02,$regid, c.inj.rec, c.inj.inject, c.inj.date, c.inj.staff, c.inj.recid)
   c.inj.date = thedate
   c.inj.staff = $operstaffid
   $clear(c.inj.inject)
   if $maxarray(c_inj_inject[]) > 0
    index = 0
    do while index++ < $maxarray(c_inj_inject[])			 
	 c.inj.inject = c.inj.inject + c_inj_inject[index] + "|"
	enddo
   endif
   (void)$arrcopy(c_inj_inject[],injections[])
   if $operstaffid != "3737"
    rc = $dbupdate(02,$regid, c.inj.rec, c.inj.inject, c.inj.date, c.inj.staff, c.inj.recid)  
   else
    $dbunlock()
	rc = 0
   endif		
   if rc > 0
    $brmsg("There Was A Problem Saving The Data! Contact MIS Now.", 1, "W", "ERROR")
	UpdateInjections = rc
   else
	UpdateInjections = rc
    return
   endif		
  endif
 enddo
end UpdateInjections

function PrintInjections(injections[]) is null
 injections[] is x
 {"lib_COMMON2"}PrintInjections(injections[])
end PrintInjections

function FinRvLetter(clientid) is x
 clientid is x
 {"lib_COMMON2"}FinRvLetter(clientid)
end FinRvLetter

function ConfirmDur(dur) is x
 dur is t
 ConfirmDur = {"lib_COMMON2"}ConfirmDur(dur)
end ConfirmDur

function CurrentDX(client,compare_date) is x
 client       is x
 compare_date is d
 CurrentDX = {"lib_COMMON2"}CurrentDX(client,compare_date)
end CurrentDX

function AddUMMonitor(CID,scriptid) is null
 CID      is x
 scriptid is x
 {"lib_UACOMMON"}AddUMMonitor(CID,scriptid)
end AddUMMonitor

function RemUMMonitor(CID,scriptid) is null
 CID      is x
 scriptid is x
 {"lib_UACOMMON"}RemUMMonitor(CID,scriptid)
end RemUMMonitor

function AddBATCH(CID[],scriptid) is null
 CID      is x
 scriptid is x
 {"lib_UACOMMON"}AddBATCH(CID[],scriptid)
end AddBATCH

function RemoveDBReg(db,remove[]) is i
 db is b
 remove[] is x
 RemoveDBReg = {"lib_COMMON2"}RemoveDBReg(db,remove[])
end RemoveDBReg

function BusyImage(message[],title) is null
 message[] is x
 title     is x
 index     is i

 (void)$arrinsert(message[],"<img src=../cmhcbuilocal/our_images/ajax-loading.gif>") 
 if $maxarray(message[]) > 4
  $brmsginit($maxarray(message[]),80)
 endif 
 index = 0
 do while index++ < $maxarray(message[])
  $brmsg(message[index], index, "C", title)
 enddo
end BusyImage

function GetStaffByPos(position_code) is x
 position_code is x
 GetStaffByPos = {"lib_COMMON2"}GetStaffByPos(position_code)
end GetStaffByPos

function GetEmailByPos(position_code) is x
 position_code is x
 GetEmailByPos = {"lib_COMMON2"}GetEmailByPos(position_code)
end GetEmailByPos

function GetFinRevDt(client,finrvdt_lapse,days_to_finrvdt) is d
 client          is x
 finrvdt_lapse   is d
 days_to_finrvdt is i
 $allowupdate(finrvdt_lapse,days_to_finrvdt) 
 finrvdt_lapse = {"lib_COMMON2"}GetFinRevD(client,finrvdt_lapse,days_to_finrvdt)
end GetFinRevDT


function GetCenterMgr(CIDCounty) is x
 CIDCounty is x
 if CIDCounty dp
  GetCenterMgr = {"lib_COMMON2"}GetCenterMgr(CIDCounty)
 endif 
end GetCenterMgr

function CFC_Active(cid,date) is x
 cid  is x
 date is d
 if cid dp
  CFC_Active = {"lib_COMMON2"}CFC_Active(cid,date)
 endif
end CFC_Active

function Alt0160(number) is x
 number is i
 value  is x
 index  is i
'Alt+0160 
 value = " "
 if number !dp
  Alt0160 = value
 else
  index = 1
  Alt0160 = value
  do while index++ <= number
   value += value
  enddo  
 endif 
end Alt0160
